<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‘½è¿é»‘ç›’ Pro Max Â· å…¨å±€èƒ½é‡å®æˆ˜ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.12/lunar.min.js"></script>
    <style>
        :root {
            --primary: #ff4757;      
            --success: #2ed573;     
            --dark: #2f3542;         
            --gray: #747d8c;         
            --bg: #f1f2f6;          
            --purple: #5352ed;
            --gold: #ffa502;
            --card-bg: #ffffff;
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
            --radius: 16px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", sans-serif; 
            background: var(--bg); color: var(--dark);
            margin: 0; padding: 20px 10px;
            min-height: 100vh;
            background-image: radial-gradient(#dfe4ea 15%, transparent 16%); 
            background-size: 30px 30px;
            display: flex; justify-content: center;
        }

        .container {
            width: 100%; max-width: 680px;
            padding-bottom: 60px;
        }

        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { 
            font-size: 28px; font-weight: 900; margin: 0; letter-spacing: 2px;
            background: linear-gradient(135deg, var(--dark), var(--primary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .energy-bar {
            height: 4px; width: 60px; margin: 10px auto 0; border-radius: 2px;
            background: linear-gradient(90deg, var(--purple), var(--primary), var(--gold));
        }
        .subtitle { font-size: 12px; color: var(--gray); margin-top: 8px; opacity: 0.8; }

        .card {
            background: var(--card-bg); border-radius: var(--radius);
            padding: 20px; margin-bottom: 20px;
            box-shadow: var(--shadow); border: 1px solid rgba(255,255,255,0.8);
            position: relative; overflow: hidden;
        }

        .input-group { margin-bottom: 15px; }
        .label { display: block; font-weight: bold; font-size: 14px; margin-bottom: 8px; color: var(--gray); }
        
        .gender-switch { display: flex; gap: 10px; margin-bottom: 15px; }
        .g-btn {
            flex: 1; padding: 12px; text-align: center; border-radius: 10px; font-weight: bold; font-size: 14px;
            background: #f1f2f6; color: #a4b0be; cursor: pointer; transition: all 0.3s;
            border: 2px solid transparent;
        }
        .g-btn.active {
            background: rgba(255, 71, 87, 0.05); color: var(--primary); border-color: var(--primary);
        }

        input[type="datetime-local"] {
            width: 100%; padding: 14px; border: 2px solid #e1e4e8; border-radius: 10px;
            font-size: 16px; outline: none; background: #f8f9fa; transition: 0.3s;
            -webkit-appearance: none;
        }
        input:focus { border-color: var(--primary); background: #fff; }

        .btn-calc {
            width: 100%; padding: 16px; border: none; border-radius: 50px;
            background: var(--dark); color: #fff; font-size: 18px; font-weight: bold;
            cursor: pointer; box-shadow: 0 8px 20px rgba(47, 53, 66, 0.25);
            transition: transform 0.2s;
        }
        .btn-calc:active { transform: scale(0.98); }

        #result-area { display: none; animation: slideUp 0.5s ease; }
        @keyframes slideUp { from { opacity:0; transform:translateY(30px); } to { opacity:1; transform:translateY(0); } }

        .art-box {
            height: 200px; border-radius: var(--radius); overflow: hidden; margin-bottom: 20px;
            position: relative; box-shadow: var(--shadow); border: 1px solid #fff;
        }
        canvas { width: 100%; height: 100%; display: block; }
        .art-tag {
            position: absolute; bottom: 10px; right: 10px; background: rgba(255,255,255,0.9);
            padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); color: var(--dark);
        }

        .section-title { font-size: 16px; font-weight: 800; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .section-title::before { content:''; width:4px; height:16px; background:var(--primary); border-radius:2px; }

        .pillars-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .pillar {
            background: #fdfdfd; border: 1px solid #eee; border-radius: 10px;
            padding: 12px 2px; text-align: center; display: flex; flex-direction: column; align-items: center;
        }
        .p-head { font-size: 11px; color: #b2bec3; margin-bottom: 5px; }
        .god-tag { font-size: 10px; color: #636e72; height: 14px; margin-bottom: 2px; }
        .char { font-family: "KaiTi", "æ¥·ä½“", serif; font-size: 24px; font-weight: bold; line-height: 1.1; }
        .hidden-gan { font-size: 10px; color: #95a5a6; margin-top: 4px; transform: scale(0.9); white-space: nowrap; }
        
        .cs-tag {
            font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-top: 6px;
            background: #f1f2f6; color: #a4b0be; transform: scale(0.9); white-space: nowrap;
        }
        .cs-strong { background: #fff3e0; color: #d35400; font-weight: bold; }

        .wx-é‡‘ { color: #E6B33D; } .wx-æœ¨ { color: #27AE60; } .wx-æ°´ { color: #2980B9; } .wx-ç« { color: #C0392B; } .wx-åœŸ { color: #8D6E63; }

        .deep-analysis {
            background: #fffbf0; border: 1px solid #fae3c4; padding: 15px; border-radius: 12px;
            font-size: 13px; line-height: 1.6; margin-bottom: 20px; color: #574b35;
        }
        .highlight { color: #d35400; font-weight: bold; }
        
        /* äº”è¡Œå–œå¿Œæ ‡ç­¾ */
        .joy-taboo-box {
            display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #eee;
        }
        .jt-tag { font-size: 12px; padding: 3px 8px; border-radius: 4px; font-weight: bold; }
        .jt-joy { background: #e8f5e9; color: #27ae60; border: 1px solid #c8e6c9; }
        .jt-taboo { background: #ffebee; color: #c0392b; border: 1px solid #ffcdd2; }

        /* äº”ç»´å¡ç‰‡ */
        .dim-row { display: flex; margin-bottom: 20px; align-items: flex-start; }
        .dim-icon { 
            width: 36px; height: 36px; background: #f1f2f6; border-radius: 50%; 
            text-align: center; line-height: 36px; font-size: 18px; margin-right: 12px; flex-shrink: 0;
        }
        .dim-content { flex: 1; }
        .dim-title { font-weight: bold; font-size: 15px; margin-bottom: 6px; color: var(--dark); }
        .dim-text { font-size: 13px; color: #636e72; line-height: 1.6; text-align: justify; }

        #error-msg { display:none; background:#ff7675; color:#fff; padding:10px; border-radius:8px; text-align:center; margin-bottom:15px; font-size:12px; }
        
        .logic-tag {
            display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 5px;
            background: #eee; color: #666; font-weight: normal;
        }
        
        .core-qishu {
            background: #fdfdfd; padding: 10px; border-radius: 8px; border-left: 3px solid var(--gold);
            font-size: 13px; margin-bottom: 10px; color: #555;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>å‘½è¿é»‘ç›’ Pro Max</h1>
        <div class="energy-bar"></div>
        <p class="subtitle">å…¨å±€èƒ½é‡åŠ æƒ Â· å››æŸ±é€šæ ¹ Â· å®æˆ˜å–œå¿Œ</p>
    </div>

    <div id="error-msg">âš ï¸ æ ¸å¿ƒç»„ä»¶åŠ è½½å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ (jsDelivr)</div>

    <div class="card">
        <div class="input-group">
            <span class="label">æ€§åˆ« (Gender)</span>
            <div class="gender-switch">
                <div class="g-btn active" onclick="setGender(1, this)">ä¹¾é€  (ç”·)</div>
                <div class="g-btn" onclick="setGender(0, this)">å¤é€  (å¥³)</div>
            </div>
        </div>
        <div class="input-group">
            <span class="label">å‡ºç”Ÿæ—¶é—´ (å…¬å†)</span>
            <input type="datetime-local" id="birth-input">
        </div>
        <button class="btn-calc" onclick="calculateDestiny()">å¼€å§‹æ¨æ¼”</button>
    </div>

    <div id="result-area">
        <div class="art-box">
            <canvas id="fate-canvas"></canvas>
            <div class="art-tag" id="art-tag">å‘½å±€å›¾æ™¯</div>
        </div>

        <div class="card">
            <div class="section-title">å…«å­—æ’ç›˜ Â· å…¨å±€æ°”æ•°</div>
            <div class="pillars-grid" id="pillars-box"></div>
        </div>

        <div class="card">
            <div class="section-title">çœŸç¥ä¸å¼ºå¼±è¾©è¯</div>
            <div id="commander-box" class="deep-analysis"></div>
            
            <div class="core-qishu" id="core-qishu-box">
                </div>

            <div style="margin-top:15px;">
                <div style="display:flex; align-items:center;">
                    <div style="font-size:18px; font-weight:900; color:var(--dark);" id="pattern-name">...</div>
                    <div id="pattern-explain" class="logic-tag"></div>
                </div>
                <div style="font-size:12px; color:var(--gray); font-style:italic; margin-top:5px;" id="pattern-slogan">...</div>
            </div>
        </div>

        <div class="card">
            <div class="section-title">äº”ç»´å¤©å‘½å®æˆ˜æŒ‡å—</div>
            <div id="five-dim-box"></div>
        </div>

        <div style="text-align:center; color:#ccc; font-size:12px; margin-top:20px;">
            Destiny Algorithm Â© 2025 (Global Energy Ver.)
        </div>
    </div>
</div>

<script>
    let currentGender = 1;

    // ==========================================================
    // é™æ€æ•°æ®å­—å…¸ (Core Data)
    // ==========================================================
    
    const WX_COLOR = { 'é‡‘':'wx-é‡‘', 'æœ¨':'wx-æœ¨', 'æ°´':'wx-æ°´', 'ç«':'wx-ç«', 'åœŸ':'wx-åœŸ' };
    const WUXING_MAP = {
        'ç”²':'æœ¨','ä¹™':'æœ¨','ä¸™':'ç«','ä¸':'ç«','æˆŠ':'åœŸ','å·±':'åœŸ','åºš':'é‡‘','è¾›':'é‡‘','å£¬':'æ°´','ç™¸':'æ°´',
        'å­':'æ°´','ä¸‘':'åœŸ','å¯…':'æœ¨','å¯':'æœ¨','è¾°':'åœŸ','å·³':'ç«','åˆ':'ç«','æœª':'åœŸ','ç”³':'é‡‘','é…‰':'é‡‘','æˆŒ':'åœŸ','äº¥':'æ°´'
    };

    const HIDDEN_GAN_MAP = {
        'å­':['ç™¸'], 'ä¸‘':['å·±','ç™¸','è¾›'], 'å¯…':['ç”²','ä¸™','æˆŠ'], 'å¯':['ä¹™'], 
        'è¾°':['æˆŠ','ä¹™','ç™¸'], 'å·³':['ä¸™','æˆŠ','åºš'], 'åˆ':['ä¸','å·±'], 'æœª':['å·±','ä¸','ä¹™'], 
        'ç”³':['åºš','å£¬','æˆŠ'], 'é…‰':['è¾›'], 'æˆŒ':['æˆŠ','è¾›','ä¸'], 'äº¥':['å£¬','ç”²']
    };

    const CS_MEANING = {
        "é•¿ç”Ÿ": "ç¨³å›º", "æ²æµ´": "æ¡ƒèŠ±", "å† å¸¦": "è¿›å–", "ä¸´å®˜": "ç¦„ä½/å¼º", 
        "å¸æ—º": "å·…å³°/å¼º", "è¡°": "ç¨³é‡", "ç—…": "æ•æ„Ÿ", "æ­»": "å®é™", 
        "å¢“": "åº“è—", "ç»": "å—åˆ¶", "èƒ": "é…é…¿", "å…»": "åŸ¹è‚²"
    };

    const CHANGSHENG_TABLE = {
        "ç”²": { "äº¥":"é•¿ç”Ÿ", "å­":"æ²æµ´", "ä¸‘":"å† å¸¦", "å¯…":"ä¸´å®˜", "å¯":"å¸æ—º", "è¾°":"è¡°", "å·³":"ç—…", "åˆ":"æ­»", "æœª":"å¢“", "ç”³":"ç»", "é…‰":"èƒ", "æˆŒ":"å…»" },
        "ä¹™": { "åˆ":"é•¿ç”Ÿ", "å·³":"æ²æµ´", "è¾°":"å† å¸¦", "å¯":"ä¸´å®˜", "å¯…":"å¸æ—º", "ä¸‘":"è¡°", "å­":"ç—…", "äº¥":"æ­»", "æˆŒ":"å¢“", "é…‰":"ç»", "ç”³":"èƒ", "æœª":"å…»" },
        "ä¸™": { "å¯…":"é•¿ç”Ÿ", "å¯":"æ²æµ´", "è¾°":"å† å¸¦", "å·³":"ä¸´å®˜", "åˆ":"å¸æ—º", "æœª":"è¡°", "ç”³":"ç—…", "é…‰":"æ­»", "æˆŒ":"å¢“", "äº¥":"ç»", "å­":"èƒ", "ä¸‘":"å…»" },
        "ä¸": { "é…‰":"é•¿ç”Ÿ", "ç”³":"æ²æµ´", "æœª":"å† å¸¦", "åˆ":"ä¸´å®˜", "å·³":"å¸æ—º", "è¾°":"è¡°", "å¯":"ç—…", "å¯…":"æ­»", "ä¸‘":"å¢“", "å­":"ç»", "äº¥":"èƒ", "æˆŒ":"å…»" },
        "æˆŠ": { "å¯…":"é•¿ç”Ÿ", "å¯":"æ²æµ´", "è¾°":"å† å¸¦", "å·³":"ä¸´å®˜", "åˆ":"å¸æ—º", "æœª":"è¡°", "ç”³":"ç—…", "é…‰":"æ­»", "æˆŒ":"å¢“", "äº¥":"ç»", "å­":"èƒ", "ä¸‘":"å…»" },
        "å·±": { "é…‰":"é•¿ç”Ÿ", "ç”³":"æ²æµ´", "æœª":"å† å¸¦", "åˆ":"ä¸´å®˜", "å·³":"å¸æ—º", "è¾°":"è¡°", "å¯":"ç—…", "å¯…":"æ­»", "ä¸‘":"å¢“", "å­":"ç»", "äº¥":"èƒ", "æˆŒ":"å…»" },
        "åºš": { "å·³":"é•¿ç”Ÿ", "åˆ":"æ²æµ´", "æœª":"å† å¸¦", "ç”³":"ä¸´å®˜", "é…‰":"å¸æ—º", "æˆŒ":"è¡°", "äº¥":"ç—…", "å­":"æ­»", "ä¸‘":"å¢“", "å¯…":"ç»", "å¯":"èƒ", "è¾°":"å…»" },
        "è¾›": { "å­":"é•¿ç”Ÿ", "äº¥":"æ²æµ´", "æˆŒ":"å† å¸¦", "é…‰":"ä¸´å®˜", "ç”³":"å¸æ—º", "æœª":"è¡°", "åˆ":"ç—…", "å·³":"æ­»", "è¾°":"å¢“", "å¯":"ç»", "å¯…":"èƒ", "ä¸‘":"å…»" },
        "å£¬": { "ç”³":"é•¿ç”Ÿ", "é…‰":"æ²æµ´", "æˆŒ":"å† å¸¦", "äº¥":"ä¸´å®˜", "å­":"å¸æ—º", "ä¸‘":"è¡°", "å¯…":"ç—…", "å¯":"æ­»", "è¾°":"å¢“", "å·³":"ç»", "åˆ":"èƒ", "æœª":"å…»" },
        "ç™¸": { "å¯":"é•¿ç”Ÿ", "å¯…":"æ²æµ´", "ä¸‘":"å† å¸¦", "å­":"ä¸´å®˜", "äº¥":"å¸æ—º", "æˆŒ":"è¡°", "é…‰":"ç—…", "ç”³":"æ­»", "æœª":"å¢“", "åˆ":"ç»", "å·³":"èƒ", "è¾°":"å…»" }
    };
    const STRONG_CS = ["é•¿ç”Ÿ", "å¸æ—º", "ä¸´å®˜", "å† å¸¦"]; 

    const SHISHEN_MAP = {
        "ç”²": { "ç”²":"æ¯”è‚©", "ä¹™":"åŠ«è´¢", "ä¸™":"é£Ÿç¥", "ä¸":"ä¼¤å®˜", "æˆŠ":"åè´¢", "å·±":"æ­£è´¢", "åºš":"ä¸ƒæ€", "è¾›":"æ­£å®˜", "å£¬":"åå°", "ç™¸":"æ­£å°" },
        "ä¹™": { "ä¹™":"æ¯”è‚©", "ç”²":"åŠ«è´¢", "ä¸":"é£Ÿç¥", "ä¸™":"ä¼¤å®˜", "å·±":"åè´¢", "æˆŠ":"æ­£è´¢", "è¾›":"ä¸ƒæ€", "åºš":"æ­£å®˜", "ç™¸":"åå°", "å£¬":"æ­£å°" },
        "ä¸™": { "ä¸™":"æ¯”è‚©", "ä¸":"åŠ«è´¢", "æˆŠ":"é£Ÿç¥", "å·±":"ä¼¤å®˜", "åºš":"åè´¢", "è¾›":"æ­£è´¢", "å£¬":"ä¸ƒæ€", "ç™¸":"æ­£å®˜", "ç”²":"åå°", "ä¹™":"æ­£å°" },
        "ä¸": { "ä¸":"æ¯”è‚©", "ä¸™":"åŠ«è´¢", "å·±":"é£Ÿç¥", "æˆŠ":"ä¼¤å®˜", "è¾›":"åè´¢", "åºš":"æ­£è´¢", "ç™¸":"ä¸ƒæ€", "å£¬":"æ­£å®˜", "ä¹™":"åå°", "ç”²":"æ­£å°" },
        "æˆŠ": { "æˆŠ":"æ¯”è‚©", "å·±":"åŠ«è´¢", "åºš":"é£Ÿç¥", "è¾›":"ä¼¤å®˜", "å£¬":"åè´¢", "ç™¸":"æ­£è´¢", "ç”²":"ä¸ƒæ€", "ä¹™":"æ­£å®˜", "ä¸™":"åå°", "ä¸":"æ­£å°" },
        "å·±": { "å·±":"æ¯”è‚©", "æˆŠ":"åŠ«è´¢", "è¾›":"é£Ÿç¥", "åºš":"ä¼¤å®˜", "ç™¸":"åè´¢", "å£¬":"æ­£è´¢", "ä¹™":"ä¸ƒæ€", "ç”²":"æ­£å®˜", "ä¸":"åå°", "ä¸™":"æ­£å°" },
        "åºš": { "åºš":"æ¯”è‚©", "è¾›":"åŠ«è´¢", "å£¬":"é£Ÿç¥", "ç™¸":"ä¼¤å®˜", "ç”²":"åè´¢", "ä¹™":"æ­£è´¢", "ä¸™":"ä¸ƒæ€", "ä¸":"æ­£å®˜", "æˆŠ":"åå°", "å·±":"æ­£å°" },
        "è¾›": { "è¾›":"æ¯”è‚©", "åºš":"åŠ«è´¢", "ç™¸":"é£Ÿç¥", "å£¬":"ä¼¤å®˜", "ä¹™":"åè´¢", "ç”²":"æ­£è´¢", "ä¸":"ä¸ƒæ€", "ä¸™":"æ­£å®˜", "å·±":"åå°", "æˆŠ":"æ­£å°" },
        "å£¬": { "å£¬":"æ¯”è‚©", "ç™¸":"åŠ«è´¢", "ç”²":"é£Ÿç¥", "ä¹™":"ä¼¤å®˜", "ä¸™":"åè´¢", "ä¸":"æ­£è´¢", "æˆŠ":"ä¸ƒæ€", "å·±":"æ­£å®˜", "åºš":"åå°", "è¾›":"æ­£å°" },
        "ç™¸": { "ç™¸":"æ¯”è‚©", "å£¬":"åŠ«è´¢", "ä¹™":"é£Ÿç¥", "ç”²":"ä¼¤å®˜", "ä¸":"åè´¢", "ä¸™":"æ­£è´¢", "å·±":"ä¸ƒæ€", "æˆŠ":"æ­£å®˜", "è¾›":"åå°", "åºš":"æ­£å°" }
    };

    const SILING_RULES = {
        'å¯…': [['æˆŠ',7], ['ä¸™',7], ['ç”²',16]], 'å¯': [['ç”²',10], ['ä¹™',20]], 'è¾°': [['ä¹™',9], ['ç™¸',3], ['æˆŠ',18]],
        'å·³': [['æˆŠ',5], ['åºš',9], ['ä¸™',16]], 'åˆ': [['ä¸™',10], ['å·±',9], ['ä¸',11]], 'æœª': [['ä¸',9], ['ä¹™',3], ['å·±',18]],
        'ç”³': [['æˆŠ',7], ['å£¬',7], ['åºš',16]], 'é…‰': [['åºš',10], ['è¾›',20]], 'æˆŒ': [['è¾›',9], ['ä¸',3], ['æˆŠ',18]],
        'äº¥': [['æˆŠ',7], ['ç”²',5], ['å£¬',18]], 'å­': [['å£¬',10], ['ç™¸',20]], 'ä¸‘': [['ç™¸',9], ['è¾›',3], ['å·±',18]]
    };

    const WITTY_DB = {
        "ä¼¤å®˜åˆæ€": { 
            name: "ğŸ˜ å±æœºç»ˆç»“è€… (ä¼¤å®˜åˆæ€)", 
            slogan: "å¤–è¡¨éšå’Œï¼Œå†…å¿ƒåˆšæ¯…ã€‚ä¸“æ²»å„ç§ä¸æœï¼Œä¹±ä¸–ä¸­çš„ä¸€æŠŠåˆ©åˆƒã€‚", 
            male: { c:"å¤©ç”Ÿåéª¨ï¼Œä¸é€‚åˆå‘†æ¿ä½“åˆ¶ã€‚æœ€æ“…é•¿åœ¨æ··ä¹±ä¸­å»ºç«‹ç§©åºï¼Œæˆ–è§£å†³æ£˜æ‰‹éš¾é¢˜ï¼ˆå¦‚å¾‹å¸ˆã€ç‰¹ç§é¡¾é—®ï¼‰ã€‚", w:"é™©ä¸­æ±‚è´¢ï¼Œé ä¿¡æ¯å·®å’Œèƒ†è¯†æ å¤ºã€‚ä¸ä»…è¦ä¼šèµšï¼Œæ›´è¦ä¼šåšèµ„äº§è§„åˆ’ï¼Œå¦åˆ™è´¢æ¥è´¢å»ã€‚", l:"æ¬£èµèªæ˜ã€å¸¦ç‚¹åˆºçš„å¥³äººã€‚éª¨å­é‡Œäº’ç›¸å´‡æ‹œï¼Œç²˜æ€§æé«˜ï¼Œä½†æ§åˆ¶æ¬²è¾ƒå¼ºã€‚", k:"å­©å­èªæ˜å›é€†ï¼Œé—ä¼ é«˜æ™ºå•†ã€‚ä¸è¦ç”¨ä¼ ç»Ÿå­é“å‹åˆ¶ï¼Œå¼•å¯¼æç§‘ç ”æˆ–è‰ºæœ¯ã€‚", h:"å¤§è„‘é«˜é€Ÿè¿è½¬ï¼Œæ˜“ç¥ç»è¡°å¼±ã€‚æ³¨æ„è¿åŠ¨ä¼¤å®³ã€‚" }, 
            female: { c:"èŒåœºå¤§å§å¤§ï¼Œæ‰‹æ®µé«˜æ˜ã€‚é€‚åˆå…¬å…³ã€å±æœºå¤„ç†ã€‚æ°”åœºå¼ºå¤§ï¼Œèƒ½è®©ç”·äººä»¬æ•¬ç•ä¸‰åˆ†ã€‚", w:"å¸é‡‘èƒ½åŠ›å¼ºï¼Œåæ°”å°±æ˜¯èµ„äº§ã€‚é€‚åˆç»è¥ä¸ªäººå“ç‰Œã€‚åƒ'å®ˆè´¢å¥´'ä¸€æ ·ç§¯ç´¯å®¶åº•æ˜¯æœ€ä½³ç­–ç•¥ã€‚", l:"çœ¼å…‰æé«˜ï¼Œæ¬£èµéœ¸æ°”ç¡¬æ±‰ï¼ˆçˆ¹ç³»ä¸ˆå¤«ï¼‰ã€‚æ„Ÿæƒ…æ˜¯æ¬¢å–œå†¤å®¶ï¼ŒåºŠå¤´åµæ¶åºŠå°¾å’Œã€‚", k:"æŠ•å…¥æå¤§ç²¾åŠ›ï¼Œå­©å­æœ‰ç‰¹æ®Šæ‰åã€‚è®°å¾—å¯¹è‡ªå·±å¥½ä¸€ç‚¹ã€‚", h:"æ³¨æ„ç”Ÿæ®–ç³»ç»ŸåŠå†…åˆ†æ³Œã€‚é€‚åº¦åŒ»ç¾ï¼Œä¿æŒèº«å¿ƒå¹³è¡¡ã€‚" } 
        },
        "é£Ÿç¥åˆ¶æ€": { 
            name: "ğŸ¦ é“è…•é©¯å…½å¸ˆ (é£Ÿç¥åˆ¶æ€)", 
            slogan: "å†…æ–¹å¤–åœ†ï¼Œä»¥ç†æœäººã€‚æ‰‹é‡Œæœ‰è‰ºï¼Œå¿ƒä¸­æœ‰å¨ã€‚", 
            male: { c:"ä¸“å®¶å‹é¢†å¯¼ï¼Œé ä¸“ä¸šèƒ½åŠ›æœä¼—ã€‚é€‚åˆå…¬æ£€æ³•ã€åŒ»ç–—æˆ–æŠ€æœ¯æ€»ç›‘ã€‚", w:"é æ‰‹è‰ºå’Œå¨æœ›èµšé’±ï¼Œèµ„å†è¶Šè€è¶Šå€¼é’±ã€‚æ”¶å…¥ç¨³å›ºï¼Œæ˜¯å®¶åº­çš„å®šæµ·ç¥é’ˆã€‚", l:"å®¶åº­åœ°ä½é«˜ï¼Œä¸€è¨€ä¹é¼ã€‚å¦»å­æ•¬é‡ä½ ï¼Œä½†ä¹Ÿéœ€è¦ä½ å¤šç‚¹æ¸©æƒ…ã€‚", k:"å­©å­è§„çŸ©æ‡‚äº‹ï¼Œæœªæ¥æ ‹æ¢ä¹‹æã€‚", h:"èº«ä½“åº•å­å¥½ï¼Œä½†é˜²å¯Œè´µç—…ã€‚æ³¨æ„é¥®é£ŸèŠ‚åˆ¶ã€‚" }, 
            female: { c:"æŠ€æœ¯æµå¥³å¼ºäººï¼Œä¸å±‘å®«æ–—ï¼Œé å®åŠ›è¯´è¯ã€‚è´¢åŠ¡ã€å®¡è®¡ã€å­¦æœ¯å¸¦å¤´äººã€‚", w:"ç†è´¢æœ‰é“ï¼Œä¸ä»…èƒ½èµšè¿˜èƒ½å­˜ã€‚æ˜¯å®¶åº­çš„CFOï¼Œä»ä¸ä¹±èŠ±å†¤æ‰é’±ã€‚", l:"ç®¡è€å…¬åƒç®¡å­©å­ï¼Œè™½ç„¶å•°å—¦ä½†ä¸ºå®¶å¥½ã€‚ä¸ˆå¤«é€šå¸¸æ¸©å’Œå¬è¯ã€‚", k:"å­å¥³ç¼˜å¥½ï¼Œè´´å¿ƒå°æ£‰è¢„ã€‚æ¯æ…ˆå­å­ã€‚", h:"æ¶ˆåŒ–ç³»ç»Ÿæ•æ„Ÿï¼Œèƒƒç—›å¾€å¾€æ˜¯æƒ…ç»ªçš„æ˜ å°„ã€‚" } 
        },
        "ä¼¤å®˜ç”Ÿè´¢": { 
            name: "ğŸ’¸ æé’±æœºå™¨ (ä¼¤å®˜ç”Ÿè´¢)", 
            slogan: "æŠ€æœ¯ç«‹èº«ï¼Œæ‹’ç»å€Ÿè´·ã€‚è„‘å­å°±æ˜¯å°é’æœºã€‚", 
            male: { c:"ç§‘æŠ€åˆ›ä¸šã€åˆ›æ„è¥é”€ã€‚ç‚¹å­å¤šè·¯å­é‡ï¼Œåˆ«æ‰“æ­»å·¥ã€‚", w:"åˆ›æ„æŠ€æœ¯å˜ç°ã€‚é’±æ˜¯æ»šå‡ºæ¥çš„ã€‚é€‚åˆåšèµ„äº§ç½®æ¢ï¼ŒæŠŠè™šé’±å˜å®äº§ã€‚", l:"å–œæ¬¢æ¼‚äº®æ—¶å°šçš„å¥³äººï¼Œå¸¦å‡ºå»æœ‰é¢å­ã€‚è„¾æ°”å·®ï¼Œéœ€åŒ…å®¹ã€‚", k:"å­å¥³ç¼˜æµ…æˆ–æ—©æ—©å‡ºå›½ã€‚ç‰©è´¨æ”¯æŒåˆ°ä½ï¼Œæƒ…æ„Ÿæ²Ÿé€šéœ€åŠ å¼ºã€‚", h:"æ€è™‘è¿‡é‡ï¼Œå¤±çœ è„±å‘ã€‚ç¡å‰ç»™å¤§è„‘å…³æœºã€‚" }, 
            female: { c:"æ‰å¥³ï¼Œè‡ªåª’ä½“ã€ç›´æ’­å¸¦è´§ã€‚å¼€å£å³é‡‘ã€‚åšæŒèµ°æŠ€æœ¯ã€ä¸“æ‰è·¯çº¿ã€‚", w:"èµšé’±å¿«èŠ±é’±å¿«ã€‚å¿…é¡»ä¹°æˆ¿å¼ºåˆ¶å‚¨è“„ï¼Œåšä¸€ä¸ªå¿«ä¹çš„'å®ˆè´¢å¥´'ã€‚", l:"çœ¼å…‰æ¯’è¾£ï¼Œå«Œå¼ƒè€å…¬ç©·ç¬¨ã€‚å»ºè®®æ‰¾æˆç†Ÿç¨³é‡çš„'çˆ¹ç³»'ä¼´ä¾£ã€‚", k:"æººçˆ±å­©å­ï¼Œå­©å­æ˜¯è½¯è‚‹ä¹Ÿæ˜¯åŠ¨åŠ›ã€‚", h:"ç”²çŠ¶è…ºä¹³è…ºé—®é¢˜ï¼Œå¤šæ—…æ¸¸æ•£å¿ƒåŒ–è§£æ¹¿æ°”ã€‚" } 
        },
        "å»ºç¦„æ ¼": { 
            name: "ğŸ’ª ç‹¬ç«‹é’¢é“ä¾  (å»ºç¦„/æ¯”åŠ«)", 
            slogan: "èº«å¼ºè‡ªæ—ºï¼Œå”¯æˆ‘ç‹¬å°Šã€‚æ±‚äººä¸å¦‚æ±‚å·±ã€‚", 
            male: { c:"äº‹å¿…èº¬äº²ï¼Œé—²ä¸ä¸‹æ¥ã€‚æŠ€æœ¯æ€»ç›‘ã€åˆä¼™äººã€‚é€‚åˆå¸¦é˜Ÿå†²é”‹ã€‚", w:"è¾›è‹¦é’±ï¼Œæ¯ä¸€åˆ†éƒ½æ˜¯æ±—æ°´ã€‚èº«æ—ºä»»è´¢ï¼Œä¸­æ™šå¹´å¤§å¯Œã€‚ä½†ä¹Ÿå®¹æ˜“è¢«åŠ«è´¢ã€‚", l:"å¤§ç”·å­ä¸»ä¹‰ï¼Œæ˜“å…‹å¦»ã€‚éœ€æ‰¾æ¸©æŸ”å¬è¯çš„è€å©†ã€‚", k:"å­©å­ç‹¬ç«‹ï¼Œæ”¾å…»å¼æ•™è‚²ã€‚", h:"èº«ä½“å£®å¦‚ç‰›ï¼Œç²¾åŠ›æ—ºã€‚æ³¨æ„è¿åŠ¨è¿‡é‡ã€‚" }, 
            female: { c:"æ¯”ç”·äººè¿˜æ‹¼ã€‚å¤–è¡¨æ–‡é™æŸ”å¼±ï¼Œå†…å¿ƒåˆšæ¯…å€”å¼ºã€‚ä¸å–œå¼„é™©ï¼Œç¨³æ‰ç¨³æ‰“ã€‚", w:"æåº¦å®ˆè´¢ï¼Œè´¢åç¦„åœ°ï¼ˆé’±åœ¨æ‰‹å¿ƒï¼‰ã€‚åªè¿›ä¸å‡ºï¼ŒåŒæ¶å€Ÿè´·ã€‚", l:"å®¹æ˜“é‡åˆ°æ€§æ ¼äº’è¡¥çš„ç¡¬æ±‰ã€‚è™½ç„¶å˜´ç¡¬ï¼Œä½†å¿ƒé‡Œä¾èµ–å¯¹æ–¹ã€‚", k:"åˆ©ç”Ÿè‚²ï¼Œå­©å­å¥åº·æ´»æ³¼ã€‚", h:"ç«æ°”å¤§ï¼Œæ˜“ä¸Šç«ã€‚æ³¨æ„ç”²çŠ¶è…ºã€‚" } 
        },
        "æ­£å®˜æ ¼": { 
            name: "ğŸ‘” ç¨³å¥è€å¹²éƒ¨ (æ­£å®˜æ ¼)", 
            slogan: "ç¨³ä½èƒ½èµ¢ï¼ŒæŒ‰éƒ¨å°±ç­ã€‚ç¦å¯¿å®‰åº·ä¹‹é€ ã€‚", 
            male: { c:"åƒçš‡ç²®ï¼Œä½“åˆ¶å†…ã€‚ç¨³é‡è®²è§„çŸ©ï¼Œæœ€æ€•å˜åŠ¨ã€‚", w:"æ­£è´¢ç¨³ï¼Œç¦åˆ©å¥½ã€‚åˆ«ç‚’è‚¡ï¼Œè€å®æ‹¿å·¥èµ„ä¹°æˆ¿æ”¶ç§Ÿã€‚", l:"è€å©†è´¤æƒ é—¨å½“æˆ·å¯¹ã€‚å©šå§»ç¨³å®šã€‚", k:"å­©å­å¬è¯å­¦éœ¸è‹—å­ã€‚", h:"å‹åŠ›åœ¨å¿ƒé‡Œï¼Œæ˜“èƒƒç—›ã€‚" }, 
            female: { c:"è¡Œæ”¿ã€HRã€ç®¡å®¶ã€‚åšäº‹äº•äº•æœ‰æ¡ï¼Œè€æ¿æœ€æ”¾å¿ƒã€‚", w:"è´¢æ”¿éƒ¨é•¿ï¼Œå®¶åº•è¶Šæ”’è¶Šåšã€‚ä¸ä¹±èŠ±é’±ä¹Ÿä¸äºå¾…è‡ªå·±ã€‚", l:"æ—ºå¤«ï¼ä¸ˆå¤«çš„åšå¼ºåç›¾ã€‚å¤«å¦»æ©çˆ±ã€‚", k:"æ•™å­æœ‰æ–¹ï¼Œå­©å­æœ‰æ•™å…»ã€‚", h:"ç”Ÿæ´»è§„å¾‹å¥åº·ã€‚" } 
        },
        "äº”è¡Œæµé€š": { 
            name: "â˜¯ï¸ å¹³è¡¡å¤§å¸ˆ (äº”è¡Œæµé€š)", 
            slogan: "ä¸åä¸å€šï¼Œä¸­åº¸ä¹‹é“ã€‚å¹³å¹³æ·¡æ·¡æ‰æ˜¯çœŸã€‚", 
            male: { c:"ä¸‡é‡‘æ²¹ï¼Œç»¼åˆç®¡ç†ã€‚é€‚åº”åŠ›å¼ºã€‚", w:"å°åº·æ°´å¹³ï¼Œè¡£é£Ÿæ— å¿§ã€‚ç»ä¸å—ç©·ã€‚", l:"ç›¸æ•¬å¦‚å®¾ï¼Œå¹³æ·¡æ˜¯ç¦ã€‚", k:"å­©å­æ™®é€šå­é¡ºã€‚", h:"é•¿å¯¿æ— å¤§ç¾ã€‚" }, 
            female: { c:"æ–‡å‘˜åå‹¤ã€‚å®‰ç¨³ç¬¬ä¸€ã€‚", w:"ä¸ç¼ºé›¶èŠ±é’±ï¼Œç”Ÿæ´»æ»‹æ¶¦ã€‚", l:"è´¤å¦»è‰¯æ¯ï¼Œå®¶åº­æ¸©é¦¨ã€‚", k:"å­©å­ä¹–å·§ï¼Œäº²å­å…³ç³»å¥½ã€‚", h:"æ²¡å¤§æ¯›ç—…ï¼Œæ‡‚å…»ç”Ÿã€‚" } 
        }
    };

    // --- åˆå§‹åŒ– ---

    window.onload = function() {
        try {
            const now = new Date();
            const pad = (n) => n < 10 ? '0'+n : n;
            const str = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
            document.getElementById('birth-input').value = str;
        } catch(e) {}
        
        if (typeof Solar === 'undefined') {
            document.getElementById('error-msg').style.display = 'block';
        }
    };

    function setGender(val, el) {
        currentGender = val;
        document.querySelectorAll('.g-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
    }

    // --- ä¸»é€»è¾‘ ---
    
    function calculateDestiny() {
        const timeStr = document.getElementById('birth-input').value;
        if (!timeStr) return alert("è¯·é€‰æ‹©å‡ºç”Ÿæ—¶é—´");

        try {
            const date = new Date(timeStr);
            const solar = Solar.fromYmdHms(date.getFullYear(), date.getMonth()+1, date.getDate(), date.getHours(), date.getMinutes(), date.getSeconds());
            const lunar = solar.getLunar();
            const bazi = lunar.getEightChar();
            bazi.setSect(2); 

            // 1. è·å–å…«å­—å­—ç¬¦ä¸²
            const yg = bazi.getYearGan().toString();  const yz = bazi.getYearZhi().toString();
            const mg = bazi.getMonthGan().toString(); const mz = bazi.getMonthZhi().toString();
            const dg = bazi.getDayGan().toString();   const dz = bazi.getDayZhi().toString();
            const hg = bazi.getTimeGan().toString();  const hz = bazi.getTimeZhi().toString();

            const pillars = [
                { t:'å¹´æŸ±', g:yg, z:yz },
                { t:'æœˆæŸ±', g:mg, z:mz },
                { t:'æ—¥æŸ±', g:dg, z:dz },
                { t:'æ—¶æŸ±', g:hg, z:hz }
            ];

            // 2. æ¸²æŸ“å››æŸ±
            renderPillars(pillars, dg);
            
            // 3. è®¡ç®—å¸ä»¤
            const cmdInfo = calcCommander(lunar, mz);
            
            // 4. è®¡ç®—èº«å¼ºèº«å¼± (å‡çº§ç‰ˆé€»è¾‘)
            const strengthInfo = analyzeGlobalStrength(cmdInfo, dg, mz, dz, hz);
            
            // 5. æ¸²æŸ“çœŸç¥ä¸åˆ¤å®š
            renderCommander(cmdInfo, strengthInfo, dg, mz);

            // 6. æ ¸å¿ƒå–œå¿Œä¸ç”»åƒ
            renderCoreQishu(strengthInfo, cmdInfo, dg, mz, pillars);

            // 7. ç»˜å›¾
            drawArt(pillars, mz);

            // 8. é«˜é˜¶æ ¼å±€æ–‡æ¡ˆ
            renderHighLevelPattern(pillars, dg, mz);

            const resArea = document.getElementById('result-area');
            resArea.style.display = 'block';
            resArea.scrollIntoView({ behavior: 'smooth' });

        } catch (e) {
            console.error(e);
            alert("æ¨æ¼”å¤±è´¥ï¼š" + e.message);
        }
    }

    function renderPillars(pillars, dayMaster) {
        let html = '';
        pillars.forEach(p => {
            const god = p.t === 'æ—¥æŸ±' ? 'æ—¥ä¸»' : (SHISHEN_MAP[dayMaster][p.g] || "");
            const cs = CHANGSHENG_TABLE[p.g][p.z] || "";
            const csClass = STRONG_CS.includes(cs) ? 'cs-tag cs-strong' : 'cs-tag';
            const csMeaning = CS_MEANING[cs] || "";
            const hiddens = HIDDEN_GAN_MAP[p.z] ? HIDDEN_GAN_MAP[p.z].join('') : "";
            const gWx = WUXING_MAP[p.g];
            const zWx = WUXING_MAP[p.z];

            html += `
                <div class="pillar">
                    <div class="p-head">${p.t}</div>
                    <div class="god-tag">${god}</div>
                    <div class="char ${WX_COLOR[gWx]}">${p.g}</div>
                    <div class="char ${WX_COLOR[zWx]}">${p.z}</div>
                    <div class="hidden-gan">è—${hiddens}</div>
                    <div class="${csClass}">${cs} ${csMeaning}</div>
                </div>
            `;
        });
        document.getElementById('pillars-box').innerHTML = html;
    }

    function calcCommander(lunar, monthZhi) {
        const prevJie = lunar.getPrevJie();
        const pjSolar = prevJie.getSolar();
        const jieTime = new Date(pjSolar.getYear(), pjSolar.getMonth()-1, pjSolar.getDay(), pjSolar.getHour(), pjSolar.getMinute(), pjSolar.getSecond()).getTime();
        const bSolar = lunar.getSolar();
        const birthTime = new Date(bSolar.getYear(), bSolar.getMonth()-1, bSolar.getDay(), bSolar.getHour(), bSolar.getMinute(), bSolar.getSecond()).getTime();
        const diffDays = Math.floor((birthTime - jieTime) / (1000 * 60 * 60 * 24));
        
        const rules = SILING_RULES[monthZhi] || [];
        let commander = 'æœªçŸ¥';
        let daysSum = 0;
        for (let rule of rules) {
            daysSum += rule[1];
            if (diffDays < daysSum) {
                commander = rule[0];
                break;
            }
        }
        if (commander === 'æœªçŸ¥' && rules.length > 0) commander = rules[rules.length-1][0];
        return { commander, diffDays, prevJieName: prevJie.getName() };
    }

    // === æ ¸å¿ƒä¼˜åŒ–ï¼šå…¨å±€èº«å¼ºèº«å¼±åˆ¤å®š (Global Strength Logic) ===
    function analyzeGlobalStrength(info, dm, mZ, dZ, hZ) {
        const dmWx = WUXING_MAP[dm];
        const mZWx = WUXING_MAP[mZ];
        const cmdWx = WUXING_MAP[info.commander];

        // 1. åˆ¤æ–­æœˆä»¤ (40%)
        const isHelp = (tWx, sWx) => tWx===sWx || (tWx==="æœ¨"&&sWx==="ç«") || (tWx==="ç«"&&sWx==="åœŸ") || (tWx==="åœŸ"&&sWx==="é‡‘") || (tWx==="é‡‘"&&sWx==="æ°´") || (tWx==="æ°´"&&sWx==="æœ¨");
        const menWang = isHelp(mZWx, dmWx);
        const diWang = isHelp(cmdWx, dmWx);
        
        // 2. åˆ¤æ–­æ—¥æ”¯ (è‡ªå) (30%)
        const dayCs = CHANGSHENG_TABLE[dm][dZ];
        const dayRootStrong = ["ä¸´å®˜", "å¸æ—º", "é•¿ç”Ÿ"].includes(dayCs);
        
        // 3. åˆ¤æ–­æ—¶æ”¯ (å½’å®¿) (20%)
        const hourCs = CHANGSHENG_TABLE[dm][hZ];
        const hourRootStrong = ["ä¸´å®˜", "å¸æ—º"].includes(hourCs);

        let finalStrong = false;
        let desc = "";

        // åˆ¤å®šé€»è¾‘ä¼˜å…ˆçº§
        if (dayRootStrong && hourRootStrong) {
            finalStrong = true;
            desc = "æ—¥æ—¶æ‰æ ¹ææ·±ï¼ˆä¸“ç¦„/å½’ç¦„ï¼‰ï¼Œæ— è§†æœˆä»¤è¡°å¼±ï¼Œç›´æ–­èº«å¼ºã€‚";
        } else if (menWang && diWang) {
            finalStrong = true;
            desc = "å¾—ä»¤å¾—æ°”ï¼Œæœˆä»¤æçº²æœ‰åŠ›ï¼Œèº«å¼ºã€‚";
        } else if (menWang && !diWang) {
            // é—¨æ—ºåœ°è¡°ï¼Œçœ‹æ—¥æ”¯
            if (dayRootStrong) {
                finalStrong = true;
                desc = "è™½çœŸç¥å¤±ä»¤ï¼Œä½†å¾—æœˆä½“ä¸”æ—¥åå¼ºæ ¹ï¼Œåˆ¤èº«å¼ºã€‚";
            } else {
                finalStrong = false;
                desc = "é—¨æ—ºåœ°è¡°ï¼Œæ—¥æ— å¼ºæ ¹ï¼Œå¤–å¼ºä¸­å¹²ï¼Œåˆ¤èº«å¼±ã€‚";
            }
        } else if (!menWang && diWang) {
            // é—¨è¡°åœ°æ—º
            if (dayRootStrong) {
                finalStrong = true;
                desc = "è™½å¤±æœˆä»¤ï¼Œä½†çœŸç¥ç›¸åŠ©ä¸”æ—¥åå¼ºæ ¹ï¼Œç»å¤„é€¢ç”Ÿï¼Œåˆ¤èº«å¼ºã€‚";
            } else {
                finalStrong = false; // ç•¥å¼±
                desc = "è™½çœŸç¥å¾—ç”¨ï¼Œä½†å…¨å±€å…‹æ³„è¾ƒé‡ï¼Œåˆ¤èº«å¼±å–œç”Ÿæ‰¶ã€‚";
            }
        } else {
            // é—¨åœ°ä¿±è¡°
            if (dayRootStrong && ["å† å¸¦","ä¸´å®˜"].includes(hourCs)) {
                finalStrong = true;
                desc = "è™½ç”Ÿäºè¡°æœˆï¼Œä½†æ—¥æ—¶ç¦„æ—ºé€šæ ¹ï¼Œç”šè‡³æ˜¯ä¸“ç¦„æ ¼ï¼Œåˆ¤èº«å¼ºã€‚";
            } else {
                finalStrong = false;
                desc = "é—¨åœ°ä¿±è¡°ï¼Œæ ¹æ°”ä¸è¶³ï¼ŒçœŸèº«å¼±ã€‚";
            }
        }

        return { isStrong: finalStrong, desc, dmWx };
    }

    function renderCommander(info, strengthInfo, dm, mZ) {
        const cmdGod = SHISHEN_MAP[dm][info.commander] || "";
        const cmdWx = WUXING_MAP[info.commander];
        
        const cmdDesc = `çœŸç¥å¾—ç”¨ï¼šæœˆä»¤ä¸­è— <b style="color:var(--primary)">${info.commander}(${cmdGod})</b> ä¸ºå¸ä»¤ã€‚æ­¤ä¸ºå‘½æ ¼ä¹‹çµé­‚ï¼Œæš—ä¸­ä¸»å¯¼å…¨å±€ã€‚`;
        
        // ä½¿ç”¨ StrengthInfo çš„ç»“è®º
        let statusText = "";
        if (strengthInfo.isStrong) {
            statusText = `<span class='tag-wang'>èº«å¼º (å®æˆ˜ä¿®æ­£)</span> ${strengthInfo.desc}`;
        } else {
            statusText = `<span class='tag-shuai'>èº«å¼± (å®æˆ˜ä¿®æ­£)</span> ${strengthInfo.desc}`;
        }

        const html = `
            <div>ğŸ“… <b>èŠ‚æ°”å®šä½</b>ï¼š${info.prevJieName}åç¬¬ <span class="highlight">${info.diffDays}</span> å¤©</div>
            <div style="margin-top:5px;">ğŸ¦ <b>äººå…ƒå¸ä»¤</b>ï¼šå½“å‰ç”± <span class="highlight">${info.commander}${cmdWx}</span> æ‰§æ”¿æŒæƒã€‚</div>
            <div style="margin-top:5px; font-size:12px; color:#555;">${cmdDesc}</div>
            <div style="margin-top:10px; border-top:1px dashed #eee; padding-top:10px;">${statusText}</div>
        `;
        document.getElementById('commander-box').innerHTML = html;
    }

    function renderCoreQishu(status, cmdInfo, dm, mZ, pillars) {
        let joys = [];
        let taboos = [];
        
        const season = ["äº¥","å­","ä¸‘"].includes(mZ) ? "å†¬" : ["å·³","åˆ","æœª"].includes(mZ) ? "å¤" : "å¹³";
        
        if (status.isStrong) {
            joys.push("é£Ÿä¼¤ (æ³„ç§€ç”Ÿè´¢)");
            joys.push("å®˜æ€ (æŠ¤è´¢å®ˆä¸š)");
            joys.push("è´¢æ˜Ÿ (å…»å‘½ä¹‹æº)");
            taboos.push("å°æ˜Ÿ (è¿‡æ—ºæ˜“æŠ˜)");
            taboos.push("æ¯”åŠ« (å¤ºè´¢)");
        } else {
            joys.push("å°æ˜Ÿ (è´µäººæ‰¶æŒ)");
            joys.push("æ¯”åŠ« (æœ‹å‹å¸®èº«)");
            taboos.push("å®˜æ€ (å…‹èº«å‹åŠ›)");
            taboos.push("é£Ÿä¼¤ (æ³„æ°”å¤ªè¿‡)");
        }

        if (season === "å†¬") { joys.unshift("ğŸ”¥ ç« (è°ƒå€™æš–å±€)"); taboos.push("ğŸ’§ æ°´ (æ¹¿å¯’)"); }
        if (season === "å¤") { joys.unshift("ğŸ’§ æ°´ (è°ƒå€™æ¶¦å±€)"); taboos.push("ğŸ”¥ ç« (ç„¦ç‡¥)"); }

        let html = `<div style="font-weight:bold; margin-bottom:5px;">ğŸ’¡ äº”è¡Œå–œå¿Œå®æˆ˜æ‰¹æ–­ï¼š</div>`;
        html += `<div class="joy-taboo-box">`;
        joys.forEach(j => html += `<span class="jt-tag jt-joy">å–œï¼š${j}</span>`);
        taboos.forEach(t => html += `<span class="jt-tag jt-taboo">å¿Œï¼š${t}</span>`);
        html += `</div>`;
        
        const dZ = pillars[2].z;
        let dayMeaning = "";
        if (CHANGSHENG_TABLE[dm][dZ] === "ä¸´å®˜") dayMeaning = "æ—¥åä¸´å®˜ï¼ˆä¸“ç¦„ï¼‰ï¼šèº«å¼ºè‡ªæ—ºï¼Œä¸æ„¿ä»åŠ¿ï¼Œå†…å¿ƒåˆšæ¯…ã€‚";
        else if (CHANGSHENG_TABLE[dm][dZ] === "å¸æ—º") dayMeaning = "æ—¥åå¸æ—ºï¼ˆç¾Šåˆƒï¼‰ï¼šä¸ªæ€§æå¼ºï¼Œå”¯æˆ‘ç‹¬å°Šï¼ŒæŠ—å‹èƒ½åŠ›æå¼ºã€‚";
        else if (CHANGSHENG_TABLE[dm][dZ] === "å¢“") dayMeaning = "æ—¥åè´¢åº“/å®˜åº“ï¼šç²¾æ˜æ”¶æ•›ï¼Œå–„äºç§¯ç´¯ï¼Œåªè¿›ä¸å‡ºã€‚";
        
        html += `<div style="margin-top:10px; font-size:13px; line-height:1.5;">
            <b>ğŸ—ï¸ å‘½é€ æ ¸å¿ƒç”»åƒï¼š</b><br>
            1. ${dayMeaning || "æ—¥ä¸»æ ¹æ°”å†³å®šäº†ä½ çš„æŠ—å‹èƒ½åŠ›ã€‚"}<br>
            2. ç»“åˆæ—¥æ—¶æ ¹æ°”ï¼Œä½ çš„å®æˆ˜ç­–ç•¥ä¸ºï¼š<b>${status.isStrong ? "ä»¥æ”»ä¸ºå®ˆï¼ŒæŠ€æœ¯ç«‹èº«" : "ä»¥å®ˆä¸ºæ”»ï¼Œå€ŸåŠ›æ‰“åŠ›"}</b>ã€‚
        </div>`;

        document.getElementById('core-qishu-box').innerHTML = html;
    }

    function drawArt(pillars, mZ) {
        const canvas = document.getElementById('fate-canvas');
        const ctx = canvas.getContext('2d');
        const w = canvas.parentElement.offsetWidth;
        const h = canvas.parentElement.offsetHeight;
        canvas.width = w;
        canvas.height = h;

        const counts = {'é‡‘':0,'æœ¨':0,'æ°´':0,'ç«':0,'åœŸ':0};
        pillars.forEach(p => {
            counts[WUXING_MAP[p.g]]++;
            counts[WUXING_MAP[p.z]]++;
        });
        
        const grad = ctx.createLinearGradient(0,0,0,h);
        if(["äº¥","å­","ä¸‘"].includes(mZ)) { grad.addColorStop(0,"#2c3e50"); grad.addColorStop(1,"#bdc3c7"); }
        else if(["å·³","åˆ","æœª"].includes(mZ)) { grad.addColorStop(0,"#ff7675"); grad.addColorStop(1,"#fab1a0"); }
        else if(["å¯…","å¯","è¾°"].includes(mZ)) { grad.addColorStop(0,"#55efc4"); grad.addColorStop(1,"#00b894"); }
        else { grad.addColorStop(0,"#ffeaa7"); grad.addColorStop(1,"#fab1a0"); }
        ctx.fillStyle = grad;
        ctx.fillRect(0,0,w,h);

        if(counts['æ°´']>0) {
            ctx.fillStyle = "rgba(52, 152, 219, 0.3)";
            ctx.beginPath(); ctx.moveTo(0,h); 
            for(let i=0; i<=w; i+=10) ctx.lineTo(i, h - 25*counts['æ°´'] + Math.sin(i*0.05)*10);
            ctx.lineTo(w,h); ctx.fill();
        }
        if(counts['ç«']>0) {
            ctx.fillStyle = "rgba(231, 76, 60, 0.5)";
            ctx.beginPath(); ctx.arc(w*0.8, h*0.2, 12*counts['ç«'], 0, Math.PI*2); ctx.fill();
        }
        if(counts['æœ¨']>0) {
            ctx.strokeStyle = "rgba(46, 204, 113, 0.5)"; ctx.lineWidth=2;
            for(let i=0; i<counts['æœ¨']*6; i++) {
                let x = Math.random()*w; let ht = 20 + Math.random()*60;
                ctx.beginPath(); ctx.moveTo(x,h); ctx.lineTo(x, h-ht); ctx.stroke();
            }
        }
        
        const maxWx = Object.keys(counts).reduce((a,b)=>counts[a]>counts[b]?a:b);
        document.getElementById('art-tag').innerText = `æ„è±¡ï¼š${maxWx}æ°”å……ç›ˆ`;
    }

    function renderHighLevelPattern(pillars, dm, mz) {
        const godMap = {}; 
        const positions = ['å¹´å¹²', 'æœˆå¹²', 'æ—¥å¹²', 'æ—¶å¹²'];
        const gans = [pillars[0].g, pillars[1].g, pillars[2].g, pillars[3].g];
        
        gans.forEach((g, i) => {
            if(i === 2) return; 
            const god = SHISHEN_MAP[dm][g];
            godMap[positions[i]] = god;
        });

        let key = "äº”è¡Œæµé€š";
        let reason = "äº”è¡Œæµé€šï¼Œæ°”åŠ¿è¾ƒä¸ºå¹³è¡¡";

        const hasSha = Object.values(godMap).includes("ä¸ƒæ€");
        if (hasSha) {
            const mGod = godMap['æœˆå¹²'];
            const yGod = godMap['å¹´å¹²'];
            const hGod = godMap['æ—¶å¹²'];
            
            let isControlled = false;
            if (mGod === "ä¸ƒæ€" && (yGod === "é£Ÿç¥" || hGod === "é£Ÿç¥")) isControlled = true;
            if (yGod === "ä¸ƒæ€" && mGod === "é£Ÿç¥") isControlled = true;
            if (hGod === "ä¸ƒæ€" && mGod === "é£Ÿç¥") isControlled = true;

            if (isControlled) { key = "é£Ÿç¥åˆ¶æ€"; reason = "é£Ÿç¥ç´§è´´ä¸ƒæ€ï¼Œåˆ¶æ€æœ‰åŠ›"; }
            else if (Object.values(godMap).includes("ä¼¤å®˜")) { key = "ä¼¤å®˜åˆæ€"; reason = "ä¼¤å®˜ä¸ä¸ƒæ€å¹¶è§ï¼Œä»¥æŸ”å…‹åˆš"; }
            else { key = "ä¸ƒæ€æ ¼"; reason = "ä¸ƒæ€é€å‡ºï¼Œéœ€æ³¨é‡èº«å¼ºæŠ—æ€"; }
        }
        else if (Object.values(godMap).includes("ä¼¤å®˜")) {
            const mGod = godMap['æœˆå¹²'];
            const yGod = godMap['å¹´å¹²'];
            const hGod = godMap['æ—¶å¹²'];
            
            let isShengCai = false;
            if (mGod === "ä¼¤å®˜" && (["æ­£è´¢","åè´¢"].includes(yGod) || ["æ­£è´¢","åè´¢"].includes(hGod))) isShengCai = true;
            if (["æ­£è´¢","åè´¢"].includes(mGod) && (yGod === "ä¼¤å®˜" || hGod === "ä¼¤å®˜")) isShengCai = true;

            if (yGod === "ä¼¤å®˜" && ["æ­£è´¢","åè´¢"].includes(hGod) && !isShengCai) {
                if(["æ¯”è‚©","åŠ«è´¢","æ­£å°","åå°"].includes(mGod)) {
                    isShengCai = false;
                    reason = "å¹´æ—¶é¥éš”ï¼Œä¸­é—´å—é˜»ï¼Œä¼¤å®˜ç”Ÿè´¢åŠ›åº¦å‡å¼±";
                } else {
                    isShengCai = true; 
                }
            }

            if (isShengCai) { key = "ä¼¤å®˜ç”Ÿè´¢"; reason = "ä¼¤å®˜ä¸è´¢æ˜Ÿç´§è´´ç›¸ç”Ÿï¼Œæ°”åŠ¿é¡ºç•…"; }
            else { key = "ä¼¤å®˜æ ¼"; reason = "ä¼¤å®˜é€å‡ºï¼Œä½†è´¢æ˜Ÿæœªç´§è´´æˆ–åŠ›é‡ä¸è¶³"; }
        }
        else if (["æ¯”è‚©","åŠ«è´¢"].includes(SHISHEN_MAP[dm][pillars[1].z])) {
            key = "å»ºç¦„æ ¼"; reason = "æœˆä»¤å»ºç¦„ï¼Œèº«å¼ºè´¢å®˜æœ‰æ°”";
        }
        else if (Object.values(godMap).includes("æ­£å®˜")) {
            key = "æ­£å®˜æ ¼"; reason = "æ­£å®˜é€å‡ºï¼Œæ°”è±¡çº¯æ­£";
        }

        if(!WITTY_DB[key]) key = "äº”è¡Œæµé€š";

        const data = WITTY_DB[key];
        const genderKey = currentGender === 1 ? 'male' : 'female';
        const detail = data[genderKey];

        document.getElementById('pattern-name').innerText = data.name;
        document.getElementById('pattern-explain').innerText = `[${reason}]`;
        document.getElementById('pattern-slogan').innerText = data.slogan;

        const html = `
            <div class="dim-row"><div class="dim-icon">ğŸ’¼</div><div class="dim-content"><div class="dim-title">äº‹ä¸š</div><div class="dim-text">${detail.c}</div></div></div>
            <div class="dim-row"><div class="dim-icon">ğŸ’°</div><div class="dim-content"><div class="dim-title">è´¢å¯Œ</div><div class="dim-text">${detail.w}</div></div></div>
            <div class="dim-row"><div class="dim-icon">ğŸ’</div><div class="dim-content"><div class="dim-title">æƒ…æ„Ÿ</div><div class="dim-text">${detail.l}</div></div></div>
            <div class="dim-row"><div class="dim-icon">ğŸ¼</div><div class="dim-content"><div class="dim-title">åä»£</div><div class="dim-text">${detail.k}</div></div></div>
            <div class="dim-row"><div class="dim-icon">ğŸ”‹</div><div class="dim-content"><div class="dim-title">èƒ½é‡</div><div class="dim-text">${detail.h}</div></div></div>
        `;
        document.getElementById('five-dim-box').innerHTML = html;
    }

</script>
</body>
</html>
