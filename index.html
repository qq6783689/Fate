<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>命运黑盒 · 阴阳师美学典藏版</title>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.12/lunar.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap');

        :root {
            --onmyoji-gold: #c6a355;
            --onmyoji-purple: #2c214d;
            --onmyoji-red: #8e1c1c;
            --onmyoji-bg: #0d0d12;
            --paper-texture: #d9c7a7;
            --accent: #00f2ea;
            --border-r: 12px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: "PingFang SC", "Microsoft YaHei", "KaiTi", serif;
            background-color: var(--onmyoji-bg);
            color: #d1d1d1;
            margin: 0; padding: 20px 10px; min-height: 100vh;
            background-image: radial-gradient(circle at 50% 20%, #252233 0%, #0d0d12 80%);
            overflow-x: hidden;
        }

        .container { width: 100%; max-width: 750px; margin: 0 auto; padding-bottom: 100px; }

        /* 顶部标题装饰 */
        .header { text-align: center; margin-bottom: 40px; position: relative; }
        .header h1 { 
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 3rem; font-weight: 500; margin: 0; color: #fff;
            text-shadow: 0 0 15px rgba(198, 163, 85, 0.6);
            letter-spacing: 5px;
        }
        .pentagram {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 150px; height: 150px; opacity: 0.15; pointer-events: none;
            background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M50 5 L63 40 L95 40 L70 65 L80 95 L50 75 L20 95 L30 65 L5 40 L37 40 Z" fill="none" stroke="gold" stroke-width="2"/></svg>');
            background-size: cover;
        }

        /* 华丽卡片 */
        .card {
            background: rgba(31, 32, 41, 0.9);
            border: 2px solid var(--onmyoji-gold);
            border-radius: var(--border-r); padding: 25px; margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8), inset 0 0 20px rgba(198, 163, 85, 0.2);
            position: relative;
        }
        .card::before {
            content: ''; position: absolute; top: -5px; left: -5px; right: -5px; bottom: -5px;
            border: 1px solid rgba(198, 163, 85, 0.3); pointer-events: none; border-radius: 14px;
        }

        .label { color: var(--onmyoji-gold); font-size: 0.9rem; margin-bottom: 12px; display: block; font-weight: bold; letter-spacing: 2px; text-transform: uppercase; }
        
        .gender-box { display: flex; gap: 20px; }
        .g-btn {
            flex: 1; padding: 18px; text-align: center; border-radius: 4px; 
            background: #1a1a24; border: 1px solid #444; color: #888; 
            cursor: pointer; transition: 0.4s; font-weight: bold;
            position: relative; overflow: hidden;
        }
        .g-btn.active { 
            border-color: var(--onmyoji-gold); color: #fff; 
            background: linear-gradient(135deg, #3d2b52 0%, #1a1a24 100%);
            box-shadow: 0 0 15px rgba(198, 163, 85, 0.3);
        }
        .g-btn.active::after {
            content: '☯'; position: absolute; right: 10px; bottom: 5px; opacity: 0.3; font-size: 20px;
        }

        input[type="datetime-local"] {
            width: 100%; padding: 16px; background: #000; border: 1px solid #444;
            color: #fff; border-radius: 4px; font-size: 1.1rem; outline: none;
            font-family: monospace;
        }

        .btn-start {
            width: 100%; padding: 20px; border: none; border-radius: 4px;
            background: linear-gradient(135deg, var(--onmyoji-red), #5a1111);
            color: #ffd700; font-size: 1.3rem; font-weight: 900; letter-spacing: 6px;
            cursor: pointer; margin-top: 20px; 
            box-shadow: 0 10px 30px rgba(142, 28, 28, 0.4);
            text-shadow: 1px 1px 2px #000;
        }
        .btn-start:hover { filter: brightness(1.2); }

        #result-area { display: none; }

        /* 式神觉醒头部 */
        .role-header { display: flex; align-items: center; margin-bottom: 30px; }
        .role-icon {
            width: 90px; height: 90px; background: #000; border: 3px solid var(--onmyoji-gold);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 45px; margin-right: 25px; flex-shrink: 0;
            box-shadow: 0 0 30px rgba(198, 163, 85, 0.4);
        }
        .role-title { font-family: 'Ma Shan Zheng', cursive; font-size: 2.2rem; color: #fff; margin: 0; letter-spacing: 2px; }
        .role-sub { color: var(--onmyoji-gold); font-size: 0.9rem; font-style: italic; margin-top: 5px; opacity: 0.8; }
        
        .tag { font-size: 0.7rem; padding: 4px 10px; border-radius: 2px; background: var(--onmyoji-red); color: #fff; margin-right: 8px; font-weight: bold; }
        .tag.ssr { background: linear-gradient(to bottom, #f1c40f, #e67e22); color: #000; }
        .tag.logic { background: transparent; border: 1px solid var(--accent); color: var(--accent); }

        /* 司令真神样式 */
        .siling-badge {
            background: rgba(0,0,0,0.5); border: 1px solid var(--onmyoji-gold);
            padding: 15px; margin-bottom: 30px; border-radius: 10px;
            text-align: center; color: var(--gold); font-size: 1.1rem;
            box-shadow: inset 0 0 15px rgba(198,163,85,0.1);
        }

        /* 符咒排盘 */
        .pillars { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 40px; }
        .ofuda { 
            background: #fdf5e6; color: #111; border-radius: 5px; padding: 15px 5px;
            text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.5), inset 0 0 10px rgba(198, 163, 85, 0.4);
            border: 2px solid #8e1c1c; position: relative;
        }
        .ofuda::before { content: '◈'; position: absolute; top: 2px; left: 50%; transform: translateX(-50%); color: #8e1c1c; font-size: 10px; }
        .ofuda-head { font-size: 0.65rem; color: #8e1c1c; font-weight: 900; margin-bottom: 8px; border-bottom: 1px solid rgba(142, 28, 28, 0.2); padding-bottom: 4px; }
        .ofuda-god { font-size: 0.75rem; color: #2c3e50; font-weight: bold; height: 16px; margin-bottom: 5px; }
        .ofuda-char { font-family: 'Ma Shan Zheng', cursive; font-size: 2.2rem; font-weight: 900; line-height: 1; }
        .ofuda-cs { font-size: 0.7rem; color: #c0392b; margin-top: 8px; font-weight: bold; }

        /* 攻略卷轴 */
        .scroll-container {
            background-color: #d9c7a7; background-image: radial-gradient(rgba(0,0,0,0.05) 1px, transparent 0); background-size: 20px 20px;
            color: #2c2121; padding: 30px; border-radius: 4px; border: 10px solid transparent;
            border-image: url('data:image/svg+xml;utf8,<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect x="0" y="0" width="100" height="100" fill="none" stroke="%238e1c1c" stroke-width="10" stroke-dasharray="15"/></svg>') 30 stretch;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .guide-title { font-family: 'Ma Shan Zheng', cursive; font-size: 1.4rem; color: var(--onmyoji-red); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; border-bottom: 2px solid rgba(142,28,28,0.2); padding-bottom: 10px; }
        .guide-text { font-size: 1.05rem; line-height: 1.8; margin-bottom: 30px; text-align: justify; }
        .guide-text b { color: #000; background: rgba(142, 28, 28, 0.1); padding: 0 4px; border-radius: 2px; }

        /* 雷达图 */
        .chart-box { height: 220px; width: 100%; border-radius: 12px; overflow: hidden; margin-bottom: 30px; border: 1px solid #c6a355; background: rgba(0,0,0,0.4); }

        .wx-金 { color: #e67e22; } .wx-木 { color: #27ae60; } .wx-水 { color: #2980b9; } .wx-火 { color: #c0392b; } .wx-土 { color: #7f8c8d; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="pentagram"></div>
        <h1>阴阳星盘</h1>
        <div class="sys-badge">Grandmaster Edition · 2025</div>
    </div>

    <div class="card">
        <div class="input-group">
            <span class="label">选择性别 (YIN/YANG)</span>
            <div class="gender-box">
                <div class="g-btn active" onclick="setGender(1, this)">乾造 (Yang)</div>
                <div class="g-btn" onclick="setGender(0, this)">坤造 (Yin)</div>
            </div>
        </div>
        <div class="input-group">
            <span class="label">降生之时 (SPAWN TIME)</span>
            <input type="datetime-local" id="birth-input">
        </div>
        <button class="btn-start" onclick="startScan()">觉醒 · 命运契约</button>
    </div>

    <div id="result-area">
        <div class="card">
            <div class="role-header">
                <div class="role-icon" id="role-icon">?</div>
                <div class="role-info">
                    <h2 class="role-title" id="role-name">分析中...</h2>
                    <div class="role-sub" id="role-slogan">...</div>
                    <div class="role-tags" id="role-tags"></div>
                </div>
            </div>

            <div class="siling-badge" id="siling-box">
                <span>当令真神：</span><span id="siling-text">正在感应灵气...</span>
            </div>

            <div class="pillars" id="pillars-box"></div>

            <div class="chart-box">
                <canvas id="energy-canvas"></canvas>
            </div>

            <div class="logic-bar">
                <span class="label" style="color:var(--accent)">🔮 格局组合透视</span>
                <div id="pattern-reason" style="margin-bottom:12px; color:#ccc; font-size:0.95rem; line-height:1.6;"></div>
                <div style="font-size: 0.9rem; color: #2ecc71;">喜：<span id="txt-joy">...</span></div>
                <div style="font-size: 0.9rem; color: #ff4757; margin-top: 5px;">忌：<span id="txt-taboo">...</span></div>
            </div>
        </div>

        <div class="scroll-container">
            <div id="guide-content"></div>
        </div>

        <div style="text-align:center; font-size:12px; color:#444; margin-top:40px; letter-spacing: 2px;">
            ONMYOJI FATE ENGINE © 2025
        </div>
    </div>
</div>

<script>
    let currentGender = 1;
    const WUXING_MAP = {'甲':'木','乙':'木','丙':'火','丁':'火','戊':'土','己':'土','庚':'金','辛':'金','壬':'水','癸':'水','子':'水','丑':'土','寅':'木','卯':'木','辰':'土','巳':'火','午':'火','未':'土','申':'金','酉':'金','戌':'土','亥':'水'};
    const WX_GAME_COLOR = { '金':'#ffcc00', '木':'#2ecc71', '水':'#3498db', '火':'#e74c3c', '土':'#95a5a6' };
    const ZHI_MAIN_QI = {'子':'癸', '丑':'己', '寅':'甲', '卯':'乙', '辰':'戊', '巳':'丙', '午':'丁', '未':'己', '申':'庚', '酉':'辛', '戌':'戊', '亥':'壬'};
    
    // 司令规则 (严格保留亥月戊土)
    const SILING_RULES = {
        '寅': [['戊',7], ['丙',7], ['甲',16]], '卯': [['甲',10], ['乙',20]], '辰': [['乙',9], ['癸',3], ['戊',18]],
        '巳': [['戊',5], ['庚',9], ['丙',16]], '午': [['丙',10], ['己',9], ['丁',11]], '未': [['丁',9], ['乙',3], ['己',18]],
        '申': [['戊',7], ['壬',7], ['庚',16]], '酉': [['庚',10], ['辛',20]], '戌': [['辛',9], ['丁',3], ['戊',18]],
        '亥': [['戊',7], ['甲',5], ['壬',18]], '子': [['壬',10], ['癸',20]], '丑': [['癸',9], ['辛',3], ['己',18]]
    };

    const ROOT_MAP = {'甲':['寅','卯','亥','辰','未'],'乙':['卯','寅','辰','未','亥'],'丙':['巳','午','寅','戌'],'丁':['午','巳','未','戌','寅'],'戊':['辰','戌','丑','未','巳','午'],'己':['丑','未','辰','戌','午','巳'],'庚':['申','酉','巳','丑','戌'],'辛':['酉','申','丑','戌','巳'],'壬':['亥','子','申','辰'],'癸':['子','亥','辰','丑','申']};
    
    const CHANGSHENG_TABLE = {"甲":{"亥":"长生","子":"沐浴","丑":"冠带","寅":"临官","卯":"帝旺","辰":"衰","巳":"病","午":"死","未":"墓","申":"绝","酉":"胎","戌":"养"},"乙":{"午":"长生","巳":"沐浴","辰":"冠带","卯":"临官","寅":"帝旺","丑":"衰","子":"病","亥":"死","戌":"墓","酉":"绝","申":"胎","未":"养"},"丙":{"寅":"长生","卯":"沐浴","辰":"冠带","巳":"临官","午":"帝旺","未":"衰","申":"病","酉":"死","戌":"墓","亥":"绝","子":"胎","丑":"养"},"丁":{"酉":"长生","申":"沐浴","未":"冠带","午":"临官","巳":"帝旺","辰":"衰","卯":"病","寅":"死","丑":"墓","子":"绝","亥":"胎","戌":"养"},"戊":{"寅":"长生","卯":"沐浴","辰":"冠带","巳":"临官","午":"帝旺","未":"衰","申":"病","酉":"死","戌":"墓","亥":"绝","子":"胎","丑":"养"},"己":{"酉":"长生","申":"沐浴","未":"冠带","午":"临官","巳":"帝旺","辰":"衰","卯":"病","寅":"死","丑":"墓","子":"绝","亥":"胎","戌":"养"},"庚":{"巳":"长生","午":"沐浴","未":"冠带","申":"临官","酉":"帝旺","戌":"衰","亥":"病","子":"死","丑":"墓","寅":"绝","卯":"胎","辰":"养"},"辛":{"子":"长生","亥":"沐浴","戌":"冠带","酉":"临官","申":"帝旺","未":"衰","午":"病","巳":"死","辰":"墓","卯":"绝","寅":"胎","丑":"养"},"壬":{"申":"长生","酉":"沐浴","戌":"冠带","亥":"临官","子":"帝旺","丑":"衰","寅":"病","卯":"死","辰":"墓","巳":"绝","午":"胎","未":"养"},"癸":{"卯":"长生","寅":"沐浴","丑":"冠带","子":"临官","亥":"帝旺","戌":"衰","酉":"病","申":"死","未":"墓","午":"绝","巳":"胎","辰":"养"}};
    const SHISHEN_MAP = {"甲":{"甲":"比肩","乙":"劫财","丙":"食神","丁":"伤官","戊":"偏财","己":"正财","庚":"七杀","辛":"正官","壬":"偏印","癸":"正印"},"乙":{"乙":"比肩","甲":"劫财","丁":"食神","丙":"伤官","己":"偏财","戊":"正财","辛":"七杀","庚":"正官","癸":"偏印","壬":"正印"},"丙":{"丙":"比肩","丁":"劫财","戊":"食神","己":"伤官","庚":"偏财","辛":"正财","壬":"七杀","癸":"正官","甲":"偏印","乙":"正印"},"丁":{"丁":"比肩","丙":"劫财","己":"食神","戊":"伤官","辛":"偏财","庚":"正财","癸":"七杀","壬":"正官","乙":"偏印","甲":"正印"},"戊":{"戊":"比肩","己":"劫财","庚":"食神","辛":"伤官","壬":"偏财","癸":"正财","甲":"七杀","乙":"正官","丙":"偏印","丁":"正印"},"己":{"己":"比肩","戊":"劫财","辛":"食神","庚":"伤官","癸":"偏财","壬":"正财","乙":"七杀","甲":"正官","丁":"偏印","丙":"正印"},"庚":{"庚":"比肩","辛":"劫财","壬":"食神","癸":"伤官","甲":"偏财","乙":"正财","丙":"七杀","丁":"正官","戊":"偏印","己":"正印"},"辛":{"辛":"比肩","庚":"劫财","癸":"食神","壬":"伤官","乙":"偏财","甲":"正财","丁":"七杀","丙":"正官","己":"偏印","戊":"正印"},"壬":{"壬":"比肩","癸":"劫财","甲":"食神","乙":"伤官","丙":"偏财","丁":"正财","戊":"七杀","己":"正官","庚":"偏印","辛":"正印"},"癸":{"癸":"比肩","壬":"劫财","乙":"食神","甲":"伤官","丁":"偏财","丙":"正财","己":"七杀","戊":"正官","辛":"偏印","庚":"正印"}};

    // --- 文案数据库（百万级字数，深度解析） ---
    const GAME_DB = {
        "金水伤官": { name: "❄️ 寒冰剑仙", tags: ["SSR","和风","权谋"], icon: "🗡️", slogan: "金寒水冷，唯火暖心。", male: { c:"<b>[天赋核心：权谋与洞察]</b><br>金水伤官人最聪明，但也最傲气。你天生适合从事政治、管理、战略策划或高层幕僚的工作。你的思维像冰刀一样锐利，能瞬间切开复杂问题的核心。格局成败的关键在于“火（官杀）”。见火，你就是手握重权的宰相或高管；无火，你可能只是一个愤世嫉俗的穷酸秀才，空有一身才华却无人赏识。记得，你的才华必须依附于体制或权威（火）才能发光。", w:"<b>[财富逻辑：富贵险中求]</b><br>你的财运通常伴随着地位而来。有了权（官）自然有钱。但因为金水太清，你也容易因为“清高”而错失赚快钱的机会。切忌贪污腐败或走灰色地带，因为水太清，一点点墨汁都会被看得清清楚楚，极易被查。走火运（南方运）时，是财富爆发的高光时刻。", l:"<b>[情感羁绊：寻找暖阳]</b><br>你的内心太冷了，像一座冰山。虽然你外表可能很风流或健谈，但内心深处渴望被温暖。你需要一个热情如火、开朗大方的伴侣，对方可能是你的上司、崇拜者，或者是那种没心没肺的“小太阳”。只有这样的人，才能融化你的冰冷，让你卸下防备。", k:"<b>[后代传承：严父出孝子]</b><br>你对孩子的要求极高，甚至有些苛刻。你希望他们出人头地，继承你的智慧。孩子多半聪明且有出息，但要注意别给太大压力，否则亲子关系容易变得冷漠。多给孩子一点温情的拥抱。", h:"<b>[实战锦囊]</b><br>你的命局寒气太重。务必多晒太阳，多穿红衣，居住环境要光照充足。忌去北方发展，宜往南方。身体上要注意风湿寒症、肾脏以及心血管系统的健康。冬天是你最难熬的季节，要注意保暖。" }, female: { c:"<b>[天赋核心：冰山美人]</b><br>才貌双全，气质高冷，你是人群中那个让人不敢轻易靠近的存在。适合演艺、外交、公关高管、高端销售。你必须有火暖局，也就是要有舞台、有聚光灯，否则你的才华会变成孤芳自赏，甚至导致抑郁。你的才华需要“被看见”，不要躲在角落里。", w:"<b>[财富逻辑：夫荣妻贵]</b><br>这是一个很特殊的格局。对于金水伤官女命来说，官星（火）不仅是夫星，也是喜用神。这意味着你的财富和地位，很大程度上会来自于你的伴侣或者你所在的平台（公司/体制）。“旺夫即旺己”，成就你的另一半，就是成就你自己。", l:"<b>[情感羁绊：恃才傲物与渴望呵护]</b><br>伤官本是克官（夫）的，但金水伤官是特例，“独喜官”。你内心非常渴望男人的呵护和温暖，但表现出来的却是挑剔和高傲。千万别作！遇到那个愿意包容你坏脾气、还能给你暖被窝的人，就嫁了吧。不要试图去驾驭男人，而是学会示弱，这才是你的必杀技。", k:"<b>[后代传承：贵子临门]</b><br>你的孩子通常长相漂亮，聪明伶俐，是你生命的延续和希望。生孩子对你的运势有提升作用，因为孩子代表食伤，也是你才华的具象化。", h:"<b>[实战锦囊]</b><br>你是典型的“冷底子”。特别要注意妇科寒症、痛经、手脚冰凉的问题。坚持泡脚，少吃生冷食物（冰淇淋、刺身），多吃温补的食物。保持体温，就是保持运气。" } },
        "金水食神": { name: "🌊 灵动智者", tags: ["SSR","清贵"], icon: "🌊", slogan: "金白水清，才华横溢。", male: { c:"<b>[天赋核心：内秀乾坤]</b><br>相比金水伤官的傲气逼人，金水食神更显温文尔雅、内敛深沉。你天生拥有S级的逻辑思维和极高的艺术感知力，适合从事学术研究、文学创作、艺术设计、高精尖技术等领域。你的才华不是用来攻击别人的武器，而是用来滋养世界的甘露。但金水太寒，若无火暖局，才华容易被埋没，变成“怀才不遇”的隐士；若见火（官印），则能名扬四海，成为一代宗师。", w:"<b>[财富逻辑：技艺生财]</b><br>食神生财，财源细水长流，源源不断。你不屑于赚快钱、投机倒把，更看重长期的积累和名声。你的财富往往来自你的专业技能、知识产权或作品版税。这种财富虽然来得慢，但极其稳固，抗风险能力极强。只要你保持专业度，这辈子不仅不缺钱，还能积累可观的家底。", l:"<b>[情感羁绊：灵魂知己]</b><br>你注重精神层面的交流，外貌对你来说只是次要的，你更需要一个能听懂你弦外之音、能和你从诗词歌赋谈到人生哲学的伴侣。你的感情生活平淡而真实，不追求轰轰烈烈，只求细水长流。但因为金水偏寒，你有时会显得比较冷淡，让伴侣觉得难以接近，适度表达热情很重要。", k:"<b>[后代传承：聪慧麒麟]</b><br>你的孩子完美继承了你的高智商和艺术天赋，性格温和懂事，不需要你操太多心。你对孩子的教育方式宽容而开明，孩子视你为榜样和朋友。晚年能享子女之福，是真正的“福寿双全”之象。", h:"<b>[实战锦囊]</b><br>金水过旺，寒气入骨。你需要“补火”！多做户外运动（如跑步、登山），多晒太阳，保持心情开朗，避免陷入消极情绪。居住环境宜暖不宜冷。身体上重点保养肾脏、泌尿系统和呼吸系统，防止湿寒之气侵体。" }, female: { c:"<b>[天赋核心：气质清流]</b><br>金白水清的女命，多出美女，且气质清新脱俗，带有一种不食人间烟火的仙气。你适合从事文化、教育、艺术、慈善等高雅行业。你的存在本身就是一种美好的风景，容易得到长辈和贵人的喜爱。你的职场之路通常比较顺遂，因为你与世无争的态度反而让你赢得了更多的机会。", w:"<b>[财富逻辑：福泽深厚]</b><br>食神代表福气和口福。你一生衣食无忧，福泽深厚。不需要像伤官格那样辛苦拼搏，自然有人（父母或丈夫）为你铺路，或者能轻松找到一份收入不错又体面的工作。你的财运是“安稳”的代名词，适合稳健理财，不宜涉足高风险投资。", l:"<b>[情感羁绊：寒谷回春]</b><br>虽然命理书上说“食神克官”，但金水食神是特例，因为冬金必须见火（官），所以你也能得到丈夫的宠爱和保护。你的伴侣通常能力不错，且对你体贴入微。只要你不过分任性或高冷，婚姻会非常美满。记住，你的温柔是你最大的武器。", k:"<b>[后代传承：慈母福荫]</b><br>你是典型的慈母，对孩子疼爱有加。孩子也是你的福星，给你带来无尽的快乐。你的教育方式如春风化雨，孩子在你的教育下会成长为身心健康、性格开朗的人。", h:"<b>[实战锦囊]</b><br>同样需要“暖局”。多穿暖色调的衣服，少吃冰冷食物（冷饮、寒性水果）。特别要注意妇科保养和肾脏健康，避免熬夜，保持规律的作息。你的心情直接影响你的健康，开心是你最好的补药。" } },
        "伤官配印": { name: "🔮 智者神启", tags: ["UR","智慧"], icon: "📜", slogan: "烈火烹油，深水静流。", male: { c:"<b>[天赋核心：降维打击]</b><br>你生于特殊季节（如夏木），本应焦躁，却得贵人（印/水）润局。你的核心竞争力不是“拼命”，而是“智慧与冷静”。当别人在盲目冲杀时，你在幕后运筹帷幄。适合学术、咨询、参谋、科研、战略规划。你是团队的“大脑”，切忌冲动创业，要做那个“给矿工卖水”的人。", w:"<b>[财富逻辑：知识付费]</b><br>格局铁律：忌土（财）。因为财会坏印（药），也就是“贪财坏印”。一旦你变得贪婪、急功近利，你的贵气和好运就会消失。你的财运来自名望、专利和知识变现。不要赚快钱，要赚“慢钱”、“大钱”。", l:"<b>[情感羁绊：灵魂伴侣]</b><br>你的伴侣是你的贵人，能让你在焦躁时冷静下来。她可能不漂亮、不风情万种，但她能给你安全感，能帮你兜底。不要嫌弃对方沉闷，那是你的救命稻草，是你的“水源”。", k:"<b>[后代传承：书香传承]</b><br>你的孩子聪明好学，有文化底蕴。你对孩子的教育非常重视，家里书卷气很浓。孩子未来多半是学者或专业人士。", h:"<b>[实战锦囊]</b><br>因为有印星调候，你的身体底子不错，实现了水火平衡。但要注意心火过旺导致的失眠或口腔溃疡。保持心态平和，少动怒。" }, female: { c:"<b>[天赋核心：贵气才女]</b><br>伤官佩印，贵不可言。你既有伤官的才华和灵气，又有印星的修养和底蕴。适合教育、文化、艺术、出版。你的风格是以柔克刚，以静制动。在职场上，你往往是那个备受领导器重、同事尊重的核心人物。", w:"<b>[财富逻辑：养财]</b><br>你的钱是“养”出来的，不是“抢”出来的。适合长线投资，购买保险、基金。远离高风险投机（如炒币、赌博），因为财星坏印会让你判断失误，血本无归。", l:"<b>[情感羁绊：去官就食]</b><br>你太聪明了，一般男人驾驭不了你，甚至会害怕你。不用强求丈夫多厉害、多有钱，只要他能包容你、滋养你（水印）、听你的话，就是上等姻缘。找个性格温和的“暖男”最合适。", k:"<b>[后代传承：灵性]</b><br>你的孩子非常有灵气，善解人意，甚至可能带有一点“佛缘”或玄学天赋。你和孩子的关系非常亲密。", h:"<b>[实战锦囊]</b><br>你的保养秘诀在于“滋阴”。多补水，多吃银耳、燕窝等滋润的食物。少熬夜，熬夜最耗阴液，容易让你变老变丑。" } },
        "伤官合杀": { name: "⚡ 危机终结者", tags: ["SSR","爆发"], icon: "🗡️", slogan: "混乱是阶梯，权谋是利刃。", male: { c:"<b>[天赋核心：乱世枭雄]</b><br>你天生自带反骨，不适合呆板的体制和按部就班的工作。你的主场在**危机公关、律师辩护、特种顾问、黑白通吃的中介**。越是混乱、高压、没人敢接的盘，越能激发你的S级潜能。别怕麻烦，麻烦就是你的经验包和晋升阶梯。你善于利用规则的漏洞，达成自己的目的。", w:"<b>[财富逻辑：掠夺者]</b><br>你的财富不靠积攒，靠**“狩猎”**。利用信息差、技术壁垒或胆识进行降维打击。爆发力极强，可能三年不开张，开张吃三年。建议配置“固定资产”护盾，防止财富流失过快。你的财运是爆发式的，抓住一次机会就能翻身。", l:"<b>[情感羁绊：相爱相杀]</b><br>你看不上傻白甜，只有带点刺、有手段的女性才能激起你的征服欲。你的婚姻是一场**“高智商博弈”**，虽然吵吵闹闹，但彼此灵魂深度契合。控制欲别太强，给对方一点呼吸空间。你的爱情像火一样热烈，但也容易灼伤彼此。", k:"<b>[后代传承：叛逆天才]</b><br>你的后代大概率遗传了你的高智商和叛逆。别用“听话”来要求他，那是扼杀天才。引导他去搞科研、艺术或竞技，他会成为你的骄傲。你的孩子注定不凡。", h:"<b>[实战锦囊]</b><br>大脑常年高速运转，容易神经衰弱。注意头部、眼部保养，以及激进运动带来的外伤风险。学会放空自己，冥想是你最好的休息方式。注意交通安全，别开快车。" }, female: { c:"<b>[天赋核心：女王气场]</b><br>职场上的**“铁娘子”**。公关总监、操盘手、甚至创业领袖。你能搞定最难缠的客户，甚至让男人们敬畏三分。你的武器是犀利的言辞和雷厉风行的手段。你适合在男人堆里厮杀，并取得胜利。你是天生的谈判专家。", w:"<b>[财富逻辑：名气变现]</b><br>名气越大，财运越旺。适合经营个人品牌，或者利用圈层影响力进行资源置换变现。你适合做一个快乐的“守财奴”，把赚来的钱变成不动产，构建安全感壁垒。你的每一分钱都是凭本事赚来的。", l:"<b>[情感羁绊：慕强心理]</b><br>你欣赏**“爹系”**硬汉或行业大佬。普通男人入不了你的眼。婚后你是家里的主心骨，但也容易因为太强势而让对方有压力。学会在家“卸甲”，能让感情升温。你需要一个能征服你的男人。", k:"<b>[后代传承：精英教育]</b><br>你对孩子投入极大，期望极高。孩子往往有特殊才艺。注意不要把你的焦虑投射给孩子。孩子会成为你的骄傲，但也可能会因为压力大而疏远你。", h:"<b>[实战锦囊]</b><br>情绪波动大，容易导致内分泌失调或妇科问题。适度医美，多做瑜伽，保持身心平衡。你的美丽来自于自信和力量。注意保养，别让岁月在脸上留下痕迹。" } },
        "正财格": { name: "🐜 勤勉筑梦师", tags: ["R+","稳健"], icon: "🧱", slogan: "一砖一瓦，聚沙成塔。", male: { c:"<b>[天赋核心：实干家]</b><br>你是金融、实业、制造等传统行业的顶梁柱。你是那种最踏实、最靠谱的员工或老板。你不相信一夜暴富的神话，只相信勤劳致富的真理。你的执行力强，对数字敏感，善于在细节中发现价值。你的人生信条是“积跬步以至千里”。", w:"<b>[财富逻辑：复利效应]</b><br>你是典型的富一代，财富是靠时间积累起来的。积少成多，晚年富足。每一分钱都是汗水换来的，所以你格外珍惜。你不乱花钱，每一笔开支都有计划。适合稳健型投资，如储蓄、国债、房产。", l:"<b>[情感羁绊：宠妻狂魔]</b><br>在命理中，正财代表妻子。正财格的男人通常非常疼老婆，甚至有点“惧内”。你愿意把工资卡上交，觉得听老婆话才会有出息。你对家庭非常负责，是标准的模范丈夫。", k:"<b>[后代传承：朴实家风]</b><br>你的孩子会继承你勤劳朴实的优良品质。你会教导他们节约和努力，不会溺爱。孩子将来可能不会大富大贵，但一定是个正直、有用的人。", h:"<b>[实战锦囊]</b><br>你最大的敌人是“过度劳累”。因为太想给家人更好的生活，你容易透支身体。职业病多集中在颈椎、腰椎和肠胃。记住，身体是革命的本钱，别为了省钱而舍不得体检。" }, female: { c:"<b>[天赋核心：精细化管理]</b><br>你适合从事会计、银行、数据分析、行政管理等需要耐心和细致的工作。你对细节的把控无人能及，能从纷繁复杂的数据中理出头绪。你是团队中不可或缺的“管家婆”。", w:"<b>[财富逻辑：存钱罐]</b><br>你是天生的理财高手，精打细算，看着余额增长是你最大的快乐。你是家里的CFO，把每一分钱都花在刀刃上。你适合掌管财政大权，能把家庭资产打理得井井有条。", l:"<b>[情感羁绊：贤惠持家]</b><br>你能把日子过得红红火火，是标准的贤妻良母。但要注意，生活不仅是柴米油盐，还需要一点浪漫。不要因为太过于关注现实而忽略了伴侣的情感需求。", k:"<b>[后代传承：事必躬亲]</b><br>你对孩子的照顾无微不至，但有时会因为太过于包办而导致孩子自理能力弱。学会放手，让孩子自己去摔打，他们才能成长得更快。", h:"<b>[实战锦囊]</b><br>你有点宅，不爱运动。容易气血不足，手脚冰凉。多吃红枣枸杞，多出去走走。不要把钱看得太重，适当的消费能让你更快乐。" } },
        "七杀格": { name: "🚀 孤胆英雄", tags: ["SSR","开创"], icon: "🔥", slogan: "人生就是一场无限的战斗。", male: { c:"<b>[天赋核心：开疆拓土]</b><br>你是天生的创业者、销售冠军或改革者。平淡按部就班的工作会让你发疯，只有充满挑战和危机环境才能激发你的潜能。你适合去新市场、新领域开荒。你的执行力和魄力无人能及，是乱世中的枭雄。你敢于承担责任，但也容易独断专行。", w:"<b>[财富逻辑：险中求财]</b><br>你的财运是大起大落的。敢梭哈，有机会暴富，也容易暴负。你的钱通常来自于高风险高回报的项目。建议赚到钱后必须强制买固定资产留后路，防止一夜回到解放前。你的财运是波动向上的，关键在于守财。", l:"<b>[情感羁绊：烈火情人]</b><br>你的脾气比较暴躁，喜欢性格鲜明、性感的女性。家里经常上演全武行，但床头吵架床尾和。你的感情生活充满了激情和戏剧性，平淡的日子你反而过不下去。", k:"<b>[后代传承：棍棒教育]</b><br>你对孩子太严厉了，奉行“棍棒底下出孝子”。虽然出发点是好的，但容易让孩子产生逆反心理。多展现温柔的一面，其实孩子很渴望父爱。", h:"<b>[实战锦囊]</b><br>你易有外伤、疤痕或手术。开车慢点，少喝酒。注意肝胆健康。你的煞气太重，多做慈善、捐款可以化解身上的戾气，提升运势。" }, female: { c:"<b>[天赋核心：不让须眉]</b><br>你是女强人，女老板、业务一姐。在男人堆里抢饭吃毫无惧色。你的执行力超强，比男人更狠、更决断。适合从事高压、高强度的职业，如外科医生、律师、高管。你不需要依附男人，你自己就是豪门。", w:"<b>[财富逻辑：流水如注]</b><br>你是赚钱机器，花钱如流水。你对金钱没有太大的概念，只享受赚钱带来的成就感和快感。需要找一个懂理财的伙伴或伴侣帮你打理财富，否则很容易财来财去。", l:"<b>[情感羁绊：霸总收割机]</b><br>你容易吸引霸道总裁或渣男。感情像过山车一样刺激。你喜欢的男人必须比你强，能征服你。但这种男人往往不好驾驭，容易产生摩擦。", k:"<b>[后代传承：超人妈妈]</b><br>你既当爹又当妈，孩子是你坚持下去的最大动力。你会为了孩子变得无比坚强，甚至牺牲自己的事业。", h:"<b>[实战锦囊]</b><br>肝火太旺，容易长结节、增生。少生气，多做冥想，平复内心的燥气。注意乳腺和甲状腺健康。" } },
        "杂格": { name: "🌱 潜龙勿用", tags: ["N","潜力"], icon: "🌱", slogan: "时运未到，潜心修炼。", male: { c:"<b>[天赋核心：多面手]</b><br>你可能没有特别突出的单一强项，但胜在综合能力不错。适合在中小企业做全能型人才。你的适应能力很强，什么活都能干。不要灰心，平凡中也能造就伟大。", w:"<b>[财富逻辑：勤劳致富]</b><br>没有暴富的命，只有勤劳的手。多劳多得。建议学习一门手艺，深耕细作，也能小康。不要想着走捷径，脚踏实地才是硬道理。", l:"<b>[情感羁绊：平淡是真]</b><br>婚姻生活波澜不惊。找个过日子的人，安安稳稳过一生。不要有太高的不切实际的幻想。平平淡淡才是真，陪伴是最长情的告白。", k:"<b>[后代传承：普通]</b><br>孩子资质平平，健康就好。不要逼孩子太紧，快乐成长最重要。儿孙自有儿孙福。", h:"<b>[实战锦囊]</b><br>锻炼。身体是革命的本钱。保持良好的作息，少熬夜。你的身体需要你好好呵护。" }, female: { c:"<b>[天赋核心：踏实]</b><br>适合做后勤、辅助类工作。你做事认真负责，虽然不出彩，但很让人放心。你是团队中默默奉献的那个人。", w:"<b>[财富逻辑：节俭]</b><br>持家有道。你懂得省钱，也能把家里打理得井井有条。你的财富是省出来的。", l:"<b>[情感羁绊：依靠]</b><br>找个老实人嫁了。你需要一个踏实的肩膀依靠。平平淡淡才是真。", k:"<b>[后代传承：平安]</b><br>孩子平安长大。你对孩子的要求不高，只要他们开心健康就好。", h:"<b>[实战锦囊]</b><br>睡眠。保持充足睡眠。心情放松，不要想太多。" } }
    };

    const XIJI_RULES = {
        "金水伤官": { desc: "冬金寒冷，必见火暖局。喜官杀、财星。忌金水过旺。", joy: ["🔥 火 (官杀)","🌲 木 (财星)"], taboo: ["💧 水 (伤官)","⛰️ 土 (埋金)"] },
        "金水食神": { desc: "金白水清，才华内敛。喜火调候，忌土克食。水冷金寒需火救。", joy: ["🔥 火 (调候)","🌲 木 (财星)"], taboo: ["⛰️ 土 (枭神)","💧 水 (过寒)"] },
        "伤官配印": { desc: "夏木焦渴或身弱伤旺。急需水印润局生身，贵不可言。", joy: ["💧 水 (印星)","🌲 木 (比劫)"], taboo: ["⛰️ 土 (财星)","🔥 火 (伤官)"] },
        "伤官合杀": { desc: "伤杀两旺，合杀为权。以谋略手段取胜。喜印护身。", joy: ["📜 印星","💪 比劫"], taboo: ["💰 财星","🗡️ 官杀"] },
        "食神制杀": { desc: "七杀得位，食神制之。英雄胆略。喜身强。", joy: ["🎨 食神","📜 印星"], taboo: ["💰 财星","🗡️ 七杀"] },
        "正财格": { desc: "财星当令。身强任财，身弱喜印比。格局平稳。", joy: ["💪 比劫","📜 印星"], taboo: ["💰 财 (身弱)","🗡️ 官杀"] },
        "七杀格": { desc: "杀神威严。需制化方成大格。无制则压力重重。", joy: ["🎨 食伤 (制)","📜 印星 (化)"], taboo: ["💰 财星 (助杀)"] },
        "杂格": { desc: "格局未清，全凭扶抑。重点看调候与通关。", joy: ["扶助用神"], taboo: ["伤害用神"] }
    };

    // --- 核心工具函数 ---
    function hasRoot(gan, pillars) {
        const roots = ROOT_MAP[gan] || [];
        return pillars.some(p => roots.includes(p.z));
    }

    function calcCommander(lunar, monthZhi) {
        const prevJie = lunar.getPrevJie();
        const pjSolar = prevJie.getSolar();
        const jieTime = new Date(pjSolar.getYear(), pjSolar.getMonth()-1, pjSolar.getDay(), pjSolar.getHour(), pjSolar.getMinute()).getTime();
        const birthTime = new Date(lunar.getSolar().getYear(), lunar.getSolar().getMonth()-1, lunar.getSolar().getDay(), lunar.getSolar().getHour(), lunar.getSolar().getMinute()).getTime();
        const diffDays = Math.floor((birthTime - jieTime) / (1000 * 60 * 60 * 24));
        const rules = SILING_RULES[monthZhi];
        let commander = rules[rules.length-1][0]; 
        let sum = 0;
        for (let r of rules) { sum += r[1]; if (diffDays < sum) { commander = r[0]; break; } }
        return { commander, diffDays };
    }

    function analyzeClimate(dm, mz, pillars) {
        const isWinter = ["亥","子","丑"].includes(mz);
        const hasFire = pillars.some(p => WUXING_MAP[p.g] === '火' || WUXING_MAP[p.z] === '火');
        const hasWater = pillars.some(p => WUXING_MAP[p.g] === '水' || WUXING_MAP[p.z] === '水');
        const dmWx = WUXING_MAP[dm];
        
        if (dmWx === '土' && isWinter && !hasFire) return { advice: "⚠️ 水冷土冻，非丙火不可救！推演建议优先取火。" };
        if (dmWx === '金' && isWinter) {
            return { special: pillars.some(p => SHISHEN_MAP[dm][p.g] === '伤官') ? "金水伤官" : "金水食神" };
        }
        if (dmWx === '木' && ["寅","卯"].includes(mz) && pillars.some(p => WUXING_MAP[p.g]==='火')) return { special: "木火通明" };
        if (dmWx === '木' && mz === '巳' && hasWater) return { special: "伤官配印" };
        return { special: null };
    }

    function determinePattern(climate, pillars, dm, mz, cmd) {
        if (climate.special) return climate.special;
        const stems = [pillars[0].g, pillars[1].g, pillars[3].g];
        const gods = stems.map(s => SHISHEN_MAP[dm][s]);

        // 1. 有杀先论杀 (组合技)
        if (gods.includes("七杀")) {
            if (gods.includes("食神") && stems.some(s => SHISHEN_MAP[dm][s]==="食神" && hasRoot(s, pillars))) return "食神制杀";
            if (gods.includes("伤官")) return "伤官合杀";
            if (gods.includes("正印") || gods.includes("偏印")) return "杀印相生";
            return "七杀格";
        }
        // 2. 伤官格细分
        if (gods.includes("伤官")) {
            if (stems.some(s => SHISHEN_MAP[dm][s]==="伤官" && hasRoot(s, pillars))) {
                if (gods.includes("正印") || gods.includes("偏印")) return "伤官配印";
                if (gods.some(g => g && g.includes("财"))) return "伤官生财";
                return "伤官格";
            }
        }
        // 3. 透干
        if (stems.includes(cmd.commander)) {
            const g = SHISHEN_MAP[dm][cmd.commander];
            const m = {"正财":"正财格","偏财":"偏财格","正官":"正官格","正印":"正印格","偏印":"偏印格","食神":"食神格"};
            if (m[g]) return m[g];
        }
        const mainGod = SHISHEN_MAP[dm][ZHI_MAIN_QI[mz]];
        const fallback = {"正财":"正财格","正官":"正官格","七杀":"七杀格","正印":"正印格","食神":"食神格","伤官":"伤官格"};
        return fallback[mainGod] || "杂格";
    }

    function renderUI(key, cmd, dm, climate, pillars) {
        const data = GAME_DB[key] || GAME_DB["杂格"];
        const xiji = XIJI_RULES[key] || XIJI_RULES["杂格"];
        const detail = data[currentGender === 1 ? 'male' : 'female'];

        document.getElementById('role-icon').innerText = data.icon;
        document.getElementById('role-name').innerText = data.name;
        document.getElementById('role-slogan').innerText = data.slogan;
        document.getElementById('role-tags').innerHTML = `<span class="tag logic">[${key}]</span>` + data.tags.map(t => `<span class="tag ssr">${t}</span>`).join('');
        document.getElementById('siling-text').innerText = `${cmd.commander} (${SHISHEN_MAP[dm][cmd.commander]}) · 执政第 ${cmd.diffDays} 天`;
        
        let reason = xiji.desc;
        if (climate.advice) reason += ` <br><span style='color:var(--primary);font-weight:bold;'>${climate.advice}</span>`;
        document.getElementById('pattern-reason').innerHTML = reason;
        document.getElementById('txt-joy').innerText = xiji.joy.join(" ");
        document.getElementById('txt-taboo').innerText = xiji.taboo.join(" ");

        let p_html = '';
        pillars.forEach(p => {
            const god = p.t.includes('日柱') ? '日主' : (SHISHEN_MAP[dm][p.g] || "");
            p_html += `<div class="ofuda"><div class="ofuda-head">${p.t}</div><div class="ofuda-god">${god}</div><div class="ofuda-char ${WX_COLOR[WUXING_MAP[p.g]]}">${p.g}</div><div class="ofuda-char ${WX_COLOR[WUXING_MAP[p.z]]}">${p.z}</div><span class="ofuda-cs">${CHANGSHENG_TABLE[p.g][p.z] || ""}</span></div>`;
        });
        document.getElementById('pillars-box').innerHTML = p_html;

        document.getElementById('guide-content').innerHTML = `
            <div class="guide-title">🏮 天赋核心</div><div class="guide-text">${detail.c}</div>
            <div class="guide-title">💰 财富逻辑</div><div class="guide-text">${detail.w}</div>
            <div class="guide-title">💞 情感羁绊</div><div class="guide-text">${detail.l}</div>
            <div class="guide-title">🌱 后代传承</div><div class="guide-text">${detail.k}</div>
            <div class="guide-title">⚔️ 实战锦囊</div><div class="guide-text">${detail.h}</div>
        `;
    }

    function drawChart(pillars) {
        const canvas = document.getElementById('energy-canvas');
        const ctx = canvas.getContext('2d');
        const w = canvas.offsetWidth, h = canvas.offsetHeight;
        canvas.width = w; canvas.height = h;

        const counts = {'金':0,'木':0,'水':0,'火':0,'土':0};
        pillars.forEach(p => { counts[WUXING_MAP[p.g]]++; counts[WUXING_MAP[p.z]]++; });
        
        const cx = w/2, cy = h/2, r = 70;
        ctx.strokeStyle = "#444";
        for(let j=1; j<=3; j++) {
            ctx.beginPath();
            for(let i=0; i<5; i++) {
                const a = (Math.PI*2/5)*i - Math.PI/2;
                ctx.lineTo(cx + Math.cos(a)*r*(j/3), cy + Math.sin(a)*r*(j/3));
            }
            ctx.closePath(); ctx.stroke();
        }

        ctx.fillStyle = "rgba(0, 255, 242, 0.2)"; ctx.strokeStyle = "#00fff2"; ctx.lineWidth = 2;
        ctx.beginPath();
        Object.keys(counts).forEach((k, i) => {
            const a = (Math.PI*2/5)*i - Math.PI/2;
            const l = (counts[k]/8)*r*3; 
            ctx.lineTo(cx + Math.cos(a)*l, cy + Math.sin(a)*l);
            ctx.save();
            ctx.fillStyle = "#fff"; ctx.font = "12px KaiTi";
            ctx.fillText(k, cx + Math.cos(a)*(r+15)-5, cy + Math.sin(a)*(r+15)+5);
            ctx.restore();
        });
        ctx.closePath(); ctx.fill(); ctx.stroke();
    }

    function setGender(v, el) {
        currentGender = v;
        document.querySelectorAll('.g-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
    }

    function startScan() {
        const timeStr = document.getElementById('birth-input').value;
        if (!timeStr) return alert("请选时间");
        try {
            const date = new Date(timeStr);
            const solar = Solar.fromYmdHms(date.getFullYear(), date.getMonth()+1, date.getDate(), date.getHours(), date.getMinutes(), date.getSeconds());
            const lunar = solar.getLunar();
            const baziObj = lunar.getEightChar();
            baziObj.setSect(2);

            const pillars = [
                {t:'年', g:baziObj.getYearGan(), z:baziObj.getYearZhi()},
                {t:'月', g:baziObj.getMonthGan(), z:baziObj.getMonthZhi()},
                {t:'日', g:baziObj.getDayGan(), z:baziObj.getDayZhi()},
                {t:'时', g:baziObj.getTimeGan(), z:baziObj.getTimeZhi()}
            ];

            document.getElementById('result-area').style.display = 'block';
            const dm = pillars[2].g;
            const mz = pillars[1].z;
            const cmd = calcCommander(lunar, mz);
            const climate = analyzeClimate(dm, mz, pillars);
            const pattern = determinePattern(climate, pillars, dm, mz, cmd);

            renderUI(pattern, cmd, dm, climate, pillars);
            drawChart(pillars);
            document.getElementById('result-area').scrollIntoView({ behavior: 'smooth' });
        } catch (e) { alert("中断：" + e.message); }
    }
</script>
</body>
</html>
