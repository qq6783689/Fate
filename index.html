<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>命运黑盒 Pro Max · 调候辩证版</title>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.12/lunar.min.js"></script>
    <style>
        :root {
            --primary: #ff2e63;      /* 故障红 */
            --accent: #08d9d6;       /* 赛博蓝 */
            --dark: #1a1a2e;         /* 深夜蓝 */
            --card: #16213e;         /* 卡片底 */
            --text: #eaeaea;
            --gold: #f9ed69;         /* 传说金 */
            --border-r: 12px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            background-color: var(--dark); color: var(--text);
            margin: 0; padding: 20px 10px; min-height: 100vh;
            background-image: linear-gradient(rgba(26,26,46,0.95), rgba(26,26,46,0.9)), 
                url('https://images.unsplash.com/photo-1550684848-fac1c5b4e853?auto=format&fit=crop&w=1000&q=80');
            background-size: cover; background-attachment: fixed;
            display: flex; justify-content: center;
        }

        .container { width: 100%; max-width: 680px; padding-bottom: 100px; }

        .header { text-align: center; margin-bottom: 30px; position: relative; }
        .header h1 { 
            font-size: 2.2rem; font-weight: 900; margin: 0; letter-spacing: 2px;
            text-transform: uppercase;
            background: linear-gradient(to right, var(--primary), var(--accent));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(255, 46, 99, 0.4);
        }
        .sys-tag { 
            font-size: 0.7rem; border: 1px solid var(--accent); color: var(--accent);
            padding: 2px 8px; border-radius: 4px; display: inline-block; margin-top: 5px;
            box-shadow: 0 0 10px rgba(8, 217, 214, 0.2);
        }

        .card {
            background: rgba(22, 33, 62, 0.95); border: 1px solid rgba(255,255,255,0.08);
            border-radius: var(--border-r); padding: 20px; margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); backdrop-filter: blur(10px);
            position: relative; overflow: hidden;
        }
        .card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
            background: linear-gradient(to bottom, var(--primary), var(--accent));
        }

        .input-group { margin-bottom: 20px; }
        .label { color: var(--accent); font-size: 0.85rem; margin-bottom: 8px; display: block; font-weight: bold; letter-spacing: 1px; }
        
        .gender-box { display: flex; gap: 15px; }
        .g-btn {
            flex: 1; padding: 12px; text-align: center; border-radius: 8px; background: rgba(0,0,0,0.3);
            border: 1px solid #444; color: #888; cursor: pointer; transition: 0.3s; font-weight: bold;
        }
        .g-btn.active {
            border-color: var(--primary); color: #fff; background: rgba(255, 46, 99, 0.2);
            box-shadow: 0 0 15px rgba(255, 46, 99, 0.3);
        }

        input[type="datetime-local"] {
            width: 100%; padding: 14px; background: rgba(0,0,0,0.3); border: 1px solid #444;
            color: #fff; border-radius: 8px; font-size: 1rem; outline: none; transition: 0.3s;
        }
        input:focus { border-color: var(--accent); }

        .btn-start {
            width: 100%; padding: 16px; border: none; border-radius: 8px;
            background: linear-gradient(135deg, var(--primary), #8000ff);
            color: #fff; font-size: 1.1rem; font-weight: 900; letter-spacing: 2px;
            cursor: pointer; position: relative; overflow: hidden;
            box-shadow: 0 5px 20px rgba(255, 46, 99, 0.4);
        }
        .btn-start:active { transform: scale(0.98); }

        #result-area { display: none; animation: slideUp 0.6s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        .role-header { display: flex; align-items: center; border-bottom: 1px dashed rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 20px; }
        .role-icon {
            width: 64px; height: 64px; background: #0f3460; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; font-size: 32px;
            border: 2px solid var(--gold); box-shadow: 0 0 15px rgba(249, 237, 105, 0.3);
            margin-right: 15px; flex-shrink: 0;
        }
        .role-info h2 { margin: 0 0 5px 0; font-size: 1.4rem; color: #fff; }
        .role-tags { display: flex; flex-wrap: wrap; gap: 6px; }
        .tag { font-size: 0.7rem; padding: 3px 8px; border-radius: 4px; background: rgba(255,255,255,0.1); color: #bbb; }
        .tag.ssr { background: linear-gradient(45deg, var(--primary), var(--gold)); color: #000; font-weight: bold; }
        .tag.logic { border: 1px solid var(--accent); color: var(--accent); background: transparent; }

        .chart-box { height: 180px; width: 100%; border-radius: 8px; overflow: hidden; margin-bottom: 20px; position: relative; border: 1px solid rgba(255,255,255,0.1); }
        canvas { width: 100%; height: 100%; }
        .chart-label { position: absolute; bottom: 5px; right: 8px; font-size: 0.7rem; color: rgba(255,255,255,0.5); }

        .pillars { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .col { background: rgba(255,255,255,0.03); border-radius: 8px; padding: 12px 2px; text-align: center; }
        .col-head { font-size: 0.65rem; color: #666; margin-bottom: 4px; text-transform: uppercase; }
        .col-god { font-size: 0.7rem; color: var(--accent); height: 14px; margin-bottom: 2px; }
        .col-char { font-family: "KaiTi", serif; font-size: 1.8rem; font-weight: bold; line-height: 1.1; }
        .col-cs { font-size: 0.65rem; color: #888; margin-top: 4px; display: block; }
        .cs-strong { color: var(--gold); }

        .wx-金 { color: #ffeaa7; text-shadow: 0 0 5px rgba(255,234,167,0.5); } 
        .wx-木 { color: #55efc4; text-shadow: 0 0 5px rgba(85,239,196,0.5); } 
        .wx-水 { color: #74b9ff; text-shadow: 0 0 5px rgba(116,185,255,0.5); } 
        .wx-火 { color: #ff7675; text-shadow: 0 0 5px rgba(255,118,117,0.5); } 
        .wx-土 { color: #a29bfe; text-shadow: 0 0 5px rgba(162,155,254,0.5); }

        .guide-item { 
            margin-bottom: 20px; padding: 15px; border-radius: 10px; 
            background: rgba(0,0,0,0.2); border-left: 3px solid var(--gray);
        }
        .guide-title { 
            font-size: 0.95rem; font-weight: bold; color: var(--accent); margin-bottom: 8px;
            display: flex; align-items: center; gap: 8px;
        }
        .guide-text { font-size: 0.9rem; line-height: 1.6; color: #ccc; text-align: justify; }
        .guide-text b { color: #fff; font-weight: bold; }

        .core-bar {
            background: linear-gradient(to right, rgba(255, 46, 99, 0.1), transparent);
            border: 1px solid rgba(255, 46, 99, 0.3); padding: 12px; border-radius: 8px;
            margin-top: 20px; font-size: 0.85rem; color: #ffcccb; line-height: 1.5;
        }
        
        .joy-taboo { margin-top: 8px; }
        .jt-tag { margin-right: 10px; font-weight: bold; }
        .jt-joy { color: #2ed573; }
        .jt-bad { color: #ff4757; }

        #error-msg { display:none; background:var(--primary); padding:10px; border-radius:8px; text-align:center; margin-bottom:15px; font-size:12px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>命运黑盒</h1>
        <div class="sys-tag">SYSTEM: PRO MAX · LOGIC V3.0</div>
    </div>

    <div id="error-msg">⚠️ 核心组件加载异常，请检查网络 (jsDelivr)</div>

    <div class="card">
        <div class="input-group">
            <span class="label">选择角色性别 / CHARACTER GENDER</span>
            <div class="gender-box">
                <div class="g-btn active" onclick="setGender(1, this)">乾造 (Male)</div>
                <div class="g-btn" onclick="setGender(0, this)">坤造 (Female)</div>
            </div>
        </div>
        <div class="input-group">
            <span class="label">输入出生时间 / SPAWN DATE</span>
            <input type="datetime-local" id="birth-input">
        </div>
        <button class="btn-start" onclick="startScan()">启动命运扫描 / START SCAN</button>
    </div>

    <div id="result-area">
        <div class="card">
            <div class="role-header">
                <div class="role-icon" id="role-icon">?</div>
                <div class="role-info">
                    <h2 id="role-name">分析中...</h2>
                    <div class="role-tags" id="role-tags"></div>
                    <div style="font-size:0.8rem; color:#888; margin-top:5px; font-style:italic;" id="role-slogan">...</div>
                </div>
            </div>
            
            <div class="chart-box">
                <canvas id="energy-canvas"></canvas>
                <div class="chart-label">ELEMENTAL RADAR</div>
            </div>

            <div class="pillars" id="pillars-box"></div>
            
            <div class="core-bar" id="core-analysis"></div>
        </div>

        <div class="card">
            <span class="label" style="margin-bottom:15px;">天命通关攻略 / STRATEGY GUIDE</span>
            <div id="guide-content"></div>
        </div>

        <div style="text-align:center; font-size:12px; color:#444; margin-top:30px;">
            Destiny Algorithm © 2025 · Climate & Pattern Verified
        </div>
    </div>
</div>

<script>
    let currentGender = 1;

    // ==========================================================
    // 静态数据字典 (全内置，零依赖)
    // ==========================================================
    
    const WUXING_MAP = {
        '甲':'木','乙':'木','丙':'火','丁':'火','戊':'土','己':'土','庚':'金','辛':'金','壬':'水','癸':'水',
        '子':'水','丑':'土','寅':'木','卯':'木','辰':'土','巳':'火','午':'火','未':'土','申':'金','酉':'金','戌':'土','亥':'水'
    };
    const WX_COLOR = { '金':'wx-金', '木':'wx-木', '水':'wx-水', '火':'wx-火', '土':'wx-土' };

    const ZHI_MAIN_QI = {
        '子':'癸', '丑':'己', '寅':'甲', '卯':'乙', '辰':'戊', '巳':'丙', 
        '午':'丁', '未':'己', '申':'庚', '酉':'辛', '戌':'戊', '亥':'壬'
    };

    const HIDDEN_GAN_MAP = {
        '子':['癸'], '丑':['己','癸','辛'], '寅':['甲','丙','戊'], '卯':['乙'], 
        '辰':['戊','乙','癸'], '巳':['丙','戊','庚'], '午':['丁','己'], '未':['己','丁','乙'], 
        '申':['庚','壬','戊'], '酉':['辛'], '戌':['戊','辛','丁'], '亥':['壬','甲']
    };

    const CS_MEANING = {
        "长生": "稳固", "沐浴": "魅力", "冠带": "进取", "临官": "强盛", 
        "帝旺": "巅峰", "衰": "稳重", "病": "敏感", "死": "沉静", 
        "墓": "囤积", "绝": "重生", "胎": "希望", "养": "培育"
    };

    const CHANGSHENG_TABLE = {
        "甲": { "亥":"长生", "子":"沐浴", "丑":"冠带", "寅":"临官", "卯":"帝旺", "辰":"衰", "巳":"病", "午":"死", "未":"墓", "申":"绝", "酉":"胎", "戌":"养" },
        "乙": { "午":"长生", "巳":"沐浴", "辰":"冠带", "卯":"临官", "寅":"帝旺", "丑":"衰", "子":"病", "亥":"死", "戌":"墓", "酉":"绝", "申":"胎", "未":"养" },
        "丙": { "寅":"长生", "卯":"沐浴", "辰":"冠带", "巳":"临官", "午":"帝旺", "未":"衰", "申":"病", "酉":"死", "戌":"墓", "亥":"绝", "子":"胎", "丑":"养" },
        "丁": { "酉":"长生", "申":"沐浴", "未":"冠带", "午":"临官", "巳":"帝旺", "辰":"衰", "卯":"病", "寅":"死", "丑":"墓", "子":"绝", "亥":"胎", "戌":"养" },
        "戊": { "寅":"长生", "卯":"沐浴", "辰":"冠带", "巳":"临官", "午":"帝旺", "未":"衰", "申":"病", "酉":"死", "戌":"墓", "亥":"绝", "子":"胎", "丑":"养" },
        "己": { "酉":"长生", "申":"沐浴", "未":"冠带", "午":"临官", "巳":"帝旺", "辰":"衰", "卯":"病", "寅":"死", "丑":"墓", "子":"绝", "亥":"胎", "戌":"养" },
        "庚": { "巳":"长生", "午":"沐浴", "未":"冠带", "申":"临官", "酉":"帝旺", "戌":"衰", "亥":"病", "子":"死", "丑":"墓", "寅":"绝", "卯":"胎", "辰":"养" },
        "辛": { "子":"长生", "亥":"沐浴", "戌":"冠带", "酉":"临官", "申":"帝旺", "未":"衰", "午":"病", "巳":"死", "辰":"墓", "卯":"绝", "寅":"胎", "丑":"养" },
        "壬": { "申":"长生", "酉":"沐浴", "戌":"冠带", "亥":"临官", "子":"帝旺", "丑":"衰", "寅":"病", "卯":"死", "辰":"墓", "巳":"绝", "午":"胎", "未":"养" },
        "癸": { "卯":"长生", "寅":"沐浴", "丑":"冠带", "子":"临官", "亥":"帝旺", "戌":"衰", "酉":"病", "申":"死", "未":"墓", "午":"绝", "巳":"胎", "辰":"养" }
    };
    const STRONG_CS = ["长生", "帝旺", "临官", "冠带"]; 

    const SHISHEN_MAP = {
        "甲": { "甲":"比肩", "乙":"劫财", "丙":"食神", "丁":"伤官", "戊":"偏财", "己":"正财", "庚":"七杀", "辛":"正官", "壬":"偏印", "癸":"正印" },
        "乙": { "乙":"比肩", "甲":"劫财", "丁":"食神", "丙":"伤官", "己":"偏财", "戊":"正财", "辛":"七杀", "庚":"正官", "癸":"偏印", "壬":"正印" },
        "丙": { "丙":"比肩", "丁":"劫财", "戊":"食神", "己":"伤官", "庚":"偏财", "辛":"正财", "壬":"七杀", "癸":"正官", "甲":"偏印", "乙":"正印" },
        "丁": { "丁":"比肩", "丙":"劫财", "己":"食神", "戊":"伤官", "辛":"偏财", "庚":"正财", "癸":"七杀", "壬":"正官", "乙":"偏印", "甲":"正印" },
        "戊": { "戊":"比肩", "己":"劫财", "庚":"食神", "辛":"伤官", "壬":"偏财", "癸":"正财", "甲":"七杀", "乙":"正官", "丙":"偏印", "丁":"正印" },
        "己": { "己":"比肩", "戊":"劫财", "辛":"食神", "庚":"伤官", "癸":"偏财", "壬":"正财", "乙":"七杀", "甲":"正官", "丁":"偏印", "丙":"正印" },
        "庚": { "庚":"比肩", "辛":"劫财", "壬":"食神", "癸":"伤官", "甲":"偏财", "乙":"正财", "丙":"七杀", "丁":"正官", "戊":"偏印", "己":"正印" },
        "辛": { "辛":"比肩", "庚":"劫财", "癸":"食神", "壬":"伤官", "乙":"偏财", "甲":"正财", "丁":"七杀", "丙":"正官", "己":"偏印", "戊":"正印" },
        "壬": { "壬":"比肩", "癸":"劫财", "甲":"食神", "乙":"伤官", "丙":"偏财", "丁":"正财", "戊":"七杀", "己":"正官", "庚":"偏印", "辛":"正印" },
        "癸": { "癸":"比肩", "壬":"劫财", "乙":"食神", "甲":"伤官", "丁":"偏财", "丙":"正财", "己":"七杀", "戊":"正官", "辛":"偏印", "庚":"正印" }
    };

    const SILING_RULES = {
        '寅': [['戊',7], ['丙',7], ['甲',16]], '卯': [['甲',10], ['乙',20]], '辰': [['乙',9], ['癸',3], ['戊',18]],
        '巳': [['戊',5], ['庚',9], ['丙',16]], '午': [['丙',10], ['己',9], ['丁',11]], '未': [['丁',9], ['乙',3], ['己',18]],
        '申': [['戊',7], ['壬',7], ['庚',16]], '酉': [['庚',10], ['辛',20]], '戌': [['辛',9], ['丁',3], ['戊',18]],
        '亥': [['戊',7], ['甲',5], ['壬',18]], '子': [['壬',10], ['癸',20]], '丑': [['癸',9], ['辛',3], ['己',18]]
    };

    // 核心数据库：格局喜忌规则 (XIJI RULES)
    const XIJI_RULES = {
        "金水伤官": {
            desc: "天寒地冻，金水虽清但无生机。喜火（官杀）暖局，喜木（财）生火。",
            joy: ["火 (官杀·调候)", "木 (财星·助燃)"],
            taboo: ["水 (伤官·加寒)", "土 (印星·埋金)"]
        },
        "木火通明": {
            desc: "春木生火，木火两旺。最忌金（官杀）来克伐，损了秀气。",
            joy: ["火 (食伤·泄秀)", "木 (比劫·助势)"],
            taboo: ["金 (官杀·克战)", "水 (印星·灭火)"]
        },
        "伤官配印": {
            desc: "火炎土燥（夏木），急需水印调候。贵在有印，印星为第一救星。",
            joy: ["水 (印星·润局)", "木 (比劫·护印)"],
            taboo: ["土 (财星·坏印)", "火 (伤官·过旺)", "金 (官杀·犯旺)"]
        },
        "金水伤官": {
            desc: "生于冬月，金寒水冷。必须见火（官杀）暖局。此格是伤官见官不为祸的反例。",
            joy: ["火 (官杀·暖局)", "木 (财星·生火)"],
            taboo: ["水 (伤官·加寒)", "金 (比劫·助冷)", "土 (印星·埋金)"]
        },
        "食神制杀": {
            desc: "七杀攻身，幸有食神制之。喜身强以抗杀，喜食神以制敌。",
            joy: ["食神 (制杀)", "印星 (化杀)", "比劫 (帮身)"],
            taboo: ["财星 (党杀·泄食)", "官杀 (攻身)"]
        },
        "伤官生财": {
            desc: "伤官虽旺，但有财星引通食伤之气，形成流通。只要身不弱，即为富格。",
            joy: ["身弱喜印比", "身强喜食伤财"], 
            taboo: ["身弱忌财官", "身强忌印比"]
        },
        "伤官合杀": {
            desc: "伤官与七杀相合，化干戈为玉帛。喜身旺，喜印绶。",
            joy: ["印星 (生身)", "比劫 (帮身)"],
            taboo: ["财星 (生杀)", "官杀 (混杂)"]
        },
        "伤官格": {
            desc: "伤官当令，泄气太过。若无财无印，则为孤傲清高之士。",
            joy: ["印星 (制伤)", "财星 (引化)"],
            taboo: ["官杀 (克战)", "比劫 (助伤)"]
        },
        "建禄格": {
            desc: "月令建禄，身旺财官有气。喜财官食伤以泄秀，忌印比再来生扶。",
            joy: ["官杀 (护财)", "食伤 (生财)", "财星 (养命)"],
            taboo: ["印星 (过旺)", "比劫 (夺财)"]
        },
        "七杀格": {
            desc: "七杀当权。若身弱，首取印星化杀；若身强，首取食神制杀。",
            joy: ["印星 (化杀生身)", "食伤 (制杀)"],
            taboo: ["财星 (生杀)", "官杀 (攻身)"]
        },
        "正官格": {
            desc: "正官纯正。喜财生官，喜印护官。最怕伤官克官。",
            joy: ["财星 (生官)", "印星 (护官)"],
            taboo: ["伤官 (克官)", "七杀 (混杂)"]
        },
        "正财格": {
            desc: "财星当令。身强能任财，身弱喜印比。",
            joy: ["身强喜官杀食伤", "身弱喜印比"],
            taboo: ["身强忌印比", "身弱忌财官"]
        },
        "偏财格": {
            desc: "偏财当令，慷慨多情。喜官杀护财，喜食伤生财。",
            joy: ["官杀", "食伤", "身弱喜印比"],
            taboo: ["比劫 (夺财)", "空亡"]
        },
        "正印格": {
            desc: "印绶生身。喜官杀生印，忌财星坏印。",
            joy: ["官杀 (生印)", "比劫 (护印)"],
            taboo: ["财星 (坏印)"]
        },
        "偏印格": {
            desc: "偏印当权，多才多艺。喜偏财制枭，忌食神被夺（枭神夺食）。",
            joy: ["偏财 (制枭)", "天月德贵人"],
            taboo: ["食神 (被克)"]
        },
        "食神格": {
            desc: "食神生财，福寿双全。喜财星，忌枭神（偏印）。",
            joy: ["财星 (流通)", "比劫 (生食)"],
            taboo: ["偏印 (夺食)"]
        }
    };

    // 终极文案库
    const GAME_DB = {
        "金水伤官": {
            name: "❄️ 寒冰剑仙 (Frost Blade)", tags: ["SSR", "高冷", "权谋"], icon: "🗡️",
            slogan: "“金寒水冷，唯火暖心。我的剑，只为守护那一点温存。”",
            male: { c:"**[天赋：权谋]**<br>金水伤官人最聪明，但也最傲气。你天生适合从政、管理或高层策划。必须见官（火），见了官就有地位，就有权威。若无火，则只是穷酸秀才。", w:"**[被动：显贵]**<br>你的财运伴随着地位而来。有了权（官）自然有钱。切忌贪污腐败，因为水太清，容易被查。", l:"**[羁绊：暖阳]**<br>你太冷了，需要一个热情如火的伴侣。对方可能是你的上司或崇拜者。", k:"**[传承：严父]**<br>对孩子要求高，孩子多半有出息。", h:"**[Buff：调候]**<br>多晒太阳，多穿红衣。忌去北方。" },
            female: { c:"**[天赋：冰山美人]**<br>才貌双全，气质高冷。适合演艺、外交、高管。必须有火暖局，否则容易孤独终老。", w:"**[被动：夫荣妻贵]**<br>你的官星（火）就是你的夫星，也是你的喜用神。旺夫即旺己。", l:"**[羁绊：喜官]**<br>伤官本克官，但金水伤官独喜官。你非常需要男人的呵护和温暖。千万别作。", k:"**[传承：贵子]**<br>孩子聪明漂亮。", h:"**[Buff：暖宫]**<br>注意妇科寒症，多泡脚。" }
        },
        "木火通明": {
            name: "🔥 薪火传人 (Phoenix)", tags: ["SSR", "文化", "名望"], icon: "🔥",
            slogan: "“木火交辉，光耀千秋。我不是凡火，我是文明的灯塔。”",
            male: { c:"**[天赋：文昌]**<br>木火通明主文才。你适合做学者、教授、作家、艺术家。你的名声比钱更重要。最忌金来砍木，坏了秀气。", w:"**[被动：名利双收]**<br>名气大了，钱自然来。不要为了钱去从政（见官），那会让你很痛苦。", l:"**[羁绊：知音]**<br>你需要一个能读懂你文章、听懂你音乐的灵魂伴侣。", k:"**[传承：书香门第]**<br>孩子多半文质彬彬。", h:"**[Buff：通达]**<br>心血管系统要注意，别熬夜。" },
            female: { c:"**[天赋：才女]**<br>气质出众，才华横溢。适合教育、媒体、设计。你的光芒太耀眼，容易遭人嫉妒。", w:"**[被动：清贵]**<br>不屑于谈钱，但生活品味极高。", l:"**[羁绊：晚婚]**<br>眼光高，普通人入不了眼。且不喜受管束（忌官），适合晚婚。", k:"**[传承：优生]**<br>孩子有艺术天分。", h:"**[Buff：护眼]**<br>注意视力保护。" }
        },
        "伤官配印": {
            name: "🔮 智者神启 (Oracle)", tags: ["UR", "天命级", "智慧"], icon: "📜",
            slogan: "“烈火烹油非长久，深水静流是真理。”",
            male: { c:"**[天赋：降维打击]**<br>你生于特殊季节，本应焦躁，却得贵人（印）润局。你的核心竞争力不是拼命，而是**“智慧与冷静”**。适合学术、咨询、参谋、科研。你是团队的“大脑”，切忌冲动创业。", w:"**[被动：知识付费]**<br>格局铁律：**忌土（财）**。因为财会坏印（药）。你的财运来自名望和知识变现。不要为了赚快钱而丢了底线。", l:"**[羁绊：灵魂伴侣]**<br>伴侣是你的贵人，能让你冷静。不要嫌弃对方沉闷，那是你的救命稻草。", k:"**[传承：书香]**<br>孩子聪明好学，有文化底蕴。", h:"**[Buff：水火既济]**<br>身体底子不错，但注意心火过旺。" },
            female: { c:"**[天赋：才女]**<br>伤官佩印，贵不可言。适合教育、文化、艺术。以柔克刚，以静制动。", w:"**[被动：养财]**<br>你的钱是“养”出来的。适合长线投资，购买保险。远离高风险投机。", l:"**[羁绊：去官就食]**<br>你太聪明了，一般男人驾驭不了。不用强求丈夫多厉害，只要他能包容你、滋养你（水印）就是上等姻缘。", k:"**[传承：灵性]**<br>孩子有灵气，善解人意。", h:"**[Buff：滋阴]**<br>多补水，少熬夜耗阴。" }
        },
        "伤官合杀": { 
            name: "⚡ 危机终结者 (Terminator)", tags: ["SSR", "爆发型", "乱世英雄"], icon: "🗡️",
            slogan: "“混乱是阶梯。当别人在恐惧时，正是我接管战场的时候。”",
            male: { c:"**[天赋：乱世枭雄]**<br>天生自带反骨，不适合呆板体制。主场在<b>危机公关、律师、特种顾问</b>。越是混乱高压环境，越能激发你的S级潜能。", w:"**[被动：掠夺者]**<br>财富不靠积攒，靠<b>“狩猎”</b>。利用信息差或胆识降维打击。爆发力极强。", l:"**[羁绊：相爱相杀]**<br>看不上傻白甜，只有带点刺的女性才能激起征服欲。婚姻是一场高智商博弈。", k:"**[传承：叛逆天才]**<br>孩子遗传了你的高智商和叛逆。别用“听话”扼杀他。", h:"**[Debuff：过载]**<br>大脑常年高速运转，易神经衰弱。注意头部保养。" }, 
            female: { c:"**[天赋：女王气场]**<br>职场铁娘子。你能搞定最难缠的客户，让男人敬畏。武器是犀利的言辞和雷厉风行的手段。", w:"**[被动：名气变现]**<br>名气越大财运越旺。适合经营个人IP。", l:"**[羁绊：慕强心理]**<br>欣赏“爹系”硬汉。婚后你是主心骨，但太强势会让对方有压力。", k:"**[传承：精英教育]**<br>对孩子投入极大，期望极高。", h:"**[Debuff：内耗]**<br>情绪波动大，易导致内分泌失调。" } 
        },
        "食神制杀": { 
            name: "🦁 铁腕驯兽师 (Beast Tamer)", tags: ["SR+", "控制型", "威望"], icon: "🦁",
            slogan: "“愤怒是无用的，只有绝对的力量和规则才能驯服野兽。”",
            male: { c:"**[天赋：不怒自威]**<br>不需要大吼大叫，专业能力足以服众。适合公检法、技术总监。", w:"**[被动：资历加成]**<br>财富是大后期型。资历越老越值钱。靠手艺吃饭，金饭碗最稳。", l:"**[羁绊：一家之主]**<br>家中地位极高，妻子敬重你。责任感爆棚。", k:"**[传承：栋梁之材]**<br>孩子规矩懂事，成绩优异。", h:"**[Debuff：富贵病]**<br>身体底子好，但容易摄入过剩。防三高。" }, 
            female: { c:"**[天赋：逻辑女王]**<br>不屑宫斗，靠硬实力。财务总监、审计。逻辑滴水不漏。", w:"**[被动：CFO]**<br>天生的理财圣手。不仅能赚更能管。对数字敏感。", l:"**[羁绊：严妻良母]**<br>管老公像管孩子，虽然啰嗦但为家好。", k:"**[传承：贴心棉袄]**<br>子女缘分极佳，母慈子孝。", h:"**[Debuff：肠胃敏感]**<br>压力大时易胃痛。注意饮食规律。" } 
        },
        "伤官生财": { 
            name: "💸 炼金术士 (Alchemist)", tags: ["SSR", "智谋系", "高收益"], icon: "⚗️",
            slogan: "“万物皆可交易。给我一个支点，我能把稻草卖成金条。”",
            male: { c:"**[天赋：点石成金]**<br>别打死工！你是创业、创意、营销的天才。脑子是印钞机。", w:"**[被动：现金流]**<br>钱是流动的工具。赚钱快花钱也快。建议及时置换成房产。", l:"**[羁绊：颜控]**<br>喜欢漂亮时尚的伴侣。但脾气急躁，容易忽略对方感受。", k:"**[传承：自由灵魂]**<br>子女早早出国或去外地。彼此独立。", h:"**[Debuff：烧脑]**<br>思虑过重，易失眠脱发。睡前强制关机。" }, 
            female: { c:"**[天赋：超级带货]**<br>才华横溢，自媒体、主播。表达能力是核武器。", w:"**[被动：购物狂]**<br>赚钱是能力证明，花钱是解压方式。必须强制储蓄。", l:"**[羁绊：挑剔眼光]**<br>嫌弃老公穷笨。建议找成熟稳重的“大叔型”伴侣。", k:"**[传承：溺爱]**<br>孩子是软肋也是动力。别宠坏了。", h:"**[Debuff：气郁]**<br>注意甲状腺乳腺。多去旅游换环境。" } 
        },
        "伤官格": {
            name: "🎭 孤傲艺术家 (Maverick)", tags: ["SR", "创造型", "自由"], icon: "🎭",
            slogan: "“我不是为了迎合世界而生，我是为了改变它。”",
            male: { c:"**[天赋：创新]**<br>传统的规则束缚不了你。适合设计、艺术、自由职业。你的才华需要自由的土壤。", w:"**[被动：技能变现]**<br>不喜求人，靠真本事吃饭。财运不稳定，但爆发力强。", l:"**[羁绊：不羁]**<br>婚姻对你来说是束缚。晚婚或不婚的概率较高。", k:"**[传承：代沟]**<br>与孩子像朋友，但不像父子。", h:"**[Debuff：敏感]**<br>情绪化严重，注意心理健康。" },
            female: { c:"**[天赋：灵气]**<br>极具艺术天分。适合演艺、写作。受不了朝九晚五。", w:"**[被动：随性]**<br>开心就赚，不开心就躺。对金钱看得不重。", l:"**[羁绊：克夫]**<br>伤官太旺，对伴侣挑剔。需要找宽容度极高的人。", k:"**[传承：依赖]**<br>孩子是你的一切。", h:"**[Debuff：郁结]**<br>多运动，释放多余的能量。" }
        },
        "正官格": {
            name: "⚖️ 秩序守护者 (Guardian)", tags: ["SR", "稳健型", "官运"], icon: "🏛️",
            slogan: "“规则是世界的基石。按部就班，才是通往顶峰的捷径。”",
            male: { c:"**[天赋：仕途通达]**<br>天生吃皇粮。适合体制内、大厂管理层。稳重讲规矩，晋升之路虽慢但稳。", w:"**[被动：正财稳]**<br>薪水高福利好。别碰高风险投资，老实拿工资买房收租最适合你。", l:"**[羁绊：门当户对]**<br>妻子贤惠，家庭观念重。婚姻是你的避风港。", k:"**[传承：学霸苗子]**<br>孩子听话懂事，能继承你的优良家风。", h:"**[Debuff：隐形压力]**<br>压力藏心里，易导致胃病或脱发。" },
            female: { c:"**[天赋：完美管家]**<br>行政、HR、高管助理。做事井井有条，从不出错，老板最放心。", w:"**[被动：财政部长]**<br>善于持家，积少成多。家底在你手里越攒越厚。", l:"**[羁绊：旺夫体质]**<br>你是丈夫坚强的后盾。婚姻通常令人羡慕。", k:"**[传承：教子有方]**<br>注重品德培养，孩子有教养懂礼貌。", h:"**[Debuff：久坐伤身]**<br>注意颈椎腰椎问题。" }
        },
        "七杀格": {
            name: "🚀 孤胆英雄 (Solo Hero)", tags: ["SSR", "进攻型", "开创"], icon: "🔥",
            slogan: "“要么忍，要么狠，要么滚。人生就是一场无限的战斗。”",
            male: { c:"**[天赋：开疆拓土]**<br>天生的创业者或销售冠军。平淡工作会让你发疯，只有挑战才能激发潜能。", w:"**[被动：险中求财]**<br>大起大落是常态。敢梭哈，有机会暴富。赚到钱必须强制买固定资产留后路。", l:"**[羁绊：烈火情人]**<br>脾气爆，喜欢性感的女性。家里经常上演全武行，但床头吵架床尾和。", k:"**[传承：棍棒教育]**<br>对孩子太严厉。多展现温柔一面，孩子其实渴望父爱。", h:"**[Debuff：战损]**<br>易有外伤疤痕。开车慢点，少喝酒。" },
            female: { c:"**[天赋：不让须眉]**<br>女老板、业务一姐。在男人堆里抢饭吃毫无惧色。执行力超强。", w:"**[被动：流水大]**<br>赚钱机器，花钱如流水。需要懂理财的伙伴帮你打理。", l:"**[羁绊：霸总收割机]**<br>容易吸引霸道总裁或渣男。感情像过山车一样刺激。", k:"**[传承：超人妈妈]**<br>既当爹又当妈，孩子是你坚持下去的最大动力。", h:"**[Debuff：肝火旺]**<br>少生气，生气长结节。多做冥想。" }
        },
        "正印格": {
            name: "📜 圣贤导师 (The Sage)", tags: ["SR", "辅助型", "名望"], icon: "🙏",
            slogan: "“但行好事，莫问前程。智慧比财富更持久。”",
            male: { c:"**[天赋：贵人扶持]**<br>适合文教、慈善、出版。上面有人罩，晋升不用愁。工作清闲福利好。", w:"**[被动：清贵之财]**<br>名声换钱。不适合做生意，易心软被骗。靠社会地位获利。", l:"**[羁绊：依赖型]**<br>有点妈宝倾向，喜欢成熟会照顾人的女性。婚姻平顺。", k:"**[传承：知书达理]**<br>家庭传统氛围浓，孩子孝顺。", h:"**[Debuff：懒惰]**<br>心宽体胖，易缺乏运动。注意三高。" },
            female: { c:"**[天赋：岁月静好]**<br>老师、图书管理员。无野心，不喜竞争。追求安稳舒适。", w:"**[被动：不缺钱]**<br>长辈给的多，老公给的多。一生有人为你买单。", l:"**[羁绊：受宠]**<br>嫁得好，一生被照顾。像温室里的花朵。", k:"**[传承：佛系育儿]**<br>顺其自然，孩子性格温和。", h:"**[Debuff：湿气重]**<br>太安逸导致代谢慢。多运动排湿。" }
        },
        "偏印格": {
            name: "👽 异次元行者 (Mystic)", tags: ["SR", "特殊系", "直觉"], icon: "👁️",
            slogan: "“真理往往掌握在少数人手中。我看世界的方式，与你不同。”",
            male: { c:"**[天赋：独门绝技]**<br>医生、程序员、玄学师。靠偏门冷门技术吃饭。思维独特，能看透本质。", w:"**[被动：副业王]**<br>收入不稳定但常有大笔进账。直觉准，靠第六感投资也能赚。", l:"**[羁绊：冰山]**<br>感情冷淡，不善表达。需要能读懂你沉默的伴侣。", k:"**[传承：代沟]**<br>孩子独立早早离家。教育方式另类。", h:"**[Debuff：孤独感]**<br>易抑郁，多晒太阳。养宠物陪伴。" },
            female: { c:"**[天赋：洞察力]**<br>设计、咨询、心理医生。能轻易看穿谎言。适合独立工作。", w:"**[被动：才华变现]**<br>不屑赚辛苦钱。眼光独到，能发现潜力股。", l:"**[羁绊：边缘恋]**<br>易遇性格古怪对象或异地恋。感情坎坷，太敏感易受伤。", k:"**[传承：丁克倾向]**<br>觉得孩子是负担，但有了会很爱。", h:"**[Debuff：神经痛]**<br>神经衰弱，偏头痛。睡前泡脚放松。" }
        },
        "正财格": {
            name: "🐜 勤勉筑梦师 (Builder)", tags: ["R+", "发育型", "积累"], icon: "🧱",
            slogan: "“一砖一瓦，聚沙成塔。我不信运气，我只信复利。”",
            male: { c:"**[天赋：实干家]**<br>金融、实业。勤劳致富典范，不信一夜暴富。相信努力就有回报。", w:"**[被动：复利]**<br>典型的富一代。积少成多，晚年富足。每一分钱都是汗水换来的。", l:"**[羁绊：宠妻狂魔]**<br>工资上交，老婆掌权。觉得听老婆话才会有出息。", k:"**[传承：朴实]**<br>子女规矩，继承勤劳家风。", h:"**[Debuff：劳损]**<br>过度劳累，职业病。注意休息。" },
            female: { c:"**[天赋：精细化]**<br>会计、银行。工作细致，对细节把控无人能及。", w:"**[被动：存钱罐]**<br>精打细算，看着余额增长最快乐。砍价高手。", l:"**[羁绊：贤惠]**<br>把家打理井井有条。生活略平淡，需制造浪漫。", k:"**[传承：包办]**<br>照顾无微不至，导致孩子自理能力弱。学会放手。", h:"**[Debuff：气血虚]**<br>有点宅，不爱动。多吃红枣枸杞。" }
        },
        "偏财格": {
            name: "🎩 商业大亨 (Tycoon)", tags: ["SSR", "交际系", "横财"], icon: "💎",
            slogan: "“钱是赚出来的，不是省出来的。朋友多了路好走。”",
            male: { c:"**[天赋：资源整合]**<br>经商、市场。善交际，四海皆兄弟。眼光独到，发现别人忽略的商机。", w:"**[被动：横财运]**<br>易中奖或投资获利。但也手松，财来财去。赚了钱马上买房。", l:"**[羁绊：桃花劫]**<br>风趣幽默，出手大方，太讨女人喜欢。需防后院起火。", k:"**[传承：哥们]**<br>跟孩子像朋友。看重情商培养。", h:"**[Debuff：酒局伤身]**<br>应酬多，伤肝肾。少喝酒多喝茶。" },
            female: { c:"**[天赋：长袖善舞]**<br>商务、公关。名利场游刃有余。赚钱能力不输男人。", w:"**[被动：奢靡]**<br>能赚会花，喜欢奢侈品。财运比老公好，经常贴补家用。", l:"**[羁绊：择优]**<br>喜欢有钱有势的男人。婚姻晚成，一直在筛选绩优股。", k:"**[传承：贵族范]**<br>给孩子最好条件，培养贵族气质。", h:"**[Debuff：三高]**<br>注意富贵病，少吃油腻。" }
        },
        "食神格": {
            name: "🎨 逍遥散人 (Artist)", tags: ["SR", "治愈系", "福气"], icon: "🎐",
            slogan: "“人间不值得，但美食值得。快乐才是人生的终极意义。”",
            male: { c:"**[天赋：灵感源泉]**<br>艺术、餐饮、设计。才华横溢但不爱卷。灵感在玩乐中产生。", w:"**[被动：躺赢]**<br>细水长流，一辈子不缺钱。总有贵人送钱，傻人有傻福。", l:"**[羁绊：暖男]**<br>懂疼老婆，会做饭。婚姻生活平淡温馨，令人羡慕。", k:"**[传承：福星]**<br>晚年享子女福，孩子性格讨喜。", h:"**[Debuff：肥胖]**<br>心宽体胖，贪吃导致三高。动起来！" },
            female: { c:"**[天赋：亲和力]**<br>幼师、美食博主。不争不抢，人缘极好。工作环境单纯。", w:"**[被动：小确幸]**<br>不计较钱，钱反而来找你。有不少私房钱。", l:"**[羁绊：仪式感]**<br>有点作，注重浪漫。希望对方懂你的情趣。", k:"**[传承：慈母]**<br>孩子是命根子，极其宠爱。孩子幸福感强。", h:"**[Debuff：亚健康]**<br>太懒了，缺乏运动。多去户外走走。" }
        },
        "建禄格": {
            name: "🏰 独立领主 (Lord)", tags: ["SR", "坦克型", "自立"], icon: "🗿",
            slogan: "“求人不如求己。我的领土，我说了算。”",
            male: { c:"**[天赋：中流砥柱]**<br>事必躬亲，闲不下来。技术总监、合伙人。适合带队冲锋。", w:"**[被动：血汗钱]**<br>每一分都是汗水。身旺任财，中晚年大富。但也容易被劫财。", l:"**[羁绊：大男人]**<br>易克妻。需找温柔听话的老婆。", k:"**[传承：放养]**<br>孩子独立，将来可能不在身边。", h:"**[Debuff：过劳]**<br>身体壮如牛，但易透支。" }, 
            female: { c:"**[天赋：不靠男人]**<br>比男人还拼。创业或高管。不喜欢依赖别人。", w:"**[被动：漏斗]**<br>赚钱猛守财难。易被借钱不还。需找人打理。", l:"**[羁绊：强势]**<br>易遇第三者或老公弱。太强势让男人有压力，学会示弱。", k:"**[传承：健康]**<br>利生育，孩子活泼适应力强。", h:"**[Debuff：上火]**<br>火气大，注意甲状腺。少吃辛辣。" }
        },
        "五行流通": { 
            name: "☯️ 太极宗师 (Grandmaster)", tags: ["SSR", "全能型", "反脆弱"], icon: "🧘",
            slogan: "“刚不可久，柔不可守。万物负阴而抱阳，冲气以为和。”",
            male: { 
                c:"**[天赋：六边形战士]**<br>你没有短板，是天生的**“版本之子”**。职场中的万金油，适合综合管理、统筹、协调。你像水一样适应任何容器。在动荡的经济周期中，别人在裸泳，而你能稳坐钓鱼台。你的生存能力S级。", 
                w:"**[被动：稳如泰山]**<br>虽然没有一夜暴富的剧本，但也没有破产的风险。你的财富像滚雪球，抗风险能力极强。你是朋友圈里最“稳”的那个隐形富豪。", 
                l:"**[羁绊：细水长流]**<br>你的婚姻没有狗血剧，只有温馨的日常。你是最适合过日子的伴侣，能提供极高的情绪价值和安全感。", 
                k:"**[传承：孝顺]**<br>孩子身心健康，三观正。虽未必惊天动地，但能陪在你身边尽孝，这是最大的福气。", 
                h:"**[Buff：长寿]**<br>五行流通，百病不生。只要不作死，你大概率能活过99%的同龄人。" 
            }, 
            female: { 
                c:"**[天赋：以柔克刚]**<br>文员、后勤、体制内。你不求大富大贵，只求工作顺心。你的心态是你最大的财富，让你在任何环境中都能游刃有余。", 
                w:"**[被动：无忧]**<br>不缺零花钱，总有父母或丈夫为你提供物质保障。生活滋润，岁月静好。你是天生的“福将”。", 
                l:"**[羁绊：贤内助]**<br>家庭和睦，你是家里的调味剂。懂得经营生活，把家变得温馨舒适，旺夫旺家。", 
                k:"**[传承：陪伴]**<br>花很多时间陪孩子，亲子关系极佳。孩子性格好，情商高。", 
                h:"**[Buff：养生]**<br>没啥大毛病，很会照顾自己。懂得以食补身，容颜不老。" 
            } 
        }
    };

    // --- 初始化 ---

    window.onload = function() {
        try {
            const now = new Date();
            const pad = (n) => n < 10 ? '0'+n : n;
            const str = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
            document.getElementById('birth-input').value = str;
        } catch(e) {}
        
        if (typeof Solar === 'undefined') {
            document.getElementById('error-msg').style.display = 'block';
        }
    };

    function setGender(val, el) {
        currentGender = val;
        document.querySelectorAll('.g-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
    }

    // --- 主逻辑 ---
    
    function startScan() {
        const timeStr = document.getElementById('birth-input').value;
        if (!timeStr) return alert("请选择出生时间");

        try {
            const date = new Date(timeStr);
            const solar = Solar.fromYmdHms(date.getFullYear(), date.getMonth()+1, date.getDate(), date.getHours(), date.getMinutes(), date.getSeconds());
            const lunar = solar.getLunar();
            const bazi = lunar.getEightChar();
            bazi.setSect(2); 

            // 1. 数据准备
            const yg = bazi.getYearGan().toString();  const yz = bazi.getYearZhi().toString();
            const mg = bazi.getMonthGan().toString(); const mz = bazi.getMonthZhi().toString();
            const dg = bazi.getDayGan().toString();   const dz = bazi.getDayZhi().toString();
            const hg = bazi.getTimeGan().toString();  const hz = bazi.getTimeZhi().toString();

            const pillars = [
                { t:'年柱 (ROOT)', g:yg, z:yz },
                { t:'月柱 (CAREER)', g:mg, z:mz },
                { t:'日柱 (SELF)', g:dg, z:dz },
                { t:'时柱 (OUTCOME)', g:hg, z:hz }
            ];

            // 2. 渲染
            renderPillars(pillars, dg);
            const cmdInfo = calcCommander(lunar, mz);
            const strengthInfo = analyzeGlobalStrength(cmdInfo, dg, mz, dz, hz);
            
            // 3. 核心：调候与格局
            const climate = analyzeClimate(dg, mz, pillars);
            
            // 4. 绘图
            drawArt(pillars, mz);
            
            // 5. 核心渲染：传入所有分析结果，由 renderGamePattern 统一调度喜忌和文案
            renderGamePattern(climate, strengthInfo, pillars, dg, mz);

            const resArea = document.getElementById('result-area');
            resArea.style.display = 'block';
            resArea.scrollIntoView({ behavior: 'smooth' });

        } catch (e) {
            console.error(e);
            alert("系统过载，请重试！" + e.message);
        }
    }

    function renderPillars(pillars, dayMaster) {
        let html = '';
        pillars.forEach(p => {
            const god = p.t.includes('日柱') ? '日主 (Me)' : (SHISHEN_MAP[dayMaster][p.g] || "");
            const cs = CHANGSHENG_TABLE[p.g][p.z] || "";
            const csClass = STRONG_CS.includes(cs) ? 'cs-strong' : '';
            const gWx = WUXING_MAP[p.g];
            const zWx = WUXING_MAP[p.z];

            html += `
                <div class="col">
                    <div class="c-head">${p.t}</div>
                    <div class="c-god">${god}</div>
                    <div class="c-char ${WX_COLOR[gWx]}">${p.g}</div>
                    <div class="c-char ${WX_COLOR[zWx]}">${p.z}</div>
                    <span class="c-cs ${csClass}">${cs}</span>
                </div>
            `;
        });
        document.getElementById('pillars-box').innerHTML = html;
    }

    // 手动计算司令
    function calcCommander(lunar, monthZhi) {
        const prevJie = lunar.getPrevJie();
        const pjSolar = prevJie.getSolar();
        const jieTime = new Date(pjSolar.getYear(), pjSolar.getMonth()-1, pjSolar.getDay(), pjSolar.getHour(), pjSolar.getMinute(), pjSolar.getSecond()).getTime();
        const bSolar = lunar.getSolar();
        const birthTime = new Date(bSolar.getYear(), bSolar.getMonth()-1, bSolar.getDay(), bSolar.getHour(), bSolar.getMinute(), bSolar.getSecond()).getTime();
        const diffDays = Math.floor((birthTime - jieTime) / (1000 * 60 * 60 * 24));
        
        const rules = SILING_RULES[monthZhi] || [];
        let commander = '未知';
        let daysSum = 0;
        for (let rule of rules) {
            daysSum += rule[1];
            if (diffDays < daysSum) {
                commander = rule[0];
                break;
            }
        }
        if (commander === '未知' && rules.length > 0) commander = rules[rules.length-1][0];
        return { commander, diffDays, prevJieName: prevJie.getName() };
    }

    function analyzeGlobalStrength(info, dm, mZ, dZ, hZ) {
        const dmWx = WUXING_MAP[dm];
        const mZWx = WUXING_MAP[mZ];
        const cmdWx = WUXING_MAP[info.commander];

        const isHelp = (tWx, sWx) => tWx===sWx || (tWx==="木"&&sWx==="火") || (tWx==="火"&&sWx==="土") || (tWx==="土"&&sWx==="金") || (tWx==="金"&&sWx==="水") || (tWx==="水"&&sWx==="木");
        const menWang = isHelp(mZWx, dmWx);
        const diWang = isHelp(cmdWx, dmWx);
        
        const dayCs = CHANGSHENG_TABLE[dm][dZ];
        const dayRootStrong = ["临官", "帝旺", "长生"].includes(dayCs);
        const hourCs = CHANGSHENG_TABLE[dm][hZ];
        const hourRootStrong = ["临官", "帝旺"].includes(hourCs);

        let finalStrong = false;
        let desc = "";

        if (dayRootStrong && hourRootStrong) { finalStrong = true; desc = "日时扎根极深（专禄/归禄），无视月令衰弱，直断身强。"; }
        else if (menWang && diWang) { finalStrong = true; desc = "得令得气，月令提纲有力，身强。"; }
        else if (menWang && !diWang) {
            if (dayRootStrong) { finalStrong = true; desc = "虽真神失令，但得月体且日坐强根，判身强。"; }
            else { finalStrong = false; desc = "门旺地衰，日无强根，外强中干，判身弱。"; }
        } else if (!menWang && diWang) {
            if (dayRootStrong) { finalStrong = true; desc = "虽失月令，但真神相助且日坐强根，绝处逢生，判身强。"; }
            else { finalStrong = false; desc = "虽真神得用，但全局克泄较重，判身弱喜生扶。"; }
        } else {
            if (dayRootStrong && ["冠带","临官"].includes(hourCs)) { finalStrong = true; desc = "虽生于衰月，但日时禄旺通根，判身强。"; }
            else { finalStrong = false; desc = "门地俱衰，根气不足，真身弱。"; }
        }
        return { isStrong: finalStrong, desc, dmWx };
    }

    function analyzeClimate(dm, mz, pillars) {
        const dmWx = WUXING_MAP[dm];
        const season = ["亥","子","丑"].includes(mz) ? "冬" : ["巳","午","未"].includes(mz) ? "夏" : "平";
        let report = { isHot: season === "夏", isCold: season === "冬", hasWater: false, hasFire: false, specialPattern: null };

        pillars.forEach(p => {
            if (WUXING_MAP[p.g] === '水' || WUXING_MAP[p.z] === '水') report.hasWater = true;
            if (WUXING_MAP[p.g] === '火' || WUXING_MAP[p.z] === '火') report.hasFire = true;
        });

        // 天时调候格局判定 (第一优先级)
        // 1. 金水伤官 (金生冬月)
        if (dmWx === '金' && report.isCold) {
            report.specialPattern = "金水伤官";
        }
        // 2. 木火通明 (木生春月)
        else if (dmWx === '木' && ["寅","卯"].includes(mz) && report.hasFire) {
            report.specialPattern = "木火通明";
        }
        // 3. 伤官配印 (木生夏月，急需水)
        else if (dmWx === '木' && report.isHot && report.hasWater) {
            report.specialPattern = "伤官配印";
        }
        
        return report;
    }

    function drawArt(pillars, mZ) {
        const canvas = document.getElementById('energy-canvas');
        const ctx = canvas.getContext('2d');
        const w = canvas.parentElement.offsetWidth;
        const h = canvas.parentElement.offsetHeight;
        canvas.width = w; canvas.height = h;

        const counts = {'金':0,'木':0,'水':0,'火':0,'土':0};
        pillars.forEach(p => { counts[WUXING_MAP[p.g]]++; counts[WUXING_MAP[p.z]]++; });
        
        ctx.fillStyle = "#16213e"; ctx.fillRect(0,0,w,h);
        const colors = {"金":"#ffeaa7", "木":"#55efc4", "水":"#74b9ff", "火":"#ff7675", "土":"#a29bfe"};
        
        const centerX = w/2; const centerY = h/2 + 5; const radius = 55;
        const keys = Object.keys(counts); const total = 8;
        
        ctx.strokeStyle = "#333"; ctx.lineWidth = 1;
        for(let r=1; r<=3; r++) {
            ctx.beginPath();
            for(let i=0; i<5; i++) {
                const angle = (Math.PI*2/5)*i - Math.PI/2;
                const x = centerX + Math.cos(angle)*radius*(r/3);
                const y = centerY + Math.sin(angle)*radius*(r/3);
                if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            }
            ctx.closePath(); ctx.stroke();
        }

        ctx.fillStyle = "rgba(8, 217, 214, 0.3)"; ctx.strokeStyle = "#08d9d6"; ctx.lineWidth = 2;
        ctx.beginPath();
        keys.forEach((k, i) => {
            const val = counts[k];
            const angle = (Math.PI*2/5)*i - Math.PI/2;
            const len = (val / total) * radius * 3.5;
            const x = centerX + Math.cos(angle)*len;
            const y = centerY + Math.sin(angle)*len;
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            
            ctx.fillStyle = colors[k]; ctx.font = "bold 12px Arial";
            const tx = centerX + Math.cos(angle)*(radius+20);
            const ty = centerY + Math.sin(angle)*(radius+10);
            ctx.fillText(k + val, tx-6, ty+4);
        });
        ctx.closePath(); ctx.fill(); ctx.stroke();
    }

    function renderGamePattern(climate, strengthInfo, pillars, dm, mz) {
        const godMap = {}; 
        const positions = ['年干', '月干', '日干', '时干'];
        const gans = [pillars[0].g, pillars[1].g, pillars[2].g, pillars[3].g];
        gans.forEach((g, i) => { if(i === 2) return; godMap[positions[i]] = SHISHEN_MAP[dm][g]; });

        let key = "";
        let origin = "";

        // 1. 优先采用调候特殊格局
        if (climate.specialPattern) {
            key = climate.specialPattern;
            origin = "[天时调候]";
        } 
        else {
            // 2. 严谨格局判定 (相邻检测)
            const hasSha = Object.values(godMap).includes("七杀");
            if (hasSha) {
                const mGod = godMap['月干']; const yGod = godMap['年干']; const hGod = godMap['时干'];
                let isControlled = false;
                if (mGod === "七杀" && (yGod === "食神" || hGod === "食神")) isControlled = true;
                if (yGod === "七杀" && mGod === "食神") isControlled = true;
                if (hGod === "七杀" && mGod === "食神") isControlled = true;

                if (isControlled) { key = "食神制杀"; origin = "[组合成格]"; }
                else if (Object.values(godMap).includes("伤官")) { key = "伤官合杀"; origin = "[组合成格]"; }
                else { key = "七杀格"; origin = "[十神主导]"; }
            }
            else if (Object.values(godMap).includes("伤官")) {
                const mGod = godMap['月干']; const yGod = godMap['年干']; const hGod = godMap['时干'];
                let isShengCai = false;
                if (mGod === "伤官" && (["正财","偏财"].includes(yGod) || ["正财","偏财"].includes(hGod))) isShengCai = true;
                if (["正财","偏财"].includes(mGod) && (yGod === "伤官" || hGod === "伤官")) isShengCai = true;

                if (isShengCai) { key = "伤官生财"; origin = "[组合成格]"; }
                else { key = "伤官格"; origin = "[十神主导]"; } // 单纯伤官格
            }

            // 3. 透干取格 (正八格逻辑)
            if (!key) {
                // 获取月令藏干
                const hiddenGans = HIDDEN_GAN_MAP[mz]; 
                const stems = [pillars[0].g, pillars[1].g, pillars[3].g]; 
                
                let patternGan = "";
                // 优先取透出之干
                for (let gan of hiddenGans) {
                    if (stems.includes(gan)) {
                        patternGan = gan;
                        break;
                    }
                }
                // 若都不透，取本气
                if (!patternGan) patternGan = hiddenGans[0];

                const mainGod = SHISHEN_MAP[dm][patternGan];
                
                const patternMap = {
                    "比肩": "建禄格", "劫财": "月劫格", "食神": "食神格", 
                    "伤官": "伤官格", "正财": "正财格", "偏财": "偏财格", 
                    "正官": "正官格", "七杀": "七杀格", "正印": "正印格", "偏印": "偏印格"
                };
                
                if (patternMap[mainGod]) {
                    key = patternMap[mainGod];
                    origin = `[月令透干: ${patternGan}]`;
                }
            }
        }

        if(!GAME_DB[key]) key = "五行流通";

        // 渲染 UI
        const data = GAME_DB[key];
        const genderKey = currentGender === 1 ? 'male' : 'female';
        const detail = data[genderKey];

        document.getElementById('role-icon').innerText = data.icon;
        document.getElementById('role-name').innerText = data.name;
        document.getElementById('role-slogan').innerText = data.slogan;
        
        let tagsHtml = `<span class="tag logic">${origin}</span>`;
        data.tags.forEach(t => tagsHtml += `<span class="tag ${t==='UR'||t==='SSR'?'ssr':''}">${t}</span>`);
        document.getElementById('role-tags').innerHTML = tagsHtml;

        // 喜忌查询 (使用格局专属规则)
        let xijiData = XIJI_RULES[key];
        // 如果没有特定规则，使用强弱兜底
        if (!xijiData) {
            if (strengthInfo.isStrong) xijiData = { desc: "日主身强，喜克泄耗。", joy:["财星","官杀","食伤"], taboo:["印星","比劫"] };
            else xijiData = { desc: "日主身弱，喜生扶。", joy:["印星","比劫"], taboo:["财星","官杀","食伤"] };
        }

        document.getElementById('pattern-reason').innerText = xijiData.desc;
        
        let joyHtml = "";
        xijiData.joy.forEach(j => joyHtml += `<span style="margin-right:10px;">${j}</span>`);
        document.getElementById('txt-joy').innerHTML = joyHtml;

        let tabooHtml = "";
        xijiData.taboo.forEach(t => tabooHtml += `<span style="margin-right:10px;">${t}</span>`);
        document.getElementById('txt-taboo').innerHTML = tabooHtml;

        const guideHtml = `
            <div class="guide-item">
                <div class="guide-title">⚔️ 事业与成就</div>
                <div class="guide-text">${detail.c}</div>
            </div>
            <div class="guide-item">
                <div class="guide-title">💰 财富与资产</div>
                <div class="guide-text">${detail.w}</div>
            </div>
            <div class="guide-item">
                <div class="guide-title">💞 情感与婚姻</div>
                <div class="guide-text">${detail.l}</div>
            </div>
            <div class="guide-item">
                <div class="guide-title">🌱 后代与传承</div>
                <div class="guide-text">${detail.k}</div>
            </div>
            <div class="guide-item">
                <div class="guide-title">❤️ 健康与状态</div>
                <div class="guide-text">${detail.h}</div>
            </div>
        `;
        document.getElementById('guide-content').innerHTML = guideHtml;
    }

</script>
</body>
</html>
