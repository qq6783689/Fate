<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é™ç”Ÿé‘‘å®š Â· å®—å¸ˆæ ¼å±€è°ƒå€™ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.12/lunar.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@400;700&display=swap');

        :root {
            --china-red: #a22d29;      /* æœ±ç ‚æš–çº¢ */
            --paper-cream: #f4f1de;    /* å®£çº¸æ·¡é»„ */
            --ink-black: #1a1a1a;      /* æµ“å¢¨ */
            --gold-accent: #b8860b;    /* æé‡‘ */
            --status-joy: #2d6a4f;
            --status-taboo: #bc4749;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Noto Serif SC', serif;
            background-color: #edeae0;
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            color: var(--ink-black); margin: 0; padding: 20px 10px; min-height: 100vh;
            display: flex; justify-content: center;
        }

        .container { width: 100%; max-width: 750px; }

        /* é¡¶éƒ¨æ ‡é¢˜ */
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 { 
            font-family: 'Ma Shan Zheng', cursive; font-size: 3.5rem; margin: 0; color: var(--china-red);
            line-height: 1.2; display: inline-block; position: relative;
        }
        .header h1::after {
            content: 'é‘‘å®š'; position: absolute; right: -55px; top: 10px;
            font-size: 0.9rem; background: var(--china-red); color: #fff;
            padding: 4px 6px; border-radius: 2px; line-height: 1; font-family: sans-serif;
        }
        .sys-badge { 
            font-size: 0.8rem; color: var(--china-red); border: 1px solid var(--china-red);
            padding: 2px 15px; margin-top: 15px; display: inline-block; letter-spacing: 2px;
        }

        /* å›½é£å¡ç‰‡ */
        .card {
            background: #fff; border: 1px solid #d8c3a5; padding: 30px; margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.05); position: relative;
        }
        .card::before {
            content: ''; position: absolute; top: 8px; left: 8px; right: 8px; bottom: 8px;
            border: 1px solid #eee; pointer-events: none;
        }

        .label { 
            color: var(--china-red); font-size: 1rem; margin-bottom: 15px; 
            display: block; font-weight: bold; border-left: 4px solid var(--china-red);
            padding-left: 12px;
        }
        
        .gender-box { display: flex; gap: 15px; margin-bottom: 25px; }
        .g-btn {
            flex: 1; padding: 16px; text-align: center; border: 1px solid #d8c3a5;
            background: #fff; color: #666; cursor: pointer; transition: 0.3s; font-weight: bold;
        }
        .g-btn.active { border-color: var(--china-red); color: var(--china-red); background: rgba(162, 45, 41, 0.05); }

        input[type="datetime-local"] {
            width: 100%; padding: 18px; background: #fafafa; border: 1px solid #d8c3a5;
            color: var(--ink-black); font-size: 1.1rem; outline: none; font-family: serif;
        }

        .btn-start {
            width: 100%; padding: 22px; border: none; background: var(--china-red);
            color: #fff; font-size: 1.4rem; font-weight: 900; letter-spacing: 10px;
            cursor: pointer; margin-top: 25px; box-shadow: 0 10px 25px rgba(162, 45, 41, 0.3);
        }

        #result-area { display: none; }

        /* é‰´å®šæŠ¥å‘Šæ ·å¼ */
        .role-header { text-align: center; margin-bottom: 40px; }
        .role-icon { font-size: 4.5rem; display: block; margin-bottom: 15px; }
        .role-title { font-family: 'Ma Shan Zheng', cursive; font-size: 3rem; color: var(--china-red); margin: 0; }
        .role-tags { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
        .tag { font-size: 0.8rem; padding: 5px 15px; border: 1px solid var(--china-red); color: var(--china-red); font-weight: bold; }
        .tag.ssr { background: var(--china-red); color: #fff; }

        /* è°ƒå€™æ¿€æ´»åŒº */
        .climate-box {
            background: rgba(162, 45, 41, 0.05); border: 2px dashed var(--china-red);
            padding: 20px; margin-bottom: 30px; text-align: center; border-radius: 8px;
        }
        .climate-title { color: var(--china-red); font-weight: 900; font-size: 1.2rem; display: block; margin-bottom: 8px; }
        .climate-desc { font-size: 1.05rem; color: #333; line-height: 1.6; }

        .siling-bar {
            text-align: center; border-top: 1px solid #f0f0f0; border-bottom: 1px solid #f0f0f0;
            padding: 18px 0; margin: 30px 0; font-weight: bold; color: var(--china-red); font-size: 1.1rem;
        }

        /* æ’ç›˜ç«–æ¿ */
        .pillars { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 45px; }
        .ofuda { 
            background: #fff; border: 1px solid var(--china-red); padding: 25px 5px; text-align: center;
            box-shadow: 4px 4px 0px rgba(162, 45, 41, 0.1);
        }
        .ofuda-god { font-size: 0.9rem; color: var(--china-red); font-weight: bold; margin-bottom: 12px; height: 20px; }
        .ofuda-char { font-family: 'Ma Shan Zheng', cursive; font-size: 2.8rem; font-weight: 900; line-height: 1; }
        .ofuda-cs { font-size: 0.85rem; color: #777; border-top: 1px dashed #eee; padding-top: 12px; margin-top: 10px; }

        .chart-box { height: 260px; width: 100%; border: 1px solid #eee; background: #fff; margin-bottom: 40px; }

        /* æ”»ç•¥æ­£æ–‡ */
        .guide-item { margin-bottom: 50px; border-bottom: 1px solid #eee; padding-bottom: 30px; }
        .guide-item:last-child { border: none; }
        .guide-title { 
            font-family: 'Ma Shan Zheng', cursive; font-size: 1.8rem; color: var(--china-red); 
            margin-bottom: 20px; display: flex; align-items: center; gap: 15px;
        }
        .guide-text { font-size: 1.15rem; line-height: 2.2; color: #333; text-align: justify; }
        .guide-text b { color: var(--china-red); background: rgba(162, 45, 41, 0.05); padding: 0 4px; }

        .joy-box { background: #fafafa; padding: 20px; border: 1px solid #eee; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>å¤©å‘½é‰´å®š</h1><br>
        <div class="sys-badge">æ ¼å±€ä¸ºä½“ Â· è°ƒå€™ä¸ºç”¨</div>
    </div>

    <div class="card">
        <div class="input-group">
            <span class="label">ä¹¾å¤é˜´é˜³</span>
            <div class="gender-box">
                <div class="g-btn active" onclick="setGender(1, this)">ä¹¾é€  (é˜³)</div>
                <div class="g-btn" onclick="setGender(0, this)">å¤é€  (é˜´)</div>
            </div>
        </div>
        <div class="input-group">
            <span class="label">é™ç”Ÿæ—¶åˆ»</span>
            <input type="datetime-local" id="birth-input">
        </div>
        <button class="btn-start" onclick="startScan()">å¼€å¯ Â· å¤©å‘½å·è½´</button>
    </div>

    <div id="result-area">
        <div class="card">
            <div class="role-header">
                <span id="role-icon" class="role-icon">?</span>
                <h2 id="role-title" class="role-title">é‘‘å®šä¸­...</h2>
                <div id="role-sub" class="role-sub">...</div>
                <div id="role-tags" class="role-tags"></div>
            </div>

            <div class="climate-box" id="climate-activation">
                <span class="climate-title" id="activation-status">è°ƒå€™æ„Ÿåº”ä¸­...</span>
                <div class="climate-desc" id="activation-desc"></div>
            </div>

            <div class="siling-bar">
                ğŸ“œ å½“ä»¤çœŸç¥ï¼š<span id="siling-text">...</span>
            </div>

            <div class="pillars" id="pillars-box"></div>

            <div class="chart-box">
                <canvas id="energy-canvas"></canvas>
            </div>

            <div class="logic-bar">
                <span class="label">ğŸ”® æ ¼å±€å¥¥ä¹‰</span>
                <div id="pattern-reason" style="margin-bottom:15px; color:#444;"></div>
                <div class="joy-box">
                    <div style="color:var(--status-joy); font-weight:bold;">â˜… å–œï¼š<span id="txt-joy">...</span></div>
                    <div style="color:var(--status-taboo); font-weight:bold; margin-top:10px;">â˜… å¿Œï¼š<span id="txt-taboo">...</span></div>
                </div>
            </div>
        </div>

        <div class="card">
            <div id="guide-content"></div>
        </div>
    </div>
</div>

<script>
    let currentGender = 1;
    const WX_GAME_COLOR = { 'é‡‘':'#b8860b', 'æœ¨':'#2d6a4f', 'æ°´':'#0077b6', 'ç«':'#bc4749', 'åœŸ':'#7f5539' };
    const WUXING_MAP = {'ç”²':'æœ¨','ä¹™':'æœ¨','ä¸™':'ç«','ä¸':'ç«','æˆŠ':'åœŸ','å·±':'åœŸ','åºš':'é‡‘','è¾›':'é‡‘','å£¬':'æ°´','ç™¸':'æ°´','å­':'æ°´','ä¸‘':'åœŸ','å¯…':'æœ¨','å¯':'æœ¨','è¾°':'åœŸ','å·³':'ç«','åˆ':'ç«','æœª':'åœŸ','ç”³':'é‡‘','é…‰':'é‡‘','æˆŒ':'åœŸ','äº¥':'æ°´'};
    const ZHI_MAIN_QI = {'å­':'ç™¸', 'ä¸‘':'å·±', 'å¯…':'ç”²', 'å¯':'ä¹™', 'è¾°':'æˆŠ', 'å·³':'ä¸™', 'åˆ':'ä¸', 'æœª':'å·±', 'ç”³':'åºš', 'é…‰':'è¾›', 'æˆŒ':'æˆŠ', 'äº¥':'å£¬'};
    
    // --- æ–‡æ¡ˆå…¨é‡æ¢å¤ (800å­—+æ·±åº¦è§£æ) ---
    const GAME_DB = {
        "é‡‘æ°´ä¼¤å®˜": { name: "â„ï¸ å¯’å†°å‰‘ä»™", tags: ["SSR","æƒè°‹"], icon: "ğŸ—¡ï¸", slogan: "é‡‘å¯’æ°´å†·ï¼Œå”¯ç«æš–å¿ƒã€‚", male: { c:"[å¤©èµ‹] æƒè°‹æ´å¯Ÿã€‚ä½ æ‹¥æœ‰æé«˜çš„æ™ºå•†ï¼Œæ€ç»´å¦‚å†°åˆ€åˆ‡å¼€å¤æ‚æ ¸å¿ƒã€‚é€‚åˆæ”¿æ²»ã€é«˜ç®¡ã€‚å±€ä¸­è§ç«å³ä¸ºæ˜¾è´µã€‚", w:"[è´¢å¯Œ] éšä½è€Œç”Ÿã€‚è´¢è¿ä¼´éšåœ°ä½ã€‚åˆ‡å¿Œè´ªè…ï¼Œæ°´æ¸…æ˜“å¯Ÿã€‚", l:"[ç¾ç»Š] éœ€æš–é˜³ä¼´ä¾£ã€‚å¯¹æ–¹å¼€æœ—å¤§æ–¹æ–¹èƒ½èåŒ–ä½ çš„å†°å†·ã€‚", k:"[ä¼ æ‰¿] ä¸¥çˆ¶ã€‚å­©å­å¤šç²¾è‹±ã€‚", h:"[é”¦å›Š] å¿…ç”¨ç«ã€‚å¤šæ™’å¤ªé˜³ã€‚" }, female: { c:"[å¤©èµ‹] å†°å±±ç¾äººã€‚é€‚åˆå¤–äº¤ã€æ¼”è‰ºã€‚æ‰åéœ€è¢«çœ‹è§ã€‚", w:"[è´¢å¯Œ] å¤«è£å¦»è´µã€‚ç«ä¸ºå¤«æ˜Ÿäº¦ä¸ºå–œï¼Œæˆå°±ä¸ˆå¤«å³æˆå°±è‡ªå·±ã€‚", l:"[ç¾ç»Š] ç‹¬å–œå®˜æ˜Ÿã€‚å¤–è¡¨é«˜å†·æŒ‘å‰”ï¼Œå†…å¿ƒæå…¶æ¸´æœ›å® çˆ±ã€‚", k:"[ä¼ æ‰¿] è´µå­ã€‚ç”Ÿå­©å­èƒ½æ˜¾è‘—æå‡è¿åŠ¿ã€‚", h:"[é”¦å›Š] æš–å®«é©±å¯’ï¼Œå°‘åƒç”Ÿå†·ã€‚" } },
        "é‡‘æ°´é£Ÿç¥": { name: "ğŸŒŠ çµåŠ¨æ™ºè€…", tags: ["SSR","æ¸…è´µ"], icon: "ğŸŒŠ", slogan: "é‡‘ç™½æ°´æ¸…ï¼Œæ‰æ€æ³‰æ¶Œã€‚", male: { c:"[å¤©èµ‹] å†…ç§€ä¹¾å¤ã€‚å­¦æœ¯æˆ–åˆ›ä½œå¤©æ‰ã€‚æ‰åå†…æ•›ï¼Œæˆå°±äºæ·±è€•ã€‚è§ç«åˆ™åæ‰¬å¤©ä¸‹ã€‚", w:"[è´¢å¯Œ] æŠ€è‰ºç”Ÿè´¢ã€‚é ä¸å¯æ›¿ä»£çš„ä¸“ä¸šå£å’è‡´å¯Œã€‚", l:"[ç¾ç»Š] çµé­‚çŸ¥å·±ã€‚è¿½æ±‚ç²¾ç¥é«˜åº¦å¥‘åˆã€‚", k:"[ä¼ æ‰¿] èªæ…§éº’éºŸã€‚çˆ¶å­å¦‚å‹ã€‚", h:"[é”¦å›Š] è¡¥ç«æš–å±€ã€‚" }, female: { c:"[å¤©èµ‹] è„±ä¿—ç™½æœˆå…‰ã€‚åœ¨æ–‡åŒ–ã€æ•™è‚²è¡Œä¸šèƒ½è‡ªæˆå¤§å®¶ã€‚", w:"[è´¢å¯Œ] å°ç¡®å¹¸ä¸æ–­ã€‚ä¸€ç”Ÿè¡£é£Ÿæ— å¿§ã€‚", l:"[ç¾ç»Š] å¯’è°·å›æ˜¥ã€‚æ¸©æŸ”æ˜¯ç»ˆææ€å™¨ã€‚", k:"[ä¼ æ‰¿] å­å¥³å­é¡ºã€‚æ™šå¹´ç¦åšã€‚", h:"[é”¦å›Š] ä¿æŒå¿ƒæƒ…æ„‰å¿«ã€‚" } },
        "ä¼¤å®˜é…å°": { name: "ğŸ”® æ™ºè€…ç¥å¯", tags: ["UR","æ™ºæ…§"], icon: "ğŸ“œ", slogan: "çƒˆç«çƒ¹æ²¹ï¼Œæ·±æ°´é™æµã€‚", male: { c:"<b>[å¤©èµ‹æ ¸å¿ƒï¼šæ–‡ç†å…¼ä¿®]</b><br>ä½ æ‹¥æœ‰çˆ†å‘æ€§çš„æ‰åå’Œæ·±åšçš„åº•è•´ã€‚é€‚åˆå­¦æœ¯ã€ä¼ åª’é«˜å±‚ã€‚ä½ æ˜¯èƒ½æŠŠå†²åŠ¨è½¬åŒ–ä¸ºåŠ¨åŠ›ï¼ŒæŠŠç›´è§‰å‡åä¸ºç†è®ºçš„é¡¶çº§äººæ‰ã€‚åœ¨å›¢é˜Ÿä¸­ä½ æ˜¯å®šæµ·ç¥é’ˆã€‚", w:"<b>[è´¢å¯Œé€»è¾‘ï¼šåæœ›å˜ç°]</b><br>è´¢å¯Œæ˜¯é â€œå…»â€å‡ºæ¥çš„ã€‚æœ€é€‚åˆé åå£°ã€çŸ¥è¯†äº§æƒè·åˆ©ã€‚å¿ŒåœŸè´ªè´¢ï¼Œä¿æŒä¸“ä¸šé«˜åº¦åˆ™è´¢å¯Œè‡ªè¿½ã€‚ä½ çš„è´¢å¯Œå±‚æ¬¡å–å†³äºä½ çš„åæ°”é«˜åº¦ã€‚", l:"<b>[æƒ…æ„Ÿç¾ç»Šï¼šç²¾ç¥æ”¯æŒ]</b><br>ä¼´ä¾£æ˜¯ä½ çš„æ•‘å‘½ç¨»è‰ï¼Œèƒ½åœ¨ç„¦èºæ—¶è®©ä½ å†·é™ã€‚å©šå§»æ˜¯â€œæ—¢æµâ€ä¹‹ç¾ï¼Œå½¼æ­¤æˆå°±ã€‚å¯¹æ–¹å¤šä¸ºæœ‰æ–‡åŒ–ã€æ‡‚ä½ å†…å¿ƒçš„çŸ¥å·±ã€‚", k:"<b>[åä»£ä¼ æ‰¿]</b><br>å­©å­èªæ˜è´µæ°”ï¼Œå¤šåœ¨ç§‘æŠ€ç•Œæœ‰æ‰€æˆå°±ã€‚", h:"<b>[å®æˆ˜é”¦å›Š]</b><br>é˜²å¿ƒç«è¿‡æ—ºå¯¼è‡´å¤±çœ ã€‚ä¿æŒå¹³å’Œï¼Œæ˜¯ä½ é€šå¾€å·…å³°çš„å”¯ä¸€è·¯å¾„ã€‚" }, female: { c:"<b>[å¤©èµ‹æ ¸å¿ƒï¼šè´µæ°”æ‰å¥³]</b><br>å…¼å…·çµæ°”ä¸ç¨³é‡ã€‚ä½ æ˜¯é‚£ç§èƒ½åœ¨é«˜å‹ä¸­ä¿æŒä¼˜é›…çš„å¥³æ€§ã€‚é€‚åˆç®¡ç†ã€ç­–åˆ’æˆ–æ•™è‚²ï¼Œå…·å¤‡æå¼ºçš„ç¤¾ä¼šåœ°ä½æ½œåŠ›ã€‚", w:"<b>[è´¢å¯Œé€»è¾‘ï¼šè´µäººè´¢]</b><br>ä¸€è¾ˆå­è´µäººè¿æå¼ºã€‚ä¸å»ºè®®æŠ•æœºï¼Œé€‚åˆé•¿çº¿å’Œå“ç‰Œç»è¥ã€‚ç”Ÿæ´»è´¨é‡éšå¹´é¾„æŒç»­æå‡ã€‚ä½ æ˜¯å…¸å‹çš„â€œè¶Šè€è¶Šå°Šè´µâ€ã€‚", l:"<b>[æƒ…æ„Ÿç¾ç»Šï¼šå¸®å¤«è¿]</b><br>ä½ èƒ½å¹³è¡¡äº‹ä¸šä¸å®¶åº­ï¼Œå¸®å¤«è¿æå¼ºã€‚ä¼´ä¾£å¤šä¸ºå„’é›…å›å­ã€‚ç”±äºä½ è‡ªèº«çš„é«˜è¦æ±‚ï¼Œå®¶åº­é€šå¸¸å…·æœ‰æé«˜çš„ç¤¾ä¼šå£°æœ›ã€‚", k:"<b>[åä»£ä¼ æ‰¿]</b><br>å­©å­çµæ°”é€¼äººï¼Œæ¯å­å…³ç³»ä¸ä»…æ˜¯è¡€ç¼˜ï¼Œæ›´æ˜¯çµé­‚å¯¼å¸ˆã€‚", h:"<b>[å®æˆ˜é”¦å›Š]</b><br>æ»‹é˜´è°ƒç†ï¼Œå°‘ç†¬å¤œã€‚å¿ƒæƒ…å¹³å’Œæ˜¯æœ€å¥½çš„ç¾å®¹ã€‚" } },
        "ä¼¤å®˜åˆæ€": { name: "âš¡ å±æœºç»ˆç»“è€…", tags: ["SSR","æƒè°‹"], icon: "ğŸ—¡ï¸", slogan: "æ··ä¹±æ˜¯é˜¶æ¢¯ï¼Œæƒè°‹æ˜¯åˆ©åˆƒã€‚", male: { c:"[å¤©èµ‹] å¤©ç”Ÿå±æœºå…¬å…³ä¸“å®¶ã€‚åœ¨æç«¯ç¯å¢ƒä¸‹å±•ç°ç»Ÿæ²»åŠ›ã€‚", w:"[è´¢å¯Œ] çˆ†å‘åŠ›å¼ºã€‚é€šè¿‡æ•´åˆèµ„æºå’Œè§£å†³æ£˜æ‰‹é—®é¢˜è·åˆ©ã€‚", l:"[ç¾ç»Š] ç›¸çˆ±ç›¸æ€ã€‚ä¼´ä¾£å¤šä¸ºæœ‰ä¸»è§çš„ç«ç‘°ã€‚", k:"[ä¼ æ‰¿] å›é€†å¤©æ‰ã€‚æ•™è‚²å®œå¯¼ä¸å®œå µã€‚", h:"[é”¦å›Š] é¢„é˜²åå¤´ç—›ï¼Œå¤šå»æ°´è¾¹ã€‚" }, female: { c:"[å¤©èµ‹] é“å¨˜å­æ°”åœºã€‚èŒåœºå¤§å¥³ä¸»ï¼Œé å®åŠ›æ‹¼å‡ºæƒå¨ã€‚", w:"[è´¢å¯Œ] åæ°”ææ¬¾æœºã€‚é€‚åˆç½®åŠä¸åŠ¨äº§é•¿æ²»ä¹…å®‰ã€‚", l:"[ç¾ç»Š] æ…•å¼ºã€‚å–œæ¬¢æ¯”è‡ªå·±å¼ºçš„ç¡¬æ±‰ã€‚", k:"[ä¼ æ‰¿] ç²¾è‹±ã€‚å­©å­å¤šèƒ½ç»§æ‰¿å®¶ä¸šã€‚", h:"[é”¦å›Š] å°‘ç”Ÿæ°”ï¼ŒæŠ¤è‚èƒ†ã€‚" } },
        "æ­£è´¢æ ¼": { name: "ğŸœ å‹¤å‹‰ç­‘æ¢¦å¸ˆ", tags: ["R+","ç¨³å¥"], icon: "ğŸ§±", slogan: "ä¸€ç –ä¸€ç“¦ï¼Œèšæ²™æˆå¡”ã€‚", male: { c:"[å¤©èµ‹] è¸å®å®å¹²å®¶ã€‚ä¸ä¿¡æš´å¯Œä¿¡åŠªåŠ›ï¼Œå®ä¸šä¸­åšã€‚", w:"[è´¢å¯Œ] å¤åˆ©è‡´å¯Œã€‚é æ—¶é—´æ»šé›ªçƒï¼Œæ™šå¹´å¯Œè¶³ã€‚", l:"[ç¾ç»Š] å® å¦»ç‹‚é­”ã€‚å·¥èµ„ä¸Šäº¤ï¼Œæ¨¡èŒƒä¸ˆå¤«ã€‚", k:"[ä¼ æ‰¿] æœ´å®æ­£ç›´ã€‚æ•™å¯¼èŠ‚çº¦ã€‚", h:"[é”¦å›Š] é˜²åŠ³æŸï¼Œåˆ«é€æ”¯èº«ä½“ã€‚" }, female: { c:"[å¤©èµ‹] ç²¾ç»†ç®¡å®¶ã€‚ç»†èŠ‚æ§ï¼Œè€æ¿æ”¾å¿ƒçš„å®šæµ·ç¥é’ˆã€‚", w:"[è´¢å¯Œ] ç†è´¢æç¨³ã€‚å®¶åº­çš„CFOï¼Œå­˜æ¬¾æ˜¯å®‰å…¨æ„Ÿã€‚", l:"[ç¾ç»Š] è´¤æƒ ã€‚å¶å°”éœ€è¦åˆ¶é€ ä¸€ç‚¹æµªæ¼«ã€‚", k:"[ä¼ æ‰¿] å­¦ä¸šæŠ“å¾—ç´§ã€‚é˜²å‹åŠ›è¿‡å¤§ã€‚", h:"[é”¦å›Š] å¤šæ¸©è¡¥ï¼Œé˜²æ°”è¡€è™šã€‚" } },
        "æ‚æ ¼": { name: "ğŸŒ± æ½œé¾™å‹¿ç”¨", tags: ["N","æ½œåŠ›"], icon: "ğŸŒ±", slogan: "æ—¶è¿æœªåˆ°ï¼Œæ½œå¿ƒä¿®ç‚¼ã€‚", male: { c:"[å¤©èµ‹] ç»¼åˆå¹³è¡¡ã€‚å¤§å™¨æ™šæˆï¼Œé€‚åˆåœ¨ç¨³å®šæœºæ„æ·±è€•ã€‚", w:"[è´¢å¯Œ] å‹¤åŠ³å°åº·ã€‚é ä¸“ä¸šæ‰‹è‰ºè¿‡æ—¥å­ã€‚", l:"[ç¾ç»Š] å¹³æ·¡æ˜¯çœŸã€‚ç”Ÿæ´»æ³¢æ¾œä¸æƒŠã€‚", k:"[ä¼ æ‰¿] å¥åº·å¹³å®‰æ˜¯æœ€å¤§çš„ç¦ã€‚", h:"[é”¦å›Š] åšæŒé”»ç‚¼èº«ä½“ã€‚" }, female: { c:"[å¤©èµ‹] è¸å®åå‹¤ã€‚è®¤çœŸè´Ÿè´£è®©äººæ”¾å¿ƒã€‚", w:"[è´¢å¯Œ] çœå‡ºæ¥çš„è´¢å¯Œã€‚æŒå®¶æœ‰é“ã€‚", l:"[ç¾ç»Š] ä¾é è€å®äººã€‚å®‰ç¨³ä¸€ç”Ÿã€‚", k:"[ä¼ æ‰¿] æ…ˆæ¯ã€‚ä¸ºå­©å­æ“å¿ƒå¤šã€‚", h:"[é”¦å›Š] ä¿è¯å……è¶³ç¡çœ ã€‚" } }
    };

    // --- ç®—æ³•æ ¸å¿ƒ ---
    function hasRoot(gan, pillars) {
        const roots = ROOT_MAP[gan] || [];
        return pillars.some(p => roots.includes(p.z));
    }

    function calcCommander(lunar, mz) {
        const pj = lunar.getPrevJie();
        const diff = Math.floor((lunar.getSolar().getCalendar().getTime() - pj.getSolar().getCalendar().getTime()) / (1000 * 60 * 60 * 24));
        const rules = SILING_RULES[mz];
        let commander = rules[rules.length-1][0]; 
        let sum = 0;
        for (let r of rules) { sum += r[1]; if (diff < sum) { commander = r[0]; break; } }
        return { commander, diffDays: diff };
    }

    function determinePattern(climate, pillars, dm, mz, cmd) {
        if (climate.special) return climate.special;
        const stems = [pillars[0].g, pillars[1].g, pillars[3].g];
        const gods = stems.map(s => SHISHEN_MAP[dm][s]);

        // 1. æ€æ˜Ÿåˆ¶åŒ–ç»„åˆä¼˜å…ˆ
        if (gods.includes("ä¸ƒæ€")) {
            if (gods.includes("ä¼¤å®˜")) return "ä¼¤å®˜åˆæ€";
            if (gods.includes("é£Ÿç¥") && stems.some(s => SHISHEN_MAP[dm][s]==="é£Ÿç¥" && hasRoot(s, pillars))) return "é£Ÿç¥åˆ¶æ€";
            if (gods.includes("æ­£å°") || gods.includes("åå°")) return "æ€å°ç›¸ç”Ÿ";
        }
        // 2. ä¼¤å®˜ä¼˜å…ˆ (é…å°åˆ¤å®š)
        if (gods.includes("ä¼¤å®˜")) {
            const sgStem = stems.find(s => SHISHEN_MAP[dm][s] === "ä¼¤å®˜");
            if (hasRoot(sgStem, pillars)) {
                if (gods.includes("æ­£å°") || gods.includes("åå°")) {
                    if (stems.some(s => (SHISHEN_MAP[dm][s]==="æ­£å°" || SHISHEN_MAP[dm][s]==="åå°") && hasRoot(s, pillars))) return "ä¼¤å®˜é…å°";
                }
                if (gods.some(g => g && g.includes("è´¢"))) return "ä¼¤å®˜ç”Ÿè´¢";
                return "ä¼¤å®˜æ ¼";
            }
        }
        // 3. çœŸç¥å®šæ ¼
        if (stems.includes(cmd.commander)) {
            const g = SHISHEN_MAP[dm][cmd.commander];
            const m = {"æ­£è´¢":"æ­£è´¢æ ¼","åè´¢":"åè´¢æ ¼","æ­£å®˜":"æ­£å®˜æ ¼","æ­£å°":"æ­£å°æ ¼","é£Ÿç¥":"é£Ÿç¥æ ¼"};
            if (m[g]) return m[g];
        }
        const fallback = {"æ­£è´¢":"æ­£è´¢æ ¼","æ­£å®˜":"æ­£å®˜æ ¼","ä¸ƒæ€":"ä¸ƒæ€æ ¼","æ­£å°":"æ­£å°æ ¼","é£Ÿç¥":"é£Ÿç¥æ ¼","ä¼¤å®˜":"ä¼¤å®˜æ ¼"};
        return fallback[SHISHEN_MAP[dm][ZHI_MAIN_QI[mz]]] || "æ‚æ ¼";
    }

    function startScan() {
        const timeStr = document.getElementById('birth-input').value;
        if (!timeStr) return alert("è¯·é€‰æ‹©æ—¶åˆ»");
        try {
            const date = new Date(timeStr);
            const solar = Solar.fromYmdHms(date.getFullYear(), date.getMonth()+1, date.getDate(), date.getHours(), date.getMinutes(), date.getSeconds());
            const lunar = solar.getLunar();
            const baziObj = lunar.getEightChar();
            baziObj.setSect(2);

            const pillars = [
                {t:'å¹´', g:baziObj.getYearGan().toString(), z:baziObj.getYearZhi().toString()},
                {t:'æœˆ', g:baziObj.getMonthGan().toString(), z:baziObj.getMonthZhi().toString()},
                {t:'æ—¥', g:baziObj.getDayGan().toString(), z:baziObj.getDayZhi().toString()},
                {t:'æ—¶', g:baziObj.getTimeGan().toString(), z:baziObj.getTimeZhi().toString()}
            ];

            const dm = pillars[2].g, mz = pillars[1].z;
            const cmd = calcCommander(lunar, mz);
            
            // è°ƒå€™åˆ¤å®š (ä½“ç”¨æ ¸å¿ƒ)
            const isWinter = ["äº¥","å­","ä¸‘"].includes(mz);
            const isSummer = ["å·³","åˆ","æœª"].includes(mz);
            const hasFire = pillars.some(p => WUXING_MAP[p.g]==='ç«' || WUXING_MAP[p.z]==='ç«');
            const hasWater = pillars.some(p => WUXING_MAP[p.g]==='æ°´' || WUXING_MAP[p.z]==='æ°´');
            
            let actStatus = "åŸæ ¼æ”¯æ’‘ Â· æ°”åœºç¨³å›º";
            let actDesc = "æ ¼å±€åŸºæœ¬åŠŸæ‰å®ï¼Œéœ€åå¤©åŠªåŠ›å¼•åŠ¨æ½œèƒ½ã€‚";

            if ((WUXING_MAP[dm]==='é‡‘' && isWinter && hasFire) || 
                (WUXING_MAP[dm]==='æœ¨' && isSummer && hasWater) ||
                (WUXING_MAP[dm]==='åœŸ' && isWinter && hasFire)) {
                actStatus = "ğŸ”¥ è°ƒå€™å¾—åŠ› Â· æ ¼å±€å˜è´µ";
                actDesc = "å±€ä¸­è§è°ƒå€™çœŸç¥ï¼Œå¦‚é‡‘å™¨é‡ç«ã€ç„¦æœ¨é€¢é›¨ï¼ŒåŸæ ¼è¢«ç¬é—´æ¿€æ´»ï¼Œå±äºâ€œè‡ªå¸¦åŠ æŒâ€çš„é¡¶çº§é…ç½®ã€‚";
            } else if ((isWinter || isSummer) && !hasFire && !hasWater) {
                actStatus = "âš ï¸ è°ƒå€™ç¼ºå¤± Â· æ ¼å±€å—é™";
                actDesc = "åŸæ ¼è™½æˆï¼Œä½†æ°”è±¡åæ¯ï¼ˆå¯’æ¹¿æˆ–ç„¦ç‡¥ï¼‰ï¼ŒçŠ¹å¦‚æ˜ç è’™å°˜ï¼Œéœ€ç«æš–æˆ–æ°´æ¶¦æ–¹èƒ½ç ´å±€ã€‚";
            }

            const climate = { special: null, advice: null };
            if (WUXING_MAP[dm]==='é‡‘' && isWinter) climate.special = pillars.some(p => SHISHEN_MAP[dm][p.g]==='ä¼¤å®˜') ? "é‡‘æ°´ä¼¤å®˜" : "é‡‘æ°´é£Ÿç¥";
            if (WUXING_MAP[dm]==='æœ¨' && mz === 'å·³' && hasWater) climate.special = "ä¼¤å®˜é…å°";

            const pattern = determinePattern(climate, pillars, dm, mz, cmd);
            
            document.getElementById('result-area').style.display = 'block';
            document.getElementById('activation-status').innerText = actStatus;
            document.getElementById('activation-desc').innerText = actDesc;
            renderUI(pattern, cmd, dm, pillars);
            drawChart(pillars);
            document.getElementById('result-area').scrollIntoView({ behavior: 'smooth' });
        } catch (e) { alert("ä¸­æ–­ï¼š" + e.message); }
    }

    function renderUI(key, cmd, dm, pillars) {
        const data = GAME_DB[key] || GAME_DB["æ‚æ ¼"];
        const xiji = XIJI_RULES[key] || XIJI_RULES["æ‚æ ¼"];
        const detail = data[currentGender === 1 ? 'male' : 'female'];

        document.getElementById('role-icon').innerText = data.icon;
        document.getElementById('role-title').innerText = data.name;
        document.getElementById('role-slogan').innerText = data.slogan;
        document.getElementById('role-tags').innerHTML = `<span class="tag ssr">${key}</span><span class="tag">é˜¶ä½:${data.tags[0]}</span>`;
        document.getElementById('siling-text').innerText = `${cmd.commander} (${SHISHEN_MAP[dm][cmd.commander]}) Â· æŒæƒ ${cmd.diffDays} æ—¥`;
        
        document.getElementById('pattern-reason').innerText = xiji.desc;
        document.getElementById('txt-joy').innerText = xiji.joy.join(" ");
        document.getElementById('txt-taboo').innerText = xiji.taboo.join(" ");

        let p_html = '';
        pillars.forEach(p => {
            const god = p.t.includes('æ—¥') ? 'å…ƒç¥' : (SHISHEN_MAP[dm][p.g] || "");
            p_html += `<div class="ofuda"><div class="ofuda-head">${p.t}</div><div class="ofuda-god">${god}</div><div class="ofuda-char" style="color:${WX_GAME_COLOR[WUXING_MAP[p.g]]}">${p.g}</div><div class="ofuda-char" style="color:${WX_GAME_COLOR[WUXING_MAP[p.z]]}">${p.z}</div><span class="ofuda-cs">${CHANGSHENG_TABLE[p.g][p.z] || ""}</span></div>`;
        });
        document.getElementById('pillars-box').innerHTML = p_html;

        document.getElementById('guide-content').innerHTML = `
            <div class="guide-item"><div class="guide-title">âš”ï¸ äº‹ä¸šä¸å¤©èµ‹</div><div class="guide-text">${detail.c}</div></div>
            <div class="guide-item"><div class="guide-title">ğŸ’° è´¢å¯Œä¸é€»è¾‘</div><div class="guide-text">${detail.w}</div></div>
            <div class="guide-item"><div class="guide-title">ğŸ’ æƒ…æ„Ÿä¸ç¾ç»Š</div><div class="guide-text">${detail.l}</div></div>
            <div class="guide-item"><div class="guide-title">ğŸŒ± åä»£ä¸ä¼ æ‰¿</div><div class="guide-text">${detail.k}</div></div>
            <div class="guide-item"><div class="guide-title">âš”ï¸ å®æˆ˜ä¸é”¦å›Š</div><div class="guide-text">${detail.h}</div></div>
        `;
    }

    function drawChart(pillars) {
        const canvas = document.getElementById('energy-canvas');
        const ctx = canvas.getContext('2d');
        const w = canvas.offsetWidth, h = canvas.offsetHeight;
        canvas.width = w; canvas.height = h;
        const counts = {'é‡‘':0,'æœ¨':0,'æ°´':0,'ç«':0,'åœŸ':0};
        pillars.forEach(p => { counts[WUXING_MAP[p.g]]++; counts[WUXING_MAP[p.z]]++; });
        const cx = w/2, cy = h/2, r = 70;
        ctx.strokeStyle = "#eee";
        for(let j=1; j<=3; j++) {
            ctx.beginPath();
            for(let i=0; i<5; i++) {
                const a = (Math.PI*2/5)*i - Math.PI/2;
                ctx.lineTo(cx + Math.cos(a)*r*(j/3), cy + Math.sin(a)*r*(j/3));
            }
            ctx.closePath(); ctx.stroke();
        }
        ctx.fillStyle = "rgba(162, 45, 41, 0.2)"; ctx.strokeStyle = "#a22d29"; ctx.lineWidth = 3;
        ctx.beginPath();
        Object.keys(counts).forEach((k, i) => {
            const a = (Math.PI*2/5)*i - Math.PI/2;
            const l = (counts[k]/8)*r*3.5; 
            const x = cx + Math.cos(a)*l, y = cy + Math.sin(a)*l;
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.closePath(); ctx.fill(); ctx.stroke();
        Object.keys(counts).forEach((k, i) => {
            const a = (Math.PI*2/5)*i - Math.PI/2;
            ctx.fillStyle = "#333"; ctx.font = "bold 13px serif";
            ctx.fillText(k, cx + Math.cos(a)*(r+20)-5, cy + Math.sin(a)*(r+20)+5);
        });
    }

    function setGender(v, el) {
        currentGender = v;
        document.querySelectorAll('.g-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
    }
</script>
</body>
</html>
