<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>命运黑盒 Pro Max · 全格局宗师详解版</title>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.12/lunar.min.js"></script>
    <style>
        :root {
            --primary: #ff2e63;      /* 故障红 */
            --accent: #08d9d6;       /* 赛博蓝 */
            --dark: #121212;         /* 纯黑 */
            --card: #1e1e24;         /* 卡片黑 */
            --text: #e0e0e0;
            --gold: #ffd700;
            --border-r: 12px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            background-color: var(--dark); color: var(--text);
            margin: 0; padding: 20px 10px; min-height: 100vh;
            background-image: radial-gradient(circle at 50% 50%, #2a2d3e 0%, #121212 100%);
            display: flex; justify-content: center;
        }

        .container { width: 100%; max-width: 700px; padding-bottom: 120px; }

        /* 头部 */
        .header { text-align: center; margin-bottom: 30px; position: relative; }
        .header h1 { 
            font-size: 2.2rem; font-weight: 900; margin: 0; letter-spacing: 4px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(255, 46, 99, 0.3);
        }
        .sys-badge { 
            font-size: 0.7rem; border: 1px solid var(--accent); color: var(--accent);
            padding: 4px 10px; border-radius: 20px; display: inline-block; margin-top: 10px;
            box-shadow: 0 0 10px rgba(8, 217, 214, 0.2); letter-spacing: 1px;
        }

        /* 卡片容器 */
        .card {
            background: var(--card); border: 1px solid rgba(255,255,255,0.08);
            border-radius: var(--border-r); padding: 20px; margin-bottom: 25px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative; overflow: hidden;
        }
        .card::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
        }

        /* 输入控件 */
        .input-group { margin-bottom: 20px; }
        .label { color: var(--accent); font-size: 0.85rem; margin-bottom: 8px; display: block; font-weight: bold; letter-spacing: 1px; }
        
        .gender-box { display: flex; gap: 15px; }
        .g-btn {
            flex: 1; padding: 14px; text-align: center; border-radius: 8px; background: rgba(255,255,255,0.05);
            border: 1px solid #333; color: #888; cursor: pointer; transition: 0.3s; font-weight: bold;
        }
        .g-btn.active {
            border-color: var(--primary); color: #fff; background: rgba(255, 46, 99, 0.2);
            box-shadow: 0 0 15px rgba(255, 46, 99, 0.2);
        }

        input[type="datetime-local"] {
            width: 100%; padding: 14px; background: rgba(255,255,255,0.05); border: 1px solid #333;
            color: #fff; border-radius: 8px; font-size: 1.1rem; outline: none; transition: 0.3s;
        }
        input:focus { border-color: var(--accent); }

        .btn-start {
            width: 100%; padding: 16px; border: none; border-radius: 8px;
            background: linear-gradient(135deg, var(--primary), #8000ff);
            color: #fff; font-size: 1.2rem; font-weight: 900; letter-spacing: 3px;
            cursor: pointer; margin-top: 10px; transition: transform 0.1s;
            box-shadow: 0 10px 30px rgba(255, 46, 99, 0.4);
        }
        .btn-start:active { transform: scale(0.98); }

        /* 结果区动画 */
        #result-area { display: none; animation: slideUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }

        /* 角色卡头 */
        .role-header { display: flex; align-items: flex-start; padding-bottom: 20px; border-bottom: 1px dashed rgba(255,255,255,0.15); margin-bottom: 20px; }
        .role-icon {
            width: 70px; height: 70px; background: #2a2a35; border-radius: 14px;
            display: flex; align-items: center; justify-content: center; font-size: 35px;
            border: 2px solid var(--gold); box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
            margin-right: 20px; flex-shrink: 0;
        }
        .role-title { font-size: 1.5rem; font-weight: bold; color: #fff; margin: 0 0 5px 0; }
        .role-sub { font-size: 0.85rem; color: #888; font-style: italic; line-height: 1.4; }
        
        .role-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
        .tag { font-size: 0.75rem; padding: 4px 10px; border-radius: 6px; background: rgba(255,255,255,0.08); color: #bbb; }
        .tag.ssr { background: linear-gradient(45deg, var(--primary), var(--gold)); color: #000; font-weight: bold; }
        .tag.logic { border: 1px solid var(--accent); color: var(--accent); background: transparent; }

        /* 真神司令显示区 */
        .siling-badge {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.15), transparent);
            border-left: 4px solid var(--gold);
            padding: 12px; margin-bottom: 20px; border-radius: 4px;
            color: var(--gold); font-weight: bold; font-size: 0.95rem;
            display: flex; align-items: center; gap: 10px;
        }

        /* 能量图 */
        .chart-box { height: 180px; width: 100%; border-radius: 12px; overflow: hidden; margin-bottom: 20px; position: relative; border: 1px solid rgba(255,255,255,0.1); }
        canvas { width: 100%; height: 100%; }
        .chart-label { position: absolute; bottom: 5px; right: 8px; font-size: 0.7rem; color: rgba(255,255,255,0.5); }

        /* 排盘格 */
        .pillars { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .col { background: rgba(255,255,255,0.03); border-radius: 8px; padding: 12px 2px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .c-head { font-size: 0.65rem; color: #666; margin-bottom: 4px; text-transform: uppercase; }
        .c-god { font-size: 0.7rem; color: var(--accent); height: 14px; margin-bottom: 4px; }
        .c-char { font-family: "KaiTi", serif; font-size: 1.8rem; font-weight: bold; line-height: 1.1; color: #fff; }
        .c-cs { font-size: 0.65rem; color: #888; margin-top: 4px; display: block; }
        .cs-strong { color: var(--gold); }

        .wx-金 { color: #ffeaa7; text-shadow: 0 0 8px rgba(255,234,167,0.4); } 
        .wx-木 { color: #55efc4; text-shadow: 0 0 8px rgba(85,239,196,0.4); } 
        .wx-水 { color: #74b9ff; text-shadow: 0 0 8px rgba(116,185,255,0.4); } 
        .wx-火 { color: #ff7675; text-shadow: 0 0 8px rgba(255,118,117,0.4); } 
        .wx-土 { color: #a29bfe; text-shadow: 0 0 8px rgba(162,155,254,0.4); }

        /* 攻略区 */
        .guide-item { 
            margin-bottom: 25px; padding: 20px; border-radius: 12px; 
            background: rgba(0,0,0,0.25); border-left: 4px solid var(--accent);
        }
        .guide-title { 
            font-size: 1rem; font-weight: bold; color: var(--gold); margin-bottom: 10px;
            display: flex; align-items: center; gap: 8px; letter-spacing: 1px;
        }
        .guide-text { 
            font-size: 0.95rem; line-height: 1.8; color: #ddd; text-align: justify; 
        }
        .guide-text b { color: #fff; font-weight: bold; border-bottom: 1px dotted rgba(255,255,255,0.5); }

        /* 核心分析条 */
        .core-bar {
            background: linear-gradient(to right, rgba(255, 46, 99, 0.1), transparent);
            border: 1px solid rgba(255, 46, 99, 0.3); padding: 15px; border-radius: 10px;
            margin-top: 20px; font-size: 0.9rem; color: #ffcccb; line-height: 1.6;
        }
        
        /* 喜忌条 */
        .logic-bar { 
            margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.3); border: 1px solid #333; 
            font-size: 0.9rem; line-height: 1.6; border-radius: 10px;
        }
        .logic-title { color: var(--accent); font-weight: bold; display: block; margin-bottom: 8px; font-size: 0.85rem; letter-spacing: 1px; }
        .good-text { color: #2ecc71; font-weight: bold; margin-right: 5px; } 
        .bad-text { color: #ff4757; font-weight: bold; margin-right: 5px; }

        #error-msg { display:none; background:var(--primary); padding:10px; border-radius:8px; text-align:center; margin-bottom:15px; font-size:12px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>命运黑盒</h1>
        <div class="sys-badge">SYSTEM: ULTIMATE LORE V10.0</div>
    </div>

    <div id="error-msg">⚠️ 核心组件加载异常，请检查网络 (jsDelivr)</div>

    <div class="card">
        <div class="input-group">
            <span class="label">选择角色性别 / CHARACTER GENDER</span>
            <div class="gender-box">
                <div class="g-btn active" onclick="setGender(1, this)">乾造 (Male)</div>
                <div class="g-btn" onclick="setGender(0, this)">坤造 (Female)</div>
            </div>
        </div>
        <div class="input-group">
            <span class="label">输入出生时间 / SPAWN DATE</span>
            <input type="datetime-local" id="birth-input">
        </div>
        <button class="btn-start" onclick="startScan()">启动宗师级推演 / START SCAN</button>
    </div>

    <div id="result-area">
        <div class="card">
            <div class="role-header">
                <div class="role-icon" id="role-icon">?</div>
                <div class="role-info">
                    <h2 class="role-title" id="role-name">分析中...</h2>
                    <div class="role-sub" id="role-slogan">...</div>
                    <div class="role-tags" id="role-tags"></div>
                </div>
            </div>

            <div class="siling-badge" id="siling-box">
                <span style="font-size:1.2rem">👑</span> 
                <span id="siling-text">正在计算真神...</span>
            </div>
            
            <div class="chart-box">
                <canvas id="energy-canvas"></canvas>
                <div class="chart-label">ELEMENTAL RADAR</div>
            </div>

            <div class="pillars" id="pillars-box"></div>
            
            <div class="core-bar" id="core-analysis"></div>

            <div class="logic-bar">
                <span class="logic-title">⚡ 格局喜忌铁律 (PATTERN LOGIC)</span>
                <div id="pattern-reason" style="margin-bottom:10px; color:#aaa;"></div>
                <div>
                    <span class="good-text">★ 喜用神：</span> <span id="txt-joy" style="color:#eee">...</span>
                </div>
                <div style="margin-top:5px;">
                    <span class="bad-text">✖ 忌神：</span> <span id="txt-taboo" style="color:#eee">...</span>
                </div>
            </div>
        </div>

        <div class="card">
            <span class="label" style="margin-bottom:15px; font-size:1rem;">天命通关攻略 / STRATEGY GUIDE</span>
            <div id="guide-content"></div>
        </div>

        <div style="text-align:center; font-size:12px; color:#444; margin-top:40px;">
            Destiny Algorithm © 2025 · Verified by Gemini
        </div>
    </div>
</div>

<script>
    let currentGender = 1;

    // ==========================================================
    // 静态数据字典 (全内置，零依赖)
    // ==========================================================
    
    const WUXING_MAP = {'甲':'木','乙':'木','丙':'火','丁':'火','戊':'土','己':'土','庚':'金','辛':'金','壬':'水','癸':'水','子':'水','丑':'土','寅':'木','卯':'木','辰':'土','巳':'火','午':'火','未':'土','申':'金','酉':'金','戌':'土','亥':'水'};
    const WX_COLOR = { '金':'wx-金', '木':'wx-木', '水':'wx-水', '火':'wx-火', '土':'wx-土' };

    const ZHI_MAIN_QI = {'子':'癸', '丑':'己', '寅':'甲', '卯':'乙', '辰':'戊', '巳':'丙', '午':'丁', '未':'己', '申':'庚', '酉':'辛', '戌':'戊', '亥':'壬'};

    // 司令规则 (日)
    const SILING_RULES = {
        '寅': [['戊',7], ['丙',7], ['甲',16]], '卯': [['甲',10], ['乙',20]], '辰': [['乙',9], ['癸',3], ['戊',18]],
        '巳': [['戊',5], ['庚',9], ['丙',16]], '午': [['丙',10], ['己',9], ['丁',11]], '未': [['丁',9], ['乙',3], ['己',18]],
        '申': [['戊',7], ['壬',7], ['庚',16]], '酉': [['庚',10], ['辛',20]], '戌': [['辛',9], ['丁',3], ['戊',18]],
        '亥': [['戊',7], ['甲',5], ['壬',18]], '子': [['壬',10], ['癸',20]], '丑': [['癸',9], ['辛',3], ['己',18]]
    };

    const HIDDEN_GAN_MAP = {
        '子':['癸'], '丑':['己','癸','辛'], '寅':['甲','丙','戊'], '卯':['乙'], 
        '辰':['戊','乙','癸'], '巳':['丙','戊','庚'], '午':['丁','己'], '未':['己','丁','乙'], 
        '申':['庚','壬','戊'], '酉':['辛'], '戌':['戊','辛','丁'], '亥':['壬','甲']
    };

    // 阴阳长生表 (阳顺阴逆)
    const CHANGSHENG_TABLE = {
        "甲": { "亥":"长生", "子":"沐浴", "丑":"冠带", "寅":"临官", "卯":"帝旺", "辰":"衰", "巳":"病", "午":"死", "未":"墓", "申":"绝", "酉":"胎", "戌":"养" },
        "乙": { "午":"长生", "巳":"沐浴", "辰":"冠带", "卯":"临官", "寅":"帝旺", "丑":"衰", "子":"病", "亥":"死", "戌":"墓", "酉":"绝", "申":"胎", "未":"养" },
        "丙": { "寅":"长生", "卯":"沐浴", "辰":"冠带", "巳":"临官", "午":"帝旺", "未":"衰", "申":"病", "酉":"死", "戌":"墓", "亥":"绝", "子":"胎", "丑":"养" },
        "丁": { "酉":"长生", "申":"沐浴", "未":"冠带", "午":"临官", "巳":"帝旺", "辰":"衰", "卯":"病", "寅":"死", "丑":"墓", "子":"绝", "亥":"胎", "戌":"养" },
        "戊": { "寅":"长生", "卯":"沐浴", "辰":"冠带", "巳":"临官", "午":"帝旺", "未":"衰", "申":"病", "酉":"死", "戌":"墓", "亥":"绝", "子":"胎", "丑":"养" },
        "己": { "酉":"长生", "申":"沐浴", "未":"冠带", "午":"临官", "巳":"帝旺", "辰":"衰", "卯":"病", "寅":"死", "丑":"墓", "子":"绝", "亥":"胎", "戌":"养" },
        "庚": { "巳":"长生", "午":"沐浴", "未":"冠带", "申":"临官", "酉":"帝旺", "戌":"衰", "亥":"病", "子":"死", "丑":"墓", "寅":"绝", "卯":"胎", "辰":"养" },
        "辛": { "子":"长生", "亥":"沐浴", "戌":"冠带", "酉":"临官", "申":"帝旺", "未":"衰", "午":"病", "巳":"死", "辰":"墓", "卯":"绝", "寅":"胎", "丑":"养" },
        "壬": { "申":"长生", "酉":"沐浴", "戌":"冠带", "亥":"临官", "子":"帝旺", "丑":"衰", "寅":"病", "卯":"死", "辰":"墓", "巳":"绝", "午":"胎", "未":"养" },
        "癸": { "卯":"长生", "寅":"沐浴", "丑":"冠带", "子":"临官", "亥":"帝旺", "戌":"衰", "酉":"病", "申":"死", "未":"墓", "午":"绝", "巳":"胎", "辰":"养" }
    };
    const STRONG_CS = ["长生", "帝旺", "临官", "冠带"]; 

    const SHISHEN_MAP = {
        "甲": { "甲":"比肩", "乙":"劫财", "丙":"食神", "丁":"伤官", "戊":"偏财", "己":"正财", "庚":"七杀", "辛":"正官", "壬":"偏印", "癸":"正印" },
        "乙": { "乙":"比肩", "甲":"劫财", "丁":"食神", "丙":"伤官", "己":"偏财", "戊":"正财", "辛":"七杀", "庚":"正官", "癸":"偏印", "壬":"正印" },
        "丙": { "丙":"比肩", "丁":"劫财", "戊":"食神", "己":"伤官", "庚":"偏财", "辛":"正财", "壬":"七杀", "癸":"正官", "甲":"偏印", "乙":"正印" },
        "丁": { "丁":"比肩", "丙":"劫财", "己":"食神", "戊":"伤官", "辛":"偏财", "庚":"正财", "癸":"七杀", "壬":"正官", "乙":"偏印", "甲":"正印" },
        "戊": { "戊":"比肩", "己":"劫财", "庚":"食神", "辛":"伤官", "壬":"偏财", "癸":"正财", "甲":"七杀", "乙":"正官", "丙":"偏印", "丁":"正印" },
        "己": { "己":"比肩", "戊":"劫财", "辛":"食神", "庚":"伤官", "癸":"偏财", "壬":"正财", "乙":"七杀", "甲":"正官", "丁":"偏印", "丙":"正印" },
        "庚": { "庚":"比肩", "辛":"劫财", "壬":"食神", "癸":"伤官", "甲":"偏财", "乙":"正财", "丙":"七杀", "丁":"正官", "戊":"偏印", "己":"正印" },
        "辛": { "辛":"比肩", "庚":"劫财", "癸":"食神", "壬":"伤官", "乙":"偏财", "甲":"正财", "丁":"七杀", "丙":"正官", "己":"偏印", "戊":"正印" },
        "壬": { "壬":"比肩", "癸":"劫财", "甲":"食神", "乙":"伤官", "丙":"偏财", "丁":"正财", "戊":"七杀", "己":"正官", "庚":"偏印", "辛":"正印" },
        "癸": { "癸":"比肩", "壬":"劫财", "乙":"食神", "甲":"伤官", "丁":"偏财", "丙":"正财", "己":"七杀", "戊":"正官", "辛":"偏印", "庚":"正印" }
    };

    // 核心数据库：格局喜忌规则 (XIJI RULES)
    const XIJI_RULES = {
        "金水伤官": {
            desc: "天寒地冻，金水虽清但无生机。喜火（官杀）暖局，喜木（财）生火。此为伤官见官反为贵的特殊格局。",
            joy: ["🔥 火 (官杀·调候)", "🌲 木 (财星·助燃)"],
            taboo: ["💧 水 (伤官·加寒)", "⛰️ 土 (印星·埋金)"]
        },
        "金水食神": {
            desc: "金白水清，才华横溢。与金水伤官类似，但食神心性更温和，亦喜火暖局以成大器，忌土埋金、水过寒。",
            joy: ["🔥 火 (调候·暖局)", "🌲 木 (财星·流通)"],
            taboo: ["⛰️ 土 (枭神·夺食)", "💧 水 (过寒·沉沦)"]
        },
        "木火通明": {
            desc: "春木生火，木火两旺，气象光辉。最忌金（官杀）来克伐，损了秀气；也忌水（印）太旺灭火。",
            joy: ["🔥 火 (食伤·泄秀)", "🌲 木 (比劫·助势)"],
            taboo: ["🗡️ 金 (官杀·克战)", "💧 水 (印星·灭火)"]
        },
        "伤官配印": {
            desc: "火炎土燥（夏木）或身弱伤旺。急需印星（水）来调候润局并生身。贵在有印，印星为第一救星。",
            joy: ["💧 水 (印星·润局)", "🌲 木 (比劫·护印)"],
            taboo: ["⛰️ 土 (财星·坏印)", "🔥 火 (伤官·过旺)"]
        },
        "食神制杀": {
            desc: "七杀攻身，幸有食神制之。这是一个英雄独压万人的格局。喜身强以抗杀，喜食神以制敌。",
            joy: ["🎨 食神 (制杀)", "📜 印星 (化杀)", "💪 比劫 (帮身)"],
            taboo: ["💰 财星 (党杀·泄食)", "🗡️ 官杀 (攻身)"]
        },
        "伤官生财": {
            desc: "伤官虽旺，但有财星引通食伤之气，形成流通。只要身不弱，即为富格。技艺成家，财富自来。",
            joy: ["身弱喜印比 (📜/💪)", "身强喜食伤财 (🎨/💰)"], 
            taboo: ["身弱忌财官", "身强忌印比"]
        },
        "伤官合杀": {
            desc: "伤官与七杀相合，化干戈为玉帛。这是异路功名之象。喜身旺，喜印绶。",
            joy: ["📜 印星 (生身)", "💪 比劫 (帮身)"],
            taboo: ["💰 财星 (生杀)", "🗡️ 官杀 (混杂)"]
        },
        "伤官格": {
            desc: "伤官当令，泄气太过。若无财无印，则为孤傲清高之士。需印制伤，或财引化。",
            joy: ["📜 印星 (制伤)", "💰 财星 (引化)"],
            taboo: ["🗡️ 官杀 (克战)", "💪 比劫 (助伤)"]
        },
        "建禄格": {
            desc: "月令建禄，身旺财官有气。喜财官食伤以泄秀，忌印比再来生扶。",
            joy: ["🗡️ 官杀 (护财)", "🎨 食伤 (生财)", "💰 财星 (养命)"],
            taboo: ["📜 印星 (过旺)", "💪 比劫 (夺财)"]
        },
        "月劫格": {
            desc: "月令劫财，身强财弱。首取官杀制劫，次取食伤泄劫。最怕比劫夺财。",
            joy: ["🗡️ 官杀 (制劫)", "🎨 食伤 (泄秀)", "💰 财星 (需食伤通关)"],
            taboo: ["📜 印星 (生劫)", "💪 比劫 (争财)"]
        },
        "七杀格": {
            desc: "七杀当权，如抱虎而眠。若身弱，首取印星化杀；若身强，首取食神制杀。",
            joy: ["📜 印星 (化杀生身)", "🎨 食伤 (制杀)"],
            taboo: ["💰 财星 (生杀)", "🗡️ 官杀 (攻身)"]
        },
        "正官格": {
            desc: "正官纯正，气象尊贵。喜财生官，喜印护官。最怕伤官克官。",
            joy: ["💰 财星 (生官)", "📜 印星 (护官)"],
            taboo: ["🎨 伤官 (克官)", "🗡️ 七杀 (混杂)"]
        },
        "正财格": {
            desc: "财星当令，勤劳致富。身强能任财，身弱喜印比。",
            joy: ["身强喜官杀食伤", "身弱喜印比"],
            taboo: ["身强忌印比", "身弱忌财官"]
        },
        "偏财格": {
            desc: "偏财当令，慷慨多情。喜官杀护财，喜食伤生财。",
            joy: ["🗡️ 官杀", "🎨 食伤", "身弱喜印比"],
            taboo: ["💪 比劫 (夺财)", "空亡"]
        },
        "正印格": {
            desc: "印绶生身，慈悲为怀。喜官杀生印，忌财星坏印。",
            joy: ["🗡️ 官杀 (生印)", "💪 比劫 (护印)"],
            taboo: ["💰 财星 (坏印)"]
        },
        "偏印格": {
            desc: "偏印当权，鬼才逻辑。喜偏财制枭，忌食神被夺（枭神夺食）。",
            joy: ["💰 偏财 (制枭)", "天月德贵人"],
            taboo: ["🎨 食神 (被克)"]
        },
        "食神格": {
            desc: "食神生财，福寿双全。喜财星流通，忌枭神（偏印）夺食。",
            joy: ["💰 财星 (流通)", "💪 比劫 (生食)"],
            taboo: ["📜 偏印 (夺食)"]
        }
    };

    // 终极文案库 (百万文案版)
    const GAME_DB = {
        "金水伤官": {
            name: "❄️ 寒冰剑仙 (Frost Blade)", tags: ["SSR", "高冷", "权谋"], icon: "🗡️",
            slogan: "“金寒水冷，唯火暖心。我的剑，只为守护那一点温存。”",
            male: { 
                c:"**[天赋：权谋与洞察]**<br>金水伤官人最聪明，但也最傲气。你天生适合从事**政治、管理、战略策划或高层幕僚**的工作。你的思维像冰刀一样锐利，能瞬间切开复杂问题的核心。格局成败的关键在于“火（官杀）”。见火，你就是手握重权的宰相或高管；无火，你可能只是一个愤世嫉俗的穷酸秀才，空有一身才华却无人赏识。记得，你的才华必须依附于体制或权威（火）才能发光。", 
                w:"**[被动：富贵险中求]**<br>你的财运通常伴随着地位而来。有了权（官）自然有钱。但因为金水太清，你也容易因为“清高”而错失赚快钱的机会。切忌贪污腐败或走灰色地带，因为水太清，一点点墨汁都会被看得清清楚楚，极易被查。走火运（南方运）时，是财富爆发的高光时刻。", 
                l:"**[羁绊：寻找暖阳]**<br>你的内心太冷了，像一座冰山。虽然你外表可能很风流或健谈，但内心深处渴望被温暖。你需要一个**热情如火、开朗大方**的伴侣，对方可能是你的上司、崇拜者，或者是那种没心没肺的“小太阳”。只有这样的人，才能融化你的冰冷，让你卸下防备。", 
                k:"**[传承：严父出孝子]**<br>你对孩子的要求极高，甚至有些苛刻。你希望他们出人头地，继承你的智慧。孩子多半聪明且有出息，但要注意别给太大压力，否则亲子关系容易变得冷漠。多给孩子一点温情的拥抱。", 
                h:"**[实战锦囊]**<br>你的命局寒气太重。务必多晒太阳，多穿红衣，居住环境要光照充足。**忌去北方**发展，宜往南方。身体上要注意风湿寒症、肾脏以及心血管系统的健康。冬天是你最难熬的季节，要注意保暖。" 
            },
            female: { 
                c:"**[天赋：冰山美人]**<br>才貌双全，气质高冷，你是人群中那个让人不敢轻易靠近的存在。适合**演艺、外交、公关高管、高端销售**。你必须有火暖局，也就是要有舞台、有聚光灯，否则你的才华会变成孤芳自赏，甚至导致抑郁。你的才华需要“被看见”，不要躲在角落里。", 
                w:"**[被动：夫荣妻贵]**<br>这是一个很特殊的格局。对于金水伤官女命来说，官星（火）不仅是夫星，也是喜用神。这意味着你的财富和地位，很大程度上会来自于你的伴侣或者你所在的平台（公司/体制）。**“旺夫即旺己”**，成就你的另一半，就是成就你自己。", 
                l:"**[羁绊：恃才傲物与渴望呵护]**<br>伤官本是克官（夫）的，但金水伤官是特例，**“独喜官”**。你内心非常渴望男人的呵护和温暖，但表现出来的却是挑剔和高傲。千万别作！遇到那个愿意包容你坏脾气、还能给你暖被窝的人，就嫁了吧。不要试图去驾驭男人，而是学会示弱，这才是你的必杀技。", 
                k:"**[传承：贵子临门]**<br>你的孩子通常长相漂亮，聪明伶俐，是你生命的延续和希望。生孩子对你的运势有提升作用，因为孩子代表食伤，也是你才华的具象化。", 
                h:"**[实战锦囊]**<br>你是典型的“冷底子”。特别要注意**妇科寒症、痛经、手脚冰凉**的问题。坚持泡脚，少吃生冷食物（冰淇淋、刺身），多吃温补的食物。保持体温，就是保持运气。" 
            }
        },
        "金水食神": {
            name: "🌊 灵动智者 (Fluid Sage)", tags: ["SSR", "聪慧", "清贵"], icon: "🌊",
            slogan: "“金白水清，聪明绝顶。文秀之气，流转不息。”",
            male: { 
                c:"**[天赋：内秀乾坤]**<br>相比金水伤官的傲气逼人，金水食神更显温文尔雅、内敛深沉。你天生拥有S级的逻辑思维和极高的艺术感知力，适合从事**学术研究、文学创作、艺术设计、高精尖技术**等领域。你的才华不是用来攻击别人的武器，而是用来滋养世界的甘露。但金水太寒，若无火暖局，才华容易被埋没，变成“怀才不遇”的隐士；若见火（官印），则能名扬四海，成为一代宗师。你的成功是水到渠成的，而非强取豪夺。", 
                w:"**[被动：技艺生财]**<br>食神生财，财源细水长流，源源不断。你不屑于赚快钱、投机倒把，更看重长期的积累和名声。你的财富往往来自你的专业技能、知识产权或作品版税。这种财富虽然来得慢，但极其稳固，抗风险能力极强。只要你保持专业度，这辈子不仅不缺钱，还能积累可观的家底。切忌因为清高而视金钱如粪土，要学会让才华变现。", 
                l:"**[羁绊：灵魂知己]**<br>你注重精神层面的交流，外貌对你来说只是次要的，你更需要一个能听懂你弦外之音、能和你从诗词歌赋谈到人生哲学的伴侣。你的感情生活平淡而真实，不追求轰轰烈烈，只求细水长流。但因为金水偏寒，你有时会显得比较冷淡，让伴侣觉得难以接近，适度表达热情很重要。你的伴侣通常也是高学历或有修养的人。", 
                k:"**[传承：聪慧麒麟]**<br>你的孩子完美继承了你的高智商和艺术天赋，性格温和懂事，不需要你操太多心。你对孩子的教育方式宽容而开明，孩子视你为榜样和朋友。晚年能享子女之福，是真正的“福寿双全”之象。", 
                h:"**[实战锦囊]**<br>金水过旺，寒气入骨。你需要**“补火”**！多做户外运动（如跑步、登山），多晒太阳，保持心情开朗，避免陷入消极情绪。居住环境宜暖不宜冷。身体上重点保养**肾脏、泌尿系统和呼吸系统**，防止湿寒之气侵体。心情好，运气就好。" 
            },
            female: { 
                c:"**[天赋：气质清流]**<br>金白水清的女命，多出美女，且气质清新脱俗，带有一种不食人间烟火的仙气。你适合从事**文化、教育、艺术、慈善**等高雅行业。你的存在本身就是一种美好的风景，容易得到长辈和贵人的喜爱。你的职场之路通常比较顺遂，因为你与世无争的态度反而让你赢得了更多的机会。你是团队中的“白月光”，人缘极佳。", 
                w:"**[被动：福泽深厚]**<br>食神代表福气和口福。你一生衣食无忧，福泽深厚。不需要像伤官格那样辛苦拼搏，自然有人（父母或丈夫）为你铺路，或者能轻松找到一份收入不错又体面的工作。你的财运是“安稳”的代名词，适合稳健理财，不宜涉足高风险投资。你的直觉很准，有时候跟着感觉走就能避坑。", 
                l:"**[羁绊：寒谷回春]**<br>虽然命理书上说“食神克官”，但金水食神是特例，因为冬金必须见火（官），所以你也能得到丈夫的宠爱和保护。你的伴侣通常能力不错，且对你体贴入微。只要你不过分任性或高冷，婚姻会非常美满。记住，你的温柔是你最大的武器，用你的似水柔情去温暖对方，而不是用冰冷去考验对方。", 
                k:"**[传承：慈母福荫]**<br>你是典型的慈母，对孩子疼爱有加。孩子也是你的福星，给你带来无尽的快乐。你的教育方式如春风化雨，孩子在你的教育下会成长为身心健康、性格开朗的人。你的晚年生活会因为子女的孝顺而变得非常幸福惬意。", 
                h:"**[实战锦囊]**<br>同样需要**“暖局”**。多穿暖色调的衣服，少吃冰冷食物（冷饮、寒性水果）。特别要注意**妇科保养和肾脏健康**，避免熬夜，保持规律的作息。你的心情直接影响你的健康，开心是你最好的补药。多接触大自然的花草树木（木生火），能提升运势。" 
            }
        },
        "木火通明": {
            name: "🔥 薪火传人 (Phoenix)", tags: ["SSR", "文化", "名望"], icon: "🔥",
            slogan: "“木火交辉，光耀千秋。我不是凡火，我是文明的灯塔。”",
            male: { 
                c:"**[天赋：文昌降世]**<br>木火通明主文才、名望。你不是那种在商场上厮杀的战士，而是**学者、教授、作家、艺术家、思想家**。你的笔杆子和脑子就是最强的武器。你的名声比钱更重要。最忌金（官杀）来砍木，那是“焚琴煮鹤”，坏了秀气，导致怀才不遇。坚持走文化、教育路线，你能成为一代宗师。", 
                w:"**[被动：名利双收]**<br>对于你来说，钱是名声的副产品。名气大了，钱自然来（版权费、出场费、润笔费）。不要为了钱去从政（见官）或做低端的生意，那会让你很痛苦，且得不偿失。你的财富积累是优雅的，是通过知识付费或版权变现来实现的。", 
                l:"**[羁绊：灵魂知音]**<br>你对伴侣的要求极高，不是要求外貌，而是要求**“懂你”**。你需要一个能读懂你文章、听懂你音乐、能和你彻夜长谈的灵魂伴侣。精神层面的共鸣比物质条件更重要。如果找不到，你宁愿单身。", 
                k:"**[传承：书香门第]**<br>你的孩子多半文质彬彬，学习成绩好，继承你的文化基因。你家里大概率会有很多藏书。你对孩子的教育是潜移默化的熏陶，而不是填鸭式的灌输。", 
                h:"**[实战锦囊]**<br>木火通明，气机通畅。但火气太旺，**心血管系统**要注意，容易心律不齐或高血压。此外，熬夜是你的大敌，因为它会耗损你的心血。多接触大自然（木），保持灵感通畅。" 
            },
            female: { 
                c:"**[天赋：才女下凡]**<br>气质出众，才华横溢，你是那个在人群中发光的人。适合**教育、媒体、设计、时尚**行业。你的光芒太耀眼，容易遭人嫉妒，所谓“木秀于林，风必摧之”。要学会适当收敛锋芒，或者找一个强大的平台来保护自己。", 
                w:"**[被动：清贵]**<br>你不屑于谈钱，觉得谈钱俗气，但你的生活品味极高，开销不小。适合从事高雅行业，如艺术品鉴定、高端设计、心理咨询。你的客户通常也是高素质人群，愿意为你昂贵的服务买单。", 
                l:"**[羁绊：晚婚或不婚]**<br>眼光太高了，普通人根本入不了你的法眼。而且你不喜受管束（忌官），受不了大男子主义的男人。你适合**晚婚**，或者找一个欣赏你才华、愿意做你背后支持者的温和伴侣。甚至，独身主义也是一种潇洒的选择。", 
                k:"**[传承：优生优育]**<br>你的孩子通常有艺术天分，从小就显得与众不同。培养方向宜文不宜武，学琴棋书画比学数理化更有前途。", 
                h:"**[实战锦囊]**<br>火主目，心主神。你容易用眼过度，或者思虑过度导致失眠。注意视力保护，少看电子屏幕，多看绿色植物。心脏的保养也是重中之重。" 
            }
        },
        "伤官配印": {
            name: "🔮 智者神启 (Oracle)", tags: ["UR", "天命级", "智慧"], icon: "📜",
            slogan: "“烈火烹油非长久，深水静流是真理。”",
            male: { 
                c:"**[天赋：降维打击]**<br>你生于特殊季节（如夏木），本应焦躁，却得贵人（印/水）润局。你的核心竞争力不是“拼命”，而是**“智慧与冷静”**。当别人在盲目冲杀时，你在幕后运筹帷幄。适合**学术、咨询、参谋、科研、战略规划**。你是团队的“大脑”，切忌冲动创业，要做那个“给矿工卖水”的人。", 
                w:"**[被动：知识付费]**<br>格局铁律：**忌土（财）**。因为财会坏印（药），也就是“贪财坏印”。一旦你变得贪婪、急功近利，你的贵气和好运就会消失。你的财运来自名望、专利和知识变现。不要赚快钱，要赚“慢钱”、“大钱”。", 
                l:"**[羁绊：灵魂伴侣]**<br>你的伴侣是你的贵人，能让你在焦躁时冷静下来。她可能不漂亮、不风情万种，但她能给你安全感，能帮你兜底。不要嫌弃对方沉闷，那是你的救命稻草，是你的“水源”。", 
                k:"**[传承：书香传承]**<br>你的孩子聪明好学，有文化底蕴。你对孩子的教育非常重视，家里书卷气很浓。孩子未来多半是学者或专业人士。", 
                h:"**[实战锦囊]**<br>因为有印星调候，你的身体底子不错，实现了水火平衡。但要注意心火过旺导致的失眠或口腔溃疡。保持心态平和，少动怒。" 
            },
            female: { 
                c:"**[天赋：贵气才女]**<br>伤官佩印，贵不可言。你既有伤官的才华和灵气，又有印星的修养和底蕴。适合**教育、文化、艺术、出版**。你的风格是以柔克刚，以静制动。在职场上，你往往是那个备受领导器重、同事尊重的核心人物。", 
                w:"**[被动：养财]**<br>你的钱是“养”出来的，不是“抢”出来的。适合长线投资，购买保险、基金。远离高风险投机（如炒币、赌博），因为财星坏印会让你判断失误，血本无归。", 
                l:"**[羁绊：去官就食]**<br>你太聪明了，一般男人驾驭不了你，甚至会害怕你。不用强求丈夫多厉害、多有钱，只要他能包容你、滋养你（水印）、听你的话，就是上等姻缘。找个性格温和的“暖男”最合适。", 
                k:"**[传承：灵性]**<br>你的孩子非常有灵气，善解人意，甚至可能带有一点“佛缘”或玄学天赋。你和孩子的关系非常亲密。", 
                h:"**[实战锦囊]**<br>你的保养秘诀在于“滋阴”。多补水，多吃银耳、燕窝等滋润的食物。少熬夜，熬夜最耗阴液，容易让你变老变丑。" 
            }
        },
        "伤官合杀": { 
            name: "⚡ 危机终结者 (Terminator)", tags: ["SSR", "爆发型", "乱世英雄"], icon: "🗡️",
            slogan: "“混乱是阶梯。当别人在恐惧时，正是我接管战场的时候。”",
            male: { 
                c:"**[天赋：乱世枭雄]**<br>你天生自带反骨，不适合呆板的体制和按部就班的工作。你的主场在**危机公关、律师辩护、特种顾问、黑白通吃的中介**。越是混乱、高压、没人敢接的盘，越能激发你的S级潜能。别怕麻烦，麻烦就是你的经验包和晋升阶梯。", 
                w:"**[被动：掠夺者]**<br>你的财富不靠积攒，靠**“狩猎”**。利用信息差、技术壁垒或胆识进行降维打击。爆发力极强，可能三年不开张，开张吃三年。建议配置“固定资产”护盾，防止财富流失过快。", 
                l:"**[羁绊：相爱相杀]**<br>你看不上傻白甜，只有带点刺、有手段的女性才能激起你的征服欲。你的婚姻是一场**“高智商博弈”**，虽然吵吵闹闹，但彼此灵魂深度契合。控制欲别太强，给对方一点呼吸空间。", 
                k:"**[传承：叛逆天才]**<br>你的后代大概率遗传了你的高智商和叛逆。别用“听话”来要求他，那是扼杀天才。引导他去搞科研、艺术或竞技，他会成为你的骄傲。", 
                h:"**[实战锦囊]**<br>大脑常年高速运转，容易神经衰弱。注意头部、眼部保养，以及激进运动带来的外伤风险。" 
            }, 
            female: { 
                c:"**[天赋：女王气场]**<br>职场上的**“铁娘子”**。公关总监、操盘手、甚至创业领袖。你能搞定最难缠的客户，甚至让男人们敬畏三分。你的武器是犀利的言辞和雷厉风行的手段。你适合在男人堆里厮杀，并取得胜利。", 
                w:"**[被动：名气变现]**<br>名气越大，财运越旺。适合经营个人品牌，或者利用圈层影响力进行资源置换变现。你适合做一个快乐的“守财奴”，把赚来的钱变成不动产，构建安全感壁垒。", 
                l:"**[羁绊：慕强心理]**<br>你欣赏**“爹系”**硬汉或行业大佬。普通男人入不了你的眼。婚后你是家里的主心骨，但也容易因为太强势而让对方有压力。学会在家“卸甲”，能让感情升温。", 
                k:"**[传承：精英教育]**<br>你对孩子投入极大，期望极高。孩子往往有特殊才艺。注意不要把你的焦虑投射给孩子。", 
                h:"**[实战锦囊]**<br>情绪波动大，容易导致内分泌失调或妇科问题。适度医美，多做瑜伽，保持身心平衡。" 
            } 
        },
        "食神制杀": { 
            name: "🦁 铁腕驯兽师 (Beast Tamer)", tags: ["SR+", "控制型", "威望"], icon: "🦁",
            slogan: "“愤怒是无用的，只有绝对的力量和规则才能驯服野兽。”",
            male: { 
                c:"**[天赋：不怒自威]**<br>你不需要大吼大叫，你的专业能力和深邃气场足以让众人服从。适合**公检法、外科医生、技术总监**。你是团队的定海神针，专门解决那些需要“硬碰硬”的技术难题。你的权威是靠实力打出来的。", 
                w:"**[被动：资历加成]**<br>你的财富曲线是**“大后期型”**。资历越老，威望越高，收入越稳。靠手艺吃饭，金饭碗端得最稳。不建议盲目跟风炒作，坚持你的专业主义。", 
                l:"**[羁绊：一家之主]**<br>你在家中地位极高，妻子敬重你，甚至有点怕你。你是典型的传统大男人，虽不善言辞，但责任感爆棚。多给家人一点笑脸，别把工作威严带回家。", 
                k:"**[传承：栋梁之材]**<br>孩子规矩懂事，学习成绩优异，不用你操太多心。未来多半走仕途或学术路线。", 
                h:"**[实战锦囊]**<br>身体底子好，但容易摄入过剩。防三高、脂肪肝。应酬虽多，惜命要紧。" 
            }, 
            female: { 
                c:"**[天赋：逻辑女王]**<br>不屑于宫斗，靠硬实力说话。**财务总监、审计、学术带头人**。你的逻辑滴水不漏，让竞争对手找不到破绽。你是老板最信任的“防火墙”。", 
                w:"**[被动：CFO]**<br>你是天生的理财圣手。不仅能赚钱，更能管钱。家里的财政大权必须握在你手里。你对数字敏感，投资眼光精准且稳健。", 
                l:"**[羁绊：严妻良母]**<br>管老公像管孩子，虽然有点啰嗦，但都是为了家好。丈夫通常性格温和，愿意听你安排。你是家里的总指挥。", 
                k:"**[传承：贴心棉袄]**<br>子女缘分极佳，母慈子孝。晚年能享子女的福气。", 
                h:"**[实战锦囊]**<br>压力大时容易胃痛。注意饮食规律，少吃生冷。" 
            } 
        },
        "伤官生财": { 
            name: "💸 炼金术士 (Alchemist)", tags: ["SSR", "智谋系", "高收益"], icon: "⚗️",
            slogan: "“万物皆可交易。给我一个支点，我能把稻草卖成金条。”",
            male: { 
                c:"**[天赋：点石成金]**<br>千万别去打死工！你是**创业、创意、营销**的天才。你的脑子就是印钞机，总能发现别人看不到的商机。适合科技、媒体、电商等轻资产行业。你的核心竞争力是“变废为宝”。", 
                w:"**[被动：现金流]**<br>钱对你来说是流动的工具。赚钱快，花钱也快。你的财富在于**“周转”**。建议把赚到的虚钱及时置换成房产、黄金等实物，防止“财来财去一场空”。", 
                l:"**[羁绊：颜控]**<br>你喜欢漂亮、时尚、带出去有面子的伴侣。但你脾气有点急躁，容易忽略对方感受。需要一个能包容你、或者能陪你一起疯的伴侣。", 
                k:"**[传承：自由灵魂]**<br>子女可能早早出国或去外地发展，与你缘分略淡，但你提供的物质支持非常到位。彼此独立，互不干扰。", 
                h:"**[实战锦囊]**<br>思虑过重，容易失眠、脱发、神经衰弱。睡前必须强制自己“关机”。" 
            }, 
            female: { 
                c:"**[天赋：超级带货]**<br>才华横溢，**自媒体、主播、自由撰稿人**。你的表达能力和感染力是核武器。只要你开口，就没有卖不出去的东西。坚持走技术、专才路线。", 
                w:"**[被动：购物狂]**<br>赚钱是你能力的证明，花钱是你解压的方式。必须强制储蓄，或者买保险、信托。做一个快乐的“守财奴”是你晚年幸福的保障。", 
                l:"**[羁绊：挑剔眼光]**<br>眼光毒辣，嫌弃老公穷、笨、没品位。这容易导致婚姻波折。建议找成熟稳重的“大叔型”伴侣，或者晚婚。", 
                k:"**[传承：溺爱]**<br>孩子是你的软肋，也是你奋斗的动力。注意别把孩子宠坏了。", 
                h:"**[实战锦囊]**<br>注意甲状腺、乳腺问题。多去旅游，换个环境能治百病。" 
            } 
        },
        "伤官格": {
            name: "🎭 孤傲艺术家 (Maverick)", tags: ["SR", "创造型", "自由"], icon: "🎭",
            slogan: "“我不是为了迎合世界而生，我是为了改变它。”",
            male: { c:"**[天赋：创新灵魂]**<br>你天生就是规则的破坏者和新世界的创造者。传统的朝九晚五会让你窒息，你适合设计、艺术、演艺、自由职业等需要极强个人色彩的领域。你的才华是你的通行证，但你的傲气也是你的绊脚石。学会适度低头，不是认输，而是为了跳得更高。", w:"**[被动：技能变现]**<br>你不喜求人，也不屑于搞复杂的人际关系。你的财富来自于你的不可替代性。一单吃三年是常态，但也容易三年不开张。建议在收入高峰期强制储蓄，购买固定资产，为你的创作自由提供物质保障。", l:"**[羁绊：不羁之风]**<br>婚姻对你来说是束缚多于甜蜜。晚婚或不婚的概率较高。你需要一个能给你极大自由空间、不干涉你精神世界的伴侣。如果你觉得对方庸俗，这段关系就走到头了。", k:"**[传承：精神代沟]**<br>你与孩子的关系更像是朋友，而不是传统的父子。你更在乎精神层面的交流，可能会忽视生活上的照顾。孩子会觉得你很酷，但也可能会觉得你不够负责。", h:"**[实战锦囊]**<br>情绪化严重，容易抑郁或狂躁。注意心理健康，多冥想。你的身体就像晴雨表，心情不好时身体立刻会出问题。" },
            female: { c:"**[天赋：灵气逼人]**<br>极具艺术天分和审美能力。适合演艺、写作、设计、时尚。受不了枯燥重复的工作，必须做自己喜欢的事才能发光。你的直觉很准，有时候逻辑解释不通的事情，你的直觉能给你答案。", w:"**[被动：随性而富]**<br>开心就赚，不开心就躺。对金钱看得不重，但往往不缺小钱。你的钱大多花在了提升生活品质和个人爱好上。如果不善理财，建议找个靠谱的合伙人或管家。", l:"**[羁绊：克夫之叹]**<br>伤官太旺，对伴侣挑剔、毒舌。你容易看到对方的缺点并无限放大。需要找宽容度极高、性格温和、甚至有点“受虐”倾向的人。或者找年龄差距大的伴侣。", k:"**[传承：生命羁绊]**<br>孩子是你的一切，可能是你在这个世界上唯一的软肋。你会倾尽所有给孩子最好的，但要注意不要产生控制欲。", h:"**[实战锦囊]**<br>气血不通，多运动，释放多余的能量。注意甲状腺和乳腺健康，多做瑜伽疏通经络。" }
        },
        "建禄格": {
            name: "🏰 独立领主 (Independent Lord)", tags: ["SR", "坦克型", "稳健", "自立"], icon: "🗿",
            slogan: "“求人不如求己。我的领土，我说了算。”",
            male: { c:"**[天赋：中流砥柱]**<br>事必躬亲，闲不下来。技术总监、合伙人、区域经理。适合带队冲锋。你很难给别人打工一辈子，迟早要自己单干。你的执行力超强，是那种“说到做到”的实干家。", w:"**[被动：血汗筑基]**<br>你的每一分钱都是汗水换来的，没有侥幸。身旺任财，中晚年大富。但也容易被劫财（朋友借钱不还、合伙人坑钱）。最好的守财方式是把现金变成固定资产。", l:"**[羁绊：大男子主义]**<br>易克妻，因为你太强势了。需找温柔听话、能包容你的老婆。你在家里说一不二，希望对方完全服从你的安排。多听听伴侣的意见，会让家庭更和睦。", k:"**[传承：放养模式]**<br>孩子独立性强，将来可能不在身边发展。你对孩子的教育比较粗放，认为“儿孙自有儿孙福”。", h:"**[实战锦囊]**<br>身体壮如牛，精力旺盛。但容易透支，注意运动过量导致的关节损伤。少熬夜，你的恢复能力虽然强，但也不是无限的。" },
            female: { c:"**[天赋：不靠男人]**<br>比男人还拼的女强人。创业者或企业高管。不喜欢依赖别人，信奉“自己动手丰衣足食”。在职场上，你往往比男同事更有竞争力。", w:"**[被动：漏斗效应]**<br>赚钱猛守财难。容易因为义气或者冲动消费而破财。易被借钱不还。需找人打理财务，或者设定强制储蓄计划。", l:"**[羁绊：强势夺理]**<br>易遇第三者或老公能力弱。太强势让男人有压力，甚至想逃离。学会示弱，不是认输，而是为了经营感情。偶尔撒个娇，会有意想不到的效果。", k:"**[传承：健康基因]**<br>利生育，孩子身体健康，活泼好动，适应能力强。你是个能干的妈妈，但也别忘了给孩子一点温柔的陪伴。", h:"**[实战锦囊]**<br>火气大，容易上火。注意甲状腺和内分泌系统。少吃辛辣刺激食物，多喝水。" }
        },
        "月劫格": {
            name: "⚔️ 豪侠义士 (Rogue)", tags: ["SR", "竞争型", "义气"], icon: "🤜",
            slogan: "“路见不平一声吼。钱财如粪土，仁义值千金。”",
            male: { c:"**[天赋：团队领袖]**<br>善于聚集人气，适合做团队Leader、公会会长、带头大哥。但要防备手下或合伙人背刺。你的成功往往来自于兄弟朋友的帮衬，失败也往往因为被朋友拖累。用人要疑，疑人要用。", w:"**[被动：散财童子]**<br>对朋友大方，存不住钱。最好的存钱方式是买房或交给老婆管。不适合合伙做生意，因为容易因财失义。你的钱就像流沙，握得越紧流得越快。", l:"**[羁绊：克妻争夺]**<br>比劫夺财，感情容易有竞争者。晚婚为宜。你需要一个能包容你“讲义气”的伴侣，或者找一个同样豪爽的女性。避免把朋友看得比老婆重。", k:"**[传承：野蛮生长]**<br>孩子身体好，但不一定听话。教育上要多花心思，防止孩子染上不良习气。多进行户外亲子活动。", h:"**[实战锦囊]**<br>性格冲动，易与人起冲突。注意交通安全和运动伤害。凡事三思而后行，冲动是魔鬼。" },
            female: { c:"**[天赋：女中豪杰]**<br>性格直爽，不让须眉。在职场上敢打敢拼，适合竞争激烈的行业，如销售、保险、竞技体育。你的抗压能力极强，越挫越勇。", w:"**[被动：月光族]**<br>喜欢购物，容易冲动消费。需强制储蓄。你的钱往往花在面子和朋友身上。建议把信用卡注销，只用现金。", l:"**[羁绊：争夫之象]**<br>感情路坎坷，容易遇到渣男或三角恋。要擦亮眼睛，不要被花言巧语蒙蔽。不要太快投入一段感情，多考察对方的人品。", k:"**[传承：独立自强]**<br>带孩子不娇气，培养孩子独立性。你和孩子的关系像朋友，能玩到一块去。", h:"**[实战锦囊]**<br>注意肺部和呼吸系统健康。少抽烟，少生气。多做深呼吸，练习瑜伽调节气息。" }
        },
        "正官格": {
            name: "⚖️ 秩序守护者 (Guardian)", tags: ["SR", "稳健型", "官运"], icon: "🏛️",
            slogan: "“规则是世界的基石。按部就班，才是通往顶峰的捷径。”",
            male: { c:"**[天赋：仕途通达]**<br>天生吃皇粮的命。适合体制内、大厂管理层、公务员。稳重讲规矩，晋升之路虽慢但稳。你是那种领导最放心的人，从不越界，执行力强。", w:"**[被动：正财稳固]**<br>薪水高福利好，旱涝保收。别碰高风险投资（股票、期货），老实拿工资买房收租最适合你。你的财富是随着职级提升而增长的。", l:"**[羁绊：门当户对]**<br>妻子贤惠，家庭观念重。婚姻是你的避风港。你希望找一个能和你举案齐眉、相敬如宾的伴侣。家庭稳定是你事业成功的基础。", k:"**[传承：学霸苗子]**<br>孩子听话懂事，能继承你的优良家风。你对孩子的教育很传统，注重品德和礼貌。孩子在学校通常是班干部。", h:"**[实战锦囊]**<br>压力藏心里，易导致胃病或脱发。学会释放压力，不要太在意别人的看法。偶尔打破一下规则，会让你更轻松。" },
            female: { c:"**[天赋：完美管家]**<br>行政、HR、高管助理、教师。做事井井有条，从不出错，老板最放心。你有很强的组织能力和服务意识，是团队的润滑剂。", w:"**[被动：财政部长]**<br>善于持家，积少成多。家底在你手里越攒越厚。你不乱花钱，但也绝不亏待自己和家人。由于你的规划，家庭抗风险能力很强。", l:"**[羁绊：旺夫体质]**<br>你是丈夫坚强的后盾。婚姻通常令人羡慕。你懂得维护丈夫的面子，也能在关键时刻给出中肯的建议。是标准的贤内助。", k:"**[传承：教子有方]**<br>注重品德培养，孩子有教养懂礼貌。你对孩子的爱是温柔而有原则的。", h:"**[实战锦囊]**<br>注意久坐导致的腰椎、颈椎问题。多做拉伸运动。不要太操心，儿孙自有儿孙福。" }
        },
        "七杀格": {
            name: "🚀 孤胆英雄 (Solo Hero)", tags: ["SSR", "进攻型", "开创"], icon: "🔥",
            slogan: "“要么忍，要么狠，要么滚。人生就是一场无限的战斗。”",
            male: { c:"**[天赋：开疆拓土]**<br>天生的创业者或销售冠军。平淡工作会让你发疯，只有挑战才能激发潜能。你适合去新市场、新领域开荒。你的执行力和魄力无人能及，是乱世中的枭雄。", w:"**[被动：险中求财]**<br>大起大落是常态。敢梭哈，有机会暴富，也容易暴负。赚到钱必须强制买固定资产留后路，防止一夜回到解放前。你的财运是波动向上的。", l:"**[羁绊：烈火情人]**<br>脾气爆，喜欢性感的女性。家里经常上演全武行，但床头吵架床尾和。你的感情生活充满了激情和戏剧性，平淡的日子你反而过不下去。", k:"**[传承：棍棒教育]**<br>对孩子太严厉。多展现温柔一面，孩子其实渴望父爱。不要把工作中的杀伐之气带回家。", h:"**[实战锦囊]**<br>易有外伤疤痕。开车慢点，少喝酒。注意肝胆健康。多做慈善，化解身上的煞气。" },
            female: { c:"**[天赋：不让须眉]**<br>女老板、业务一姐。在男人堆里抢饭吃毫无惧色。执行力超强。你比男人更狠、更决断。适合从事高压、高强度的职业。", w:"**[被动：流水如注]**<br>赚钱机器，花钱如流水。需要懂理财的伙伴帮你打理。你对金钱没有太大的概念，只享受赚钱的快感。", l:"**[羁绊：霸总收割机]**<br>容易吸引霸道总裁或渣男。感情像过山车一样刺激。你喜欢的男人必须比你强，能征服你。但这种男人往往不好驾驭。", k:"**[传承：超人妈妈]**<br>既当爹又当妈，孩子是你坚持下去的最大动力。你会为了孩子变得无比坚强。", h:"**[实战锦囊]**<br>少生气，生气长结节。多做冥想，平复内心的燥气。注意乳腺和甲状腺健康。" }
        },
        "正印格": {
            name: "📜 圣贤导师 (The Sage)", tags: ["SR", "辅助型", "名望"], icon: "🙏",
            slogan: "“但行好事，莫问前程。智慧比财富更持久。”",
            male: { c:"**[天赋：贵人扶持]**<br>适合文教、慈善、出版、咨询。上面有人罩，晋升不用愁。工作清闲福利好。你不需要去勾心斗角，自然会有机会落到你头上。你是团队的精神领袖。", w:"**[被动：清贵之财]**<br>名声换钱。不适合做生意，易心软被骗。靠社会地位获利。你的钱是“躺赚”的，比如房租、版税、分红。", l:"**[羁绊：依赖型]**<br>有点妈宝倾向，喜欢成熟会照顾人的女性。婚姻平顺。你习惯了被照顾，在感情中比较被动。", k:"**[传承：知书达理]**<br>家庭传统氛围浓，孩子孝顺。你对孩子的教育是宽松的，注重品德而非分数。", h:"**[实战锦囊]**<br>心宽体胖，易缺乏运动。注意三高和肥胖问题。多动动，别太懒了。" },
            female: { c:"**[天赋：岁月静好]**<br>老师、图书管理员、公益人士。无野心，不喜竞争。追求安稳舒适。你的心态极好，知足常乐。", w:"**[被动：天生好命]**<br>长辈给的多，老公给的多。一生有人为你买单。你可能不是大富婆，但绝对不缺钱花。", l:"**[羁绊：受宠]**<br>嫁得好，一生被照顾。像温室里的花朵。你的婚姻通常是长辈撮合或门当户对，波折很少。", k:"**[传承：佛系育儿]**<br>顺其自然，孩子性格温和。你不会给孩子太大压力，亲子关系和谐。", h:"**[实战锦囊]**<br>太安逸导致代谢慢。多运动排湿。注意脾胃虚弱，少吃甜食。" }
        },
        "偏印格": {
            name: "👽 异次元行者 (Mystic)", tags: ["SR", "特殊系", "直觉"], icon: "👁️",
            slogan: "“真理往往掌握在少数人手中。我看世界的方式，与你不同。”",
            male: { c:"**[天赋：独门绝技]**<br>医生、程序员、玄学师、侦探。靠偏门冷门技术吃饭。思维独特，能看透本质。你不喜欢热闹，喜欢独自钻研。", w:"**[被动：副业王]**<br>收入不稳定但常有大笔进账。直觉准，靠第六感投资也能赚。你适合做咨询或技术服务。", l:"**[羁绊：冰山]**<br>感情冷淡，不善表达。需要能读懂你沉默的伴侣。你习惯了独处，婚姻对你来说有时是一种负担。", k:"**[传承：代沟]**<br>孩子独立早早离家。教育方式另类。你可能不太会表达爱，但心里是爱孩子的。", h:"**[实战锦囊]**<br>易抑郁，多晒太阳。养宠物陪伴。注意神经衰弱和失眠问题。" },
            female: { c:"**[天赋：洞察力]**<br>设计、咨询、心理医生、占星师。能轻易看穿谎言。适合独立工作。你的灵感来源于孤独。", w:"**[被动：才华变现]**<br>不屑赚辛苦钱。眼光独到，能发现潜力股。你的财富往往来自于你的创意和特殊技能。", l:"**[羁绊：边缘恋]**<br>易遇性格古怪对象或异地恋。感情坎坷，太敏感易受伤。你需要一个能包容你敏感多疑的伴侣。", k:"**[传承：丁克倾向]**<br>觉得孩子是负担，但有了会很爱。你可能更喜欢宠物。", h:"**[实战锦囊]**<br>神经衰弱，偏头痛。睡前泡脚放松。少想那些有的没的，活在当下。" }
        },
        "正财格": {
            name: "🐜 勤勉筑梦师 (Builder)", tags: ["R+", "发育型", "积累"], icon: "🧱",
            slogan: "“一砖一瓦，聚沙成塔。我不信运气，我只信复利。”",
            male: { c:"**[天赋：实干家]**<br>金融、实业、制造。勤劳致富典范，不信一夜暴富。相信努力就有回报。你是老板最喜欢的员工，踏实肯干。", w:"**[被动：复利效应]**<br>典型的富一代。积少成多，晚年富足。每一分钱都是汗水换来的。你不乱花钱，每一笔开支都有计划。", l:"**[羁绊：宠妻狂魔]**<br>工资上交，老婆掌权。觉得听老婆话才会有出息。你对家庭非常负责，是标准的模范丈夫。", k:"**[传承：朴实家风]**<br>子女规矩，继承勤劳家风。你会教导孩子节约和努力。", h:"**[实战锦囊]**<br>过度劳累，职业病。注意休息。别为了省钱而透支身体。" },
            female: { c:"**[天赋：精细化]**<br>会计、银行、数据分析。工作细致，对细节把控无人能及。你适合处理繁琐、需要耐心的工作。", w:"**[被动：存钱罐]**<br>精打细算，看着余额增长最快乐。砍价高手。你是家里的CFO，把每一分钱都花在刀刃上。", l:"**[羁绊：贤惠]**<br>把家打理井井有条。生活略平淡，需制造浪漫。你是那种能把日子过得红红火火的女人。", k:"**[传承：包办]**<br>照顾无微不至，导致孩子自理能力弱。学会放手，让孩子自己成长。", h:"**[实战锦囊]**<br>有点宅，不爱动。多吃红枣枸杞。注意气血不足的问题。" }
        },
        "偏财格": {
            name: "🎩 商业大亨 (Tycoon)", tags: ["SSR", "交际系", "横财"], icon: "💎",
            slogan: "“钱是赚出来的，不是省出来的。朋友多了路好走。”",
            male: { c:"**[天赋：资源整合]**<br>经商、市场、贸易。善交际，四海皆兄弟。眼光独到，发现别人忽略的商机。你适合做生意，不适合坐办公室。", w:"**[被动：横财运]**<br>易中奖或投资获利。但也手松，财来财去。赚了钱马上买房，否则留不住。你的钱是用来生钱的。", l:"**[羁绊：桃花劫]**<br>风趣幽默，出手大方，太讨女人喜欢。需防后院起火。你的感情经历丰富，但真爱难寻。", k:"**[传承：哥们]**<br>跟孩子像朋友。看重情商培养。你会带孩子见世面，培养他的社交能力。", h:"**[实战锦囊]**<br>应酬多，伤肝肾。少喝酒多喝茶。定期体检，注意脂肪肝。" },
            female: { c:"**[天赋：长袖善舞]**<br>商务、公关、销售。名利场游刃有余。赚钱能力不输男人。你懂得如何利用女性优势获取资源。", w:"**[被动：奢靡]**<br>能赚会花，喜欢奢侈品。财运比老公好，经常贴补家用。你喜欢享受生活，觉得赚钱就是为了花。", l:"**[羁绊：择优]**<br>喜欢有钱有势的男人。婚姻晚成，一直在筛选绩优股。你很现实，但也清楚自己想要什么。", k:"**[传承：贵族范]**<br>给孩子最好条件，培养贵族气质。你会送孩子去最好的学校。", h:"**[实战锦囊]**<br>注意富贵病，少吃油腻。多运动，保持身材。" }
        },
        "食神格": {
            name: "🎨 逍遥散人 (Artist)", tags: ["SR", "治愈系", "福气"], icon: "🎐",
            slogan: "“人间不值得，但美食值得。快乐才是人生的终极意义。”",
            male: { c:"**[天赋：灵感源泉]**<br>艺术、餐饮、设计。才华横溢但不爱卷。灵感在玩乐中产生。你适合轻松、自由的工作环境。", w:"**[被动：躺赢]**<br>细水长流，一辈子不缺钱。总有贵人送钱，傻人有傻福。你的财运是“碰”出来的，不是“求”出来的。", l:"**[羁绊：暖男]**<br>懂疼老婆，会做饭。婚姻生活平淡温馨，令人羡慕。你没什么脾气，凡事好商量。", k:"**[传承：福星]**<br>晚年享子女福，孩子性格讨喜。你和孩子的关系非常融洽。", h:"**[实战锦囊]**<br>心宽体胖，贪吃导致三高。动起来！注意控制饮食，多吃蔬菜。" },
            female: { c:"**[天赋：亲和力]**<br>幼师、美食博主、服务业。不争不抢，人缘极好。工作环境单纯。大家都很喜欢和你相处。", w:"**[被动：小确幸]**<br>不计较钱，钱反而来找你。有不少私房钱。你容易满足，幸福感很高。", l:"**[羁绊：仪式感]**<br>有点作，注重浪漫。希望对方懂你的情趣。你需要一个能陪你吃喝玩乐的伴侣。", k:"**[传承：慈母]**<br>孩子是命根子，极其宠爱。孩子幸福感强。你可能会溺爱孩子。", h:"**[实战锦囊]**<br>太懒了，缺乏运动。多去户外走走。注意消化系统健康。" }
        },
        "五行流通": { 
            name: "☯️ 太极宗师 (Grandmaster)", tags: ["SSR", "全能型", "反脆弱"], icon: "🧘",
            slogan: "“刚不可久，柔不可守。万物负阴而抱阳，冲气以为和。”",
            male: { 
                c:"**[天赋：六边形战士]**<br>你没有短板，是天生的**“版本之子”**。职场中的万金油，适合综合管理、统筹、协调。你像水一样适应任何容器。在动荡的经济周期中，别人在裸泳，而你能稳坐钓鱼台。你的生存能力S级，无论环境如何变化，你总能找到自己的位置。", 
                w:"**[被动：稳如泰山]**<br>虽然没有一夜暴富的剧本，但也没有破产的风险。你的财富像滚雪球，抗风险能力极强。你是朋友圈里最“稳”的那个隐形富豪。你的资产配置非常合理，不偏激。", 
                l:"**[羁绊：细水长流]**<br>你的婚姻没有狗血剧，只有温馨的日常。你是最适合过日子的伴侣，能提供极高的情绪价值和安全感。你的伴侣通常也是性格温和、通情达理的人。", 
                k:"**[传承：孝顺]**<br>孩子身心健康，三观正。虽未必惊天动地，但能陪在你身边尽孝，这是最大的福气。你的家庭氛围非常和谐。", 
                h:"**[实战锦囊]**<br>五行流通，百病不生。只要不作死，你大概率能活过99%的同龄人。保持现在的节奏，不要被别人的焦虑影响。" 
            }, 
            female: { 
                c:"**[天赋：以柔克刚]**<br>文员、后勤、体制内。你不求大富大贵，只求工作顺心。你的心态是你最大的财富，让你在任何环境中都能游刃有余。你是那种“不争而争”的智慧女性。", 
                w:"**[被动：无忧]**<br>不缺零花钱，总有父母或丈夫为你提供物质保障。生活滋润，岁月静好。你是天生的“福将”，总能逢凶化吉。", 
                l:"**[羁绊：贤内助]**<br>家庭和睦，你是家里的调味剂。懂得经营生活，把家变得温馨舒适，旺夫旺家。你的丈夫会非常依赖你。", 
                k:"**[传承：陪伴]**<br>花很多时间陪孩子，亲子关系极佳。孩子性格好，情商高。你教会孩子的是如何幸福地生活。", 
                h:"**[实战锦囊]**<br>没啥大毛病，很会照顾自己。懂得以食补身，容颜不老。继续保持这种乐观平和的心态。" 
            } 
        }
    };

    // --- 初始化 ---

    window.onload = function() {
        try {
            const now = new Date();
            const pad = (n) => n < 10 ? '0'+n : n;
            const str = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
            document.getElementById('birth-input').value = str;
        } catch(e) {}
        
        if (typeof Solar === 'undefined') {
            document.getElementById('error-msg').style.display = 'block';
        }
    };

    function setGender(val, el) {
        currentGender = val;
        document.querySelectorAll('.g-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
    }

    // --- 主逻辑 ---
    
    function startScan() {
        const timeStr = document.getElementById('birth-input').value;
        if (!timeStr) return alert("请选择出生时间");

        try {
            const date = new Date(timeStr);
            const solar = Solar.fromYmdHms(date.getFullYear(), date.getMonth()+1, date.getDate(), date.getHours(), date.getMinutes(), date.getSeconds());
            const lunar = solar.getLunar();
            const bazi = lunar.getEightChar();
            bazi.setSect(2); 

            // 1. 数据准备
            const yg = bazi.getYearGan().toString();  const yz = bazi.getYearZhi().toString();
            const mg = bazi.getMonthGan().toString(); const mz = bazi.getMonthZhi().toString();
            const dg = bazi.getDayGan().toString();   const dz = bazi.getDayZhi().toString();
            const hg = bazi.getTimeGan().toString();  const hz = bazi.getTimeZhi().toString();

            const pillars = [
                { t:'年柱 (ROOT)', g:yg, z:yz },
                { t:'月柱 (CAREER)', g:mg, z:mz },
                { t:'日柱 (SELF)', g:dg, z:dz },
                { t:'时柱 (OUTCOME)', g:hg, z:hz }
            ];

            // 2. 渲染
            renderPillars(pillars, dg);
            const cmdInfo = calcCommander(lunar, mz);
            const strengthInfo = analyzeGlobalStrength(cmdInfo, dg, mz, dz, hz);
            
            // 3. 核心：调候与格局
            const climate = analyzeClimate(dg, mz, pillars);
            
            // 4. 绘图
            drawArt(pillars, mz);
            
            // 5. 核心渲染
            renderGamePattern(climate, strengthInfo, pillars, dg, mz, cmdInfo);

            const resArea = document.getElementById('result-area');
            resArea.style.display = 'block';
            resArea.scrollIntoView({ behavior: 'smooth' });

        } catch (e) {
            console.error(e);
            alert("系统过载，请重试！" + e.message);
        }
    }

    function renderPillars(pillars, dayMaster) {
        let html = '';
        pillars.forEach(p => {
            const god = p.t.includes('日柱') ? '日主 (Me)' : (SHISHEN_MAP[dayMaster][p.g] || "");
            const cs = CHANGSHENG_TABLE[p.g][p.z] || "";
            const csClass = STRONG_CS.includes(cs) ? 'cs-strong' : '';
            const gWx = WUXING_MAP[p.g];
            const zWx = WUXING_MAP[p.z];

            html += `
                <div class="col">
                    <div class="c-head">${p.t}</div>
                    <div class="c-god">${god}</div>
                    <div class="c-char ${WX_COLOR[gWx]}">${p.g}</div>
                    <div class="c-char ${WX_COLOR[zWx]}">${p.z}</div>
                    <span class="c-cs ${csClass}">${cs}</span>
                </div>
            `;
        });
        document.getElementById('pillars-box').innerHTML = html;
    }

    function calcCommander(lunar, monthZhi) {
        const prevJie = lunar.getPrevJie();
        const pjSolar = prevJie.getSolar();
        const jieTime = new Date(pjSolar.getYear(), pjSolar.getMonth()-1, pjSolar.getDay(), pjSolar.getHour(), pjSolar.getMinute()).getTime();
        const birthTime = new Date(lunar.getSolar().getYear(), lunar.getSolar().getMonth()-1, lunar.getSolar().getDay(), lunar.getSolar().getHour(), lunar.getSolar().getMinute()).getTime();
        const diffDays = Math.floor((birthTime - jieTime) / (1000 * 60 * 60 * 24));
        
        const rules = SILING_RULES[monthZhi] || [];
        let commander = '未知';
        let daysSum = 0;
        for (let rule of rules) {
            daysSum += rule[1];
            if (diffDays < daysSum) {
                commander = rule[0];
                break;
            }
        }
        if (commander === '未知' && rules.length > 0) commander = rules[rules.length-1][0];
        return { commander, diffDays, prevJieName: prevJie.getName() };
    }

    function analyzeGlobalStrength(info, dm, mZ, dZ, hZ) {
        const dmWx = WUXING_MAP[dm];
        const mZWx = WUXING_MAP[mZ];
        const cmdWx = WUXING_MAP[info.commander];

        const isHelp = (tWx, sWx) => tWx===sWx || (tWx==="木"&&sWx==="火") || (tWx==="火"&&sWx==="土") || (tWx==="土"&&sWx==="金") || (tWx==="金"&&sWx==="水") || (tWx==="水"&&sWx==="木");
        const menWang = isHelp(mZWx, dmWx);
        const diWang = isHelp(cmdWx, dmWx);
        
        const dayCs = CHANGSHENG_TABLE[dm][dZ];
        const dayRootStrong = ["临官", "帝旺", "长生"].includes(dayCs);
        const hourCs = CHANGSHENG_TABLE[dm][hZ];
        const hourRootStrong = ["临官", "帝旺"].includes(hourCs);

        let finalStrong = false;
        let desc = "";

        if (dayRootStrong && hourRootStrong) { finalStrong = true; desc = "日时扎根极深（专禄/归禄），无视月令衰弱，直断身强。"; }
        else if (menWang && diWang) { finalStrong = true; desc = "得令得气，月令提纲有力，身强。"; }
        else if (menWang && !diWang) {
            if (dayRootStrong) { finalStrong = true; desc = "虽真神失令，但得月体且日坐强根，判身强。"; }
            else { finalStrong = false; desc = "门旺地衰，日无强根，外强中干，判身弱。"; }
        } else if (!menWang && diWang) {
            if (dayRootStrong) { finalStrong = true; desc = "虽失月令，但真神相助且日坐强根，绝处逢生，判身强。"; }
            else { finalStrong = false; desc = "虽真神得用，但全局克泄较重，判身弱喜生扶。"; }
        } else {
            if (dayRootStrong && ["冠带","临官"].includes(hourCs)) { finalStrong = true; desc = "虽生于衰月，但日时禄旺通根，判身强。"; }
            else { finalStrong = false; desc = "门地俱衰，根气不足，真身弱。"; }
        }
        return { isStrong: finalStrong, desc, dmWx };
    }

    function analyzeClimate(dm, mz, pillars) {
        const dmWx = WUXING_MAP[dm];
        const season = ["亥","子","丑"].includes(mz) ? "冬" : ["巳","午","未"].includes(mz) ? "夏" : "平";
        let report = { isHot: season === "夏", isCold: season === "冬", hasWater: false, hasFire: false, specialPattern: null };

        pillars.forEach(p => {
            if (WUXING_MAP[p.g] === '水' || WUXING_MAP[p.z] === '水') report.hasWater = true;
            if (WUXING_MAP[p.g] === '火' || WUXING_MAP[p.z] === '火') report.hasFire = true;
        });

        // 天时调候格局判定 (第一优先级)
        if (dmWx === '金' && report.isCold) {
            // 细分：透食神为金水食神，透伤官为金水伤官
            const hasShangGuan = pillars.some(p => SHISHEN_MAP[dm][p.g] === '伤官');
            if (hasShangGuan) report.specialPattern = "金水伤官";
            else report.specialPattern = "金水食神";
        }
        else if (dmWx === '木' && ["寅","卯"].includes(mz) && report.hasFire) {
            report.specialPattern = "木火通明";
        }
        else if (dmWx === '木' && report.isHot && report.hasWater) {
            report.specialPattern = "伤官配印";
        }
        
        return report;
    }

    function drawArt(pillars, mZ) {
        const canvas = document.getElementById('energy-canvas');
        const ctx = canvas.getContext('2d');
        const w = canvas.parentElement.offsetWidth;
        const h = canvas.parentElement.offsetHeight;
        canvas.width = w; canvas.height = h;

        const counts = {'金':0,'木':0,'水':0,'火':0,'土':0};
        pillars.forEach(p => { counts[WUXING_MAP[p.g]]++; counts[WUXING_MAP[p.z]]++; });
        
        ctx.fillStyle = "#1e1e24"; ctx.fillRect(0,0,w,h);
        const colors = {"金":"#ffeaa7", "木":"#55efc4", "水":"#74b9ff", "火":"#ff7675", "土":"#a29bfe"};
        
        const centerX = w/2; const centerY = h/2 + 5; const radius = 55;
        const keys = Object.keys(counts); const total = 8;
        
        ctx.strokeStyle = "#333"; ctx.lineWidth = 1;
        for(let r=1; r<=3; r++) {
            ctx.beginPath();
            for(let i=0; i<5; i++) {
                const angle = (Math.PI*2/5)*i - Math.PI/2;
                const x = centerX + Math.cos(angle)*radius*(r/3);
                const y = centerY + Math.sin(angle)*radius*(r/3);
                if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            }
            ctx.closePath(); ctx.stroke();
        }

        ctx.fillStyle = "rgba(8, 217, 214, 0.3)"; ctx.strokeStyle = "#08d9d6"; ctx.lineWidth = 2;
        ctx.beginPath();
        keys.forEach((k, i) => {
            const val = counts[k];
            const angle = (Math.PI*2/5)*i - Math.PI/2;
            const len = (val / total) * radius * 3.5;
            const x = centerX + Math.cos(angle)*len;
            const y = centerY + Math.sin(angle)*len;
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            
            ctx.fillStyle = colors[k]; ctx.font = "bold 12px Arial";
            const tx = centerX + Math.cos(angle)*(radius+20);
            const ty = centerY + Math.sin(angle)*(radius+10);
            ctx.fillText(k + val, tx-6, ty+4);
        });
        ctx.closePath(); ctx.fill(); ctx.stroke();
    }

    function renderGamePattern(climate, strengthInfo, pillars, dm, mz, cmdInfo) {
        const godMap = {}; 
        const positions = ['年干', '月干', '日干', '时干'];
        const gans = [pillars[0].g, pillars[1].g, pillars[2].g, pillars[3].g];
        gans.forEach((g, i) => { if(i === 2) return; godMap[positions[i]] = SHISHEN_MAP[dm][g]; });

        let key = "";
        let origin = "";

        // 1. 优先采用调候特殊格局
        if (climate.specialPattern) {
            key = climate.specialPattern;
            origin = "[天时调候]";
        } 
        else {
            // 2. 严谨格局判定 (相邻检测)
            const hasSha = Object.values(godMap).includes("七杀");
            if (hasSha) {
                const mGod = godMap['月干']; const yGod = godMap['年干']; const hGod = godMap['时干'];
                let isControlled = false;
                if (mGod === "七杀" && (yGod === "食神" || hGod === "食神")) isControlled = true;
                if (yGod === "七杀" && mGod === "食神") isControlled = true;
                if (hGod === "七杀" && mGod === "食神") isControlled = true;

                if (isControlled) { key = "食神制杀"; origin = "[组合成格]"; }
                else if (Object.values(godMap).includes("伤官")) { key = "伤官合杀"; origin = "[组合成格]"; }
                else { key = "七杀格"; origin = "[十神主导]"; }
            }
            else if (Object.values(godMap).includes("伤官")) {
                const mGod = godMap['月干']; const yGod = godMap['年干']; const hGod = godMap['时干'];
                let isShengCai = false;
                if (mGod === "伤官" && (["正财","偏财"].includes(yGod) || ["正财","偏财"].includes(hGod))) isShengCai = true;
                if (["正财","偏财"].includes(mGod) && (yGod === "伤官" || hGod === "伤官")) isShengCai = true;

                if (isShengCai) { key = "伤官生财"; origin = "[组合成格]"; }
                else { key = "伤官格"; origin = "[十神主导]"; }
            }

            // 3. 透干取格 (正八格逻辑)
            if (!key) {
                const hiddenGans = HIDDEN_GAN_MAP[mz]; 
                const stems = [pillars[0].g, pillars[1].g, pillars[3].g]; 
                
                let patternGan = "";
                for (let gan of hiddenGans) {
                    if (stems.includes(gan)) {
                        patternGan = gan;
                        break;
                    }
                }
                if (!patternGan) patternGan = hiddenGans[0];

                const mainGod = SHISHEN_MAP[dm][patternGan];
                
                const patternMap = {
                    "比肩": "建禄格", "劫财": "月劫格", "食神": "食神格", 
                    "伤官": "伤官格", "正财": "正财格", "偏财": "偏财格", 
                    "正官": "正官格", "七杀": "七杀格", "正印": "正印格", "偏印": "偏印格"
                };
                
                if (patternMap[mainGod]) {
                    key = patternMap[mainGod];
                    origin = `[月令透干: ${patternGan}]`;
                }
            }
        }

        if(!GAME_DB[key]) key = "五行流通";

        const data = GAME_DB[key];
        const genderKey = currentGender === 1 ? 'male' : 'female';
        const detail = data[genderKey];

        document.getElementById('role-icon').innerText = data.icon;
        document.getElementById('role-name').innerText = data.name;
        document.getElementById('role-slogan').innerText = data.slogan;
        
        let tagsHtml = `<span class="tag logic">${origin}</span>`;
        data.tags.forEach(t => tagsHtml += `<span class="tag ${t==='UR'||t==='SSR'?'ssr':''}">${t}</span>`);
        document.getElementById('role-tags').innerHTML = tagsHtml;

        // 修复：补回司令显示逻辑
        const cmdGod = SHISHEN_MAP[dm][cmdInfo.commander];
        if (document.getElementById('siling-text')) {
            document.getElementById('siling-text').innerText = `当令真神：${cmdInfo.commander} (${cmdGod}) · 执政第 ${cmdInfo.diffDays} 天`;
        }

        let xijiData = XIJI_RULES[key];
        if (!xijiData) {
            if (strengthInfo.isStrong) xijiData = { desc: "日主身强，喜克泄耗。", joy:["财星","官杀","食伤"], taboo:["印星","比劫"] };
            else xijiData = { desc: "日主身弱，喜生扶。", joy:["印星","比劫"], taboo:["财星","官杀","食伤"] };
        }

        document.getElementById('pattern-reason').innerText = xijiData.desc;
        
        let joyHtml = "";
        xijiData.joy.forEach(j => joyHtml += `<span style="margin-right:10px;">${j}</span>`);
        document.getElementById('txt-joy').innerHTML = joyHtml;

        let tabooHtml = "";
        xijiData.taboo.forEach(t => tabooHtml += `<span style="margin-right:10px;">${t}</span>`);
        document.getElementById('txt-taboo').innerHTML = tabooHtml;

        const guideHtml = `
            <div class="guide-item">
                <div class="guide-title">⚔️ 事业与成就</div>
                <div class="guide-text">${detail.c}</div>
            </div>
            <div class="guide-item">
                <div class="guide-title">💰 财富与资产</div>
                <div class="guide-text">${detail.w}</div>
            </div>
            <div class="guide-item">
                <div class="guide-title">💞 情感与婚姻</div>
                <div class="guide-text">${detail.l}</div>
            </div>
            <div class="guide-item">
                <div class="guide-title">🌱 后代与传承</div>
                <div class="guide-text">${detail.k}</div>
            </div>
            <div class="guide-item">
                <div class="guide-title">❤️ 健康与状态</div>
                <div class="guide-text">${detail.h}</div>
            </div>
        `;
        document.getElementById('guide-content').innerHTML = guideHtml;
    }

</script>
</body>
</html>
